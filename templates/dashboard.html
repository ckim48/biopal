<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioPal • Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="icon" type="image/png" sizes="32x32" href="../static/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/apple-touch-icon.png">
  <style>
    :root {
      --sky: #0ea5e9; --sky2: #38bdf8; --ink: #0b1220; --bg: #f6fbff;
      --panel: rgba(255, 255, 255, .86); --wire: rgba(2, 6, 23, .08);
      --soft: rgba(14, 165, 233, .08); --muted: #64748b;
      --shadow: 0 12px 34px -18px rgba(2, 6, 23, .22);
      --border: rgba(2, 6, 23, .08);
      --danger: #ef4444;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0; font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, sans-serif;
      background: radial-gradient(900px 520px at 18% 10%, rgba(56, 189, 248, .20), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
      color: var(--ink); -webkit-font-smoothing: antialiased; padding-bottom: 80px; min-height: 100vh;
    }

    /* --- SYNCHRONIZED NAVBAR START --- */
    .nav {
      position: sticky; top: 16px; z-index: 100;
      max-width: 1200px; width: calc(100% - 24px);
      margin: 16px auto;
      background: rgba(255, 255, 255, .70);
      backdrop-filter: blur(18px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 12px 18px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow);
      gap: 12px;
    }
    .nav-left { display: flex; align-items: center; gap: 12px; min-width: 260px; }
    .nav-right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

    .nav-greet {
      display: flex; flex-direction: column;
      line-height: 1.08; padding: 6px 2px; min-width: 200px;
    }
    .nav-greet .hello { font-weight: 950; letter-spacing: -.35px; font-size: 15px; }
    .nav-greet .sub { font-weight: 850; font-size: 13px; color: rgba(100, 116, 139, .95); margin-top: 3px; }

    .btn {
      padding: 12px 18px; border-radius: 14px; border: none;
      font-weight: 800; font-size: 14px; cursor: pointer;
      transition: all .18s ease; display: inline-flex;
      align-items: center; justify-content: center; gap: 8px;
      text-decoration: none;
    }
    .nav-right .btn-ghost {
      background: var(--soft); color: var(--sky);
      border: 1px solid rgba(14,165,233, 0.2); font-weight: 700;
    }
    .nav-right .btn-ghost:hover {
      background: var(--sky); color: white; border-color: var(--sky); transform: translateY(-1px);
    }
    .btn-dark { background: var(--ink); color: white; }

    #logoutBtn {
      background: rgba(239, 68, 68, 0.08); color: var(--bad);
      border: 1px solid rgba(239, 68, 68, 0.15);
    }
    #logoutBtn:hover { background: var(--bad); color: white; border-color: var(--bad); }

    @media (max-width: 768px) {
      .nav { padding: 12px 14px; }
      .nav-left, .nav-greet { min-width: unset; }
    }
    /* --- SYNCHRONIZED NAVBAR END --- */

    .page-container { max-width: 1100px; margin: 22px auto; padding: 0 20px; }

    .grid { display: grid; gap: 20px; grid-template-columns: 1.1fr 0.9fr; margin-top: 20px; }
    .two { display: grid; gap: 20px; grid-template-columns: 1fr 1fr; margin-top: 20px; }
    @media (max-width: 920px) { .grid, .two { grid-template-columns: 1fr; } }

    .card {
      border-radius: 32px; border: 1px solid rgba(14, 165, 233, .16);
      background: var(--panel); backdrop-filter: blur(24px);
      box-shadow: var(--shadow); overflow: hidden; height: 100%;
    }
    .card-hd { padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--wire); gap: 10px; }
    .card-hd h3 { margin: 0; font-weight: 800; font-size: 15px; display: flex; align-items: center; gap: 10px; }
    .card-bd { padding: 24px; position: relative; }

    .pill { font-size: 11px; font-weight: 800; padding: 6px 12px; border-radius: 99px; background: var(--soft); color: var(--sky); }
    .pill-neutral { background: rgba(148,163,184,.12); color: #334155; }
    .pill-ok { background: rgba(16,185,129,.12); color: #047857; }
    .pill-warn { background: rgba(245,158,11,.14); color: #92400e; }
    .pill-danger { background: rgba(239,68,68,.12); color: #991b1b; }

    .profileRow { display: flex; gap: 16px; align-items: center; margin-bottom: 24px; }
    .avatar { width: 64px; height: 64px; border-radius: 22px; background: linear-gradient(135deg, var(--sky), var(--sky2)); display: grid; place-items: center; color: white; font-size: 24px; }
    .name { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; margin: 0; }
    .meta { margin: 2px 0 0; font-size: 13px; color: var(--muted); font-weight: 600; }

    .kpiRow { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .kpi { padding: 16px; border-radius: 20px; background: rgba(14, 165, 233, 0.04); border: 1px solid rgba(14, 165, 233, 0.08); }
    .kpi .label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .kpi .val { font-size: 24px; font-weight: 900; line-height: 1; }

    .chartWrap { height: 270px; position: relative; display: flex; align-items: center; justify-content: center; }
    .no-data-msg { color: var(--muted); font-weight: 700; font-size: 14px; text-align: center; }

    .chartDesc{
      margin: 10px 0 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      line-height: 1.35;
    }

    .loading { display: flex; align-items: center; gap: 12px; padding: 20px; font-weight: 700; color: var(--sky); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--sky); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

    .rangeTabs{
      display: flex; gap: 8px; flex-wrap: wrap;
      padding: 8px;
      background: rgba(2,6,23,.02);
      border: 1px solid rgba(2,6,23,.06);
      border-radius: 18px;
    }
    .rangeTab{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(2,6,23,.10);
      background: rgba(255,255,255,.65);
      font-weight: 900;
      font-size: 12px;
      color: var(--ink);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: .16s ease;
      user-select: none;
    }
    .rangeTab:hover{ transform: translateY(-1px); }
    .rangeTab.active{
      background: rgba(11,18,32,1);
      color: #fff;
      border-color: rgba(11,18,32,1);
    }

    /* --- CLEAN TEXT-ONLY REPORT STYLES (NO ICONS/EMOJI) --- */
    .report-card-kid {
      border: 2px solid #e0f2fe;
      background: linear-gradient(180deg, #ffffff 0%, #f0f9ff 100%);
    }
    .report-hero-header {
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      border-radius: 24px; padding: 32px; color: white;
      margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 10px 20px -10px rgba(14, 165, 233, 0.5);
    }
    .kid-score-circle {
      width: 80px; height: 80px; background: white; border-radius: 50%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--sky); border: 4px solid rgba(255,255,255,0.3);
    }

    .reportGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 920px){ .reportGrid { grid-template-columns: 1fr; } }

    .kid-block {
      border: 1px solid rgba(2,6,23,.08);
      border-radius: 24px !important;
      padding: 24px !important;
      background: #ffffff !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.02);
      transition: transform 0.2s ease;
    }
    .kid-block:hover { transform: translateY(-2px); }

    .bg-summary { border-top: 4px solid #7dd3fc !important; }
    .bg-wins { border-top: 4px solid #86efac !important; }
    .bg-tips { border-top: 4px solid #fcd34d !important; }
    .bg-plan { border-top: 4px solid #d8b4fe !important; }

    .kid-list { list-style: none; padding: 0; margin: 0; }
    .kid-list li {
      padding: 12px 16px; margin-bottom: 8px;
      background: #f8fafc; border-radius: 12px;
      font-size: 14px; font-weight: 700;
      color: #0f172a;
      line-height: 1.4;
    }

    .reportText-kid {
      margin: 0; color: #0f172a; font-weight: 700; font-size: 15px; line-height: 1.6;
    }

    .skeletonLine {
      height: 12px; border-radius: 999px;
      background: linear-gradient(90deg, rgba(2,6,23,.05), rgba(2,6,23,.10), rgba(2,6,23,.05));
      background-size: 200% 100%; animation: shimmer 1.2s infinite linear; margin: 10px 0;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .errorBubble{
      margin-top: 10px; border: 1px solid rgba(239,68,68,.20);
      background: rgba(239,68,68,.06); color: #7f1d1d;
      border-radius: 16px; padding: 10px 12px; font-weight: 800; font-size: 12px; display: none;
    }
    .dividerSoft { height: 1px; background: var(--wire); margin: 14px 0; }
    .mutedSmall { color: var(--muted); font-weight: 700; font-size: 12px; }
  </style>
</head>

<body>
  <nav class="nav">
  <div class="nav-left">
    <div class="nav-greet" id="navGreeting" aria-label="Greeting">
      <div class="hello" id="helloLine">Hi, there</div>
      <div class="sub" id="greetSub">Weekly Missions</div>
    </div>
  </div>

  <div class="nav-right" style="display: flex; align-items: center; gap: 8px;">
    <a href="/dashboard" class="btn btn-ghost" id="refreshBtn">
      <i class="bi bi-grid-fill"></i> Dashboard
    </a>

    <a href="/chatbot" class="btn btn-ghost">
      <i class="bi bi-chat-dots-fill"></i> Chatbot
    </a>

    <a href="/resource" class="btn btn-ghost">
      <i class="bi bi-journal-text"></i> Resources
    </a>

    <a href="{{ url_for('main') }}" class="btn btn-ghost">
      <i class="bi bi-hearts"></i> BioPal App
    </a>

    <div class="dropdown">
      <button
        class="btn btn-ghost settings-btn"
        type="button"
        id="settingsMenuBtn"
        data-bs-toggle="dropdown"
        aria-expanded="false"
        aria-label="Settings menu"
        title="Settings"
        style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; padding: 0; border-radius: 12px;"
      >
        <i class="bi bi-gear-fill" style="font-size: 1.1rem;"></i>
      </button>

      <ul class="dropdown-menu dropdown-menu-end menu" aria-labelledby="settingsMenuBtn"
          style="min-width:240px; border-radius:18px; border:1px solid rgba(2,6,23,.10); box-shadow:var(--shadow-xl); overflow:hidden; margin-top: 10px;">

        <li class="dropdown-header"
            style="font-weight:950; letter-spacing:-.2px; padding:12px 14px; color:var(--ink);
                   background:rgba(248,250,252,.95); border-bottom:1px solid rgba(2,6,23,.08);">
          Account
        </li>

        <li>
          <a class="dropdown-item" href="/profile"
             style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
            <i class="bi bi-person-circle" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
            Profile
          </a>
        </li>

        <li id="menuLoginItem" style="display:none;">
          <a class="dropdown-item" href="/login"
             style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
            <i class="bi bi-box-arrow-in-right" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
            Login
          </a>
        </li>

        <li><hr class="dropdown-divider" style="margin:0; border-top-color:rgba(2,6,23,.08);"></li>

        <li id="menuLogoutItem">
          <button class="dropdown-item danger" id="logoutBtn"
                  style="padding:10px 14px; font-weight:900; display:flex; align-items:center; gap:10px;
                         color:var(--bad); background:transparent; border:0; width:100%; text-align:left;">
            <i class="bi bi-box-arrow-right" style="width:22px; font-size:1.05rem; color:var(--bad);"></i>
            Logout
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <div class="page-container">
    <div class="grid">
      <div class="card">
        <div class="card-hd">
          <h3><i class="bi bi-person-circle"></i> Health Overview</h3>
          <span class="pill" id="todayPill">...</span>
        </div>
        <div class="card-bd">
          <div id="loadingBox" class="loading"><span class="dot"></span> Syncing...</div>
          <div id="profileBox" style="display:none;">
            <div class="profileRow">
              <div class="avatar"><i class="bi bi-person-fill"></i></div>
              <div>
                <p class="name" id="profName"></p>
                <p class="meta" id="profMeta"></p>
              </div>
            </div>

            <div class="rangeTabs" role="tablist" aria-label="Range selector">
              <button class="rangeTab active" data-range="today"><i class="bi bi-sun"></i> Today</button>
              <button class="rangeTab" data-range="7d"><i class="bi bi-calendar-week"></i> 7 days</button>
              <button class="rangeTab" data-range="30d"><i class="bi bi-calendar3"></i> 30 days</button>
            </div>

            <div class="dividerSoft"></div>

            <div class="kpiRow">
              <div class="kpi"><div class="label">Tasks</div><div class="val" id="kpiTotal">0</div></div>
              <div class="kpi"><div class="label">Completed</div><div class="val" id="kpiDone">0</div></div>
              <div class="kpi"><div class="label">Success</div><div class="val" id="kpiRate">0%</div></div>
            </div>

            <div class="dividerSoft"></div>
            <div class="mutedSmall" id="dataHint">Using mission history to build your charts.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-hd"><h3><i class="bi bi-pie-chart-fill"></i> Overall Progress</h3></div>
        <div class="card-bd">
          <div class="chartWrap" id="wrapStatus"><canvas id="chartStatus"></canvas></div>
          <p class="chartDesc" id="descStatus">Shows how many tasks were completed vs still pending or missed during the selected range.</p>
        </div>
      </div>
    </div>

    <div class="two">
      <div class="card">
        <div class="card-hd"><h3><i class="bi bi-grid-1x2-fill"></i> Distribution</h3></div>
        <div class="card-bd">
          <div class="chartWrap" id="wrapType"><canvas id="chartType"></canvas></div>
          <p class="chartDesc" id="descType">Completed tasks grouped by type (Hydration, Medication, Dressing, Custom) for the selected range.</p>
        </div>
      </div>

      <div class="card">
        <div class="card-hd"><h3><i class="bi bi-graph-up-arrow"></i> Trend</h3></div>
        <div class="card-bd">
          <div class="chartWrap" id="wrapTrend"><canvas id="chartTrend"></canvas></div>
          <p class="chartDesc" id="descTrend">Daily count of completed tasks.</p>
        </div>
      </div>
    </div>

    <div class="card report-card-kid" style="margin-top: 20px;">
      <div class="card-hd">
        <h3 style="font-weight: 900;">Mission Debrief</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="pill pill-neutral" id="reportPill">Not generated</span>
          <button class="btn btn-ghost" id="genReportBtn">Generate</button>
        </div>
      </div>
      <div class="card-bd">
        <div id="reportLoading" style="display:none; text-align: center; padding: 40px;">
          <div class="spinner-grow text-info" role="status"></div>
          <p class="mt-3 fw-bold text-muted">Analyzing adventure logs...</p>
        </div>

        <div id="reportError" class="errorBubble"></div>

        <div id="reportEmpty" class="no-data-msg" style="padding: 40px 0;">
          <p class="mt-3">Ready for your summary? Click Generate to see your superhero progress.</p>
        </div>

        <div id="reportBox" style="display:none;">
          <div class="report-hero-header">
            <div>
              <h4 class="m-0 fw-black" style="letter-spacing: -0.5px; font-size: 24px;">Today's Summary</h4>
              <div style="margin-top: 8px;">
                <small id="reportStamp" style="opacity: 0.9; font-weight: 700;"></small>
              </div>
            </div>
            <div class="d-flex align-items:center gap-4">
              <div class="kid-score-circle">
                <span class="fw-black fs-3" id="reportScore">--</span>
                <span style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8;">Energy</span>
              </div>
              <button class="btn btn-light btn-sm" id="regenReportBtn" style="border-radius: 12px; padding: 8px 16px;">Regenerate</button>
            </div>
          </div>

          <div class="reportGrid">
            <div class="reportBlock kid-block bg-summary">
              <h4 style="font-size: 13px; font-weight: 900; text-transform: uppercase; margin-bottom: 12px; color: var(--sky);">Daily Narrative</h4>
              <p class="reportText-kid" id="reportSummary"></p>
              <div class="dividerSoft"></div>
              <div class="mutedSmall" id="reportFootnote"></div>
            </div>

            <div class="reportBlock kid-block bg-wins">
              <h4 style="font-size: 13px; font-weight: 900; text-transform: uppercase; margin-bottom: 12px; color: var(--ok);">Accomplishments</h4>
              <ul class="kid-list" id="reportHighlights"></ul>
            </div>

            <div class="reportBlock kid-block bg-tips" style="grid-column: 1 / -1;">
              <h4 style="font-size: 13px; font-weight: 900; text-transform: uppercase; margin-bottom: 16px; color: var(--warn);">Focus Areas</h4>
              <div class="row g-4">
                <div class="col-md-6">
                  <p class="mutedSmall mb-2 text-uppercase">Recommended Actions</p>
                  <ul class="kid-list" id="reportRecs"></ul>
                </div>
                <div class="col-md-6 border-start">
                  <p class="mutedSmall mb-2 text-uppercase">Items to Monitor</p>
                  <ul class="kid-list" id="reportConcerns"></ul>
                </div>
              </div>
            </div>

            <div class="reportBlock kid-block bg-plan" style="grid-column: 1 / -1;">
              <h4 style="font-size: 13px; font-weight: 900; text-transform: uppercase; margin-bottom: 12px; color: #8b5cf6;">Next Week's Map</h4>
              <ul class="kid-list" id="reportPlan"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { db, auth } from "../static/js/firebase/config.js";
    import {
      doc, getDoc, collection, getDocs, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const $ = (id) => document.getElementById(id);
    let charts = {};
    const chartColors = { sky: '#0ea5e9', danger: '#ef4444', muted: '#94a3b8' };

    Chart.defaults.font.family = "Plus Jakarta Sans";
    Chart.defaults.font.weight = "700";

    // ✅ SAME AS CHATBOT PAGE: navbar greeting helper
    function setNavName(nameLike){
      const raw = String(nameLike || "there").trim();
      const clean = raw.includes("@") ? raw.split("@")[0] : raw;
      if ($("helloLine")) $("helloLine").textContent = `Hi, ${clean || "there"}`;
      if ($("greetSub")) $("greetSub").textContent = "Welcome back";
    }

    function showNoData(containerId) {
      const el = $(containerId);
      if (el) el.innerHTML = '<div class="no-data-msg">No data recorded yet</div>';
    }

    function riskPillClass(risk) {
      if (risk === "Low Risk") return "pill pill-ok";
      if (risk === "Needs Attention") return "pill pill-danger";
      return "pill pill-warn";
    }

    function setReportPill(state, risk="") {
      const el = $("reportPill");
      if (!el) return;
      if (state === "loading") { el.className = "pill pill-neutral"; el.textContent = "Generating..."; return; }
      if (state === "ready") { el.className = riskPillClass(risk); el.textContent = risk || "Ready"; return; }
      el.className = "pill pill-neutral"; el.textContent = "Not generated";
    }

    function safeList(arr, emptyText="No data available") {
      if (!Array.isArray(arr) || !arr.length) return `<li>${emptyText}</li>`;
      return arr.map(x => `<li>${String(x)}</li>`).join("");
    }

    function showReportError(msg){
      const el = $("reportError");
      if (el) {
        el.textContent = msg;
        el.style.display = "block";
      }
    }
    function hideReportError(){
      const el = $("reportError");
      if (el) {
        el.textContent = "";
        el.style.display = "none";
      }
    }

    function toDateSafe(v) {
      try {
        if (!v) return null;
        if (v instanceof Date) return v;
        if (typeof v === "string") { const d = new Date(v); return isNaN(d.getTime()) ? null : d; }
        if (typeof v === "number") { const d = new Date(v); return isNaN(d.getTime()) ? null : d; }
        if (typeof v === "object") {
          if (typeof v.toDate === "function") return v.toDate();
          if (typeof v.seconds === "number") return new Date(v.seconds * 1000);
        }
        return null;
      } catch { return null; }
    }

    function buildMockMissions() {
      const now = new Date();
      const mk = (daysAgo, title, status, type) => {
        const d = new Date(now);
        d.setDate(d.getDate() - daysAgo);
        d.setHours(Math.max(8, 18 - daysAgo), 0, 0, 0);
        return { title, status, type, dt: d };
      };

      return [
        mk(0, "Drink water (500ml)", "completed", "hydration"),
        mk(0, "Take medication (AM)", "pending", "medication"),
        mk(0, "Dressing check", "completed", "dressing"),
        mk(1, "Custom: short walk", "completed", "custom"),
        mk(2, "Drink water (500ml)", "completed", "hydration"),
        mk(3, "Take medication (PM)", "missed", "medication"),
        mk(4, "Dressing check", "completed", "dressing"),
        mk(5, "Custom: stretch", "completed", "custom"),
        mk(6, "Drink water (500ml)", "completed", "hydration"),
      ];
    }

    async function fetchMissions(uid) {
      const col = collection(db, "users", uid, "missions");
      try {
        const q1 = query(col, orderBy("createdAt", "desc"), limit(200));
        const snap1 = await getDocs(q1);
        return snap1.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch {}
      try {
        const q2 = query(col, limit(200));
        const snap2 = await getDocs(q2);
        return snap2.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch {
        return null;
      }
    }

    async function tryFetchLast7Checkins(uid) {
      try {
        const col = collection(db, "users", uid, "checkins");
        const q = query(col, orderBy("createdAt", "desc"), limit(7));
        const snap = await getDocs(q);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch {
        return [];
      }
    }

    function normalizeProfileForReport(uData) {
      const p = (uData && typeof uData === "object") ? uData : {};
      const prof = (p.profile && typeof p.profile === "object") ? p.profile : p;
      return {
        gender: prof.gender,
        weight: prof.weight,
        height: prof.height,
        treatmentPhase: prof.treatmentPhase,
        activityBaseline: prof.activityBaseline,
        medicalConditions: prof.medicalConditions,
        allergies: prof.allergies,
        schedule: prof.schedule
      };
    }

    function buildHistoryForReport(checkins, missions) {
      const byDay = {};
      for (const m of missions) {
        const day = m.dt.toISOString().split("T")[0];
        if (!byDay[day]) byDay[day] = { date: day, missions_total: 0, missions_done: 0, types_done: { hydration:0, medication:0, dressing:0, custom:0 } };
        byDay[day].missions_total += 1;
        if (m.status.includes("complete")) {
          byDay[day].missions_done += 1;
          byDay[day].types_done[m.type] = (byDay[day].types_done[m.type] || 0) + 1;
        }
      }

      const normCheckins = (checkins || []).map(c => {
        let d = "";
        if (c.date && typeof c.date === "string") d = c.date;
        else if (c.day && typeof c.day === "string") d = c.day;
        else if (c.createdAt?.toDate) d = c.createdAt.toDate().toISOString().split("T")[0];
        else if (c.timestamp?.toDate) d = c.timestamp.toDate().toISOString().split("T")[0];
        return { ...c, _dateKey: d };
      });

      const days = Object.keys(byDay).sort().slice(-7);
      return days.map(day => {
        const chk = normCheckins.find(x => x._dateKey === day) || null;
        return {
          date: day,
          checkin: chk ? (chk.survey_v2 ? { survey_v2: chk.survey_v2 } : chk) : null,
          missions: byDay[day]
        };
      });
    }

    async function generateDailyReport(profile, history7) {
      hideReportError();
      if ($("reportEmpty")) $("reportEmpty").style.display = "none";
      if ($("reportBox")) $("reportBox").style.display = "none";
      if ($("reportLoading")) $("reportLoading").style.display = "block";
      setReportPill("loading");

      try {
        const res = await fetch("/api/condition_report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ profile, history: history7, nowISO: new Date().toISOString() })
        });

        let obj = null;
        try { obj = await res.json(); } catch { obj = null; }

        if (!res.ok || !obj || typeof obj !== "object") {
          if ($("reportLoading")) $("reportLoading").style.display = "none";
          if ($("reportEmpty")) $("reportEmpty").style.display = "block";
          setReportPill("idle");
          showReportError("Daily report is unavailable right now. Please try again.");
          return;
        }

        if ($("reportScore")) $("reportScore").textContent = (obj.score ?? "--");
        if ($("reportSummary")) $("reportSummary").textContent = obj.summary || "No summary available.";
        if ($("reportHighlights")) $("reportHighlights").innerHTML = safeList(obj.highlights);
        if ($("reportConcerns")) $("reportConcerns").innerHTML = safeList(obj.concerns);
        if ($("reportRecs")) $("reportRecs").innerHTML = safeList(obj.recommendations);
        if ($("reportPlan")) $("reportPlan").innerHTML = safeList(obj.next_7_days_plan);

        const stamp = new Date().toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
        if ($("reportStamp")) $("reportStamp").textContent = "Log for " + stamp;
        if ($("reportFootnote")) $("reportFootnote").textContent = "Note: Focus on hydration for a higher energy score tomorrow.";

        if ($("reportLoading")) $("reportLoading").style.display = "none";
        if ($("reportBox")) $("reportBox").style.display = "block";
        setReportPill("ready", obj.risk_level);

      } catch (err) {
        if ($("reportLoading")) $("reportLoading").style.display = "none";
        if ($("reportBox")) $("reportBox").style.display = "none";
        if ($("reportEmpty")) $("reportEmpty").style.display = "block";
        setReportPill("idle");
        showReportError("Daily report failed to generate. Please try again.");
      }
    }

    function startOfDay(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }

    function inRange(dt, range) {
      const now = new Date();
      const d0 = startOfDay(now);
      if (range === "today") return startOfDay(dt).getTime() === d0.getTime();
      const days = (range === "7d") ? 7 : 30;
      const start = new Date(d0);
      start.setDate(start.getDate() - (days - 1));
      return dt >= start && dt <= now;
    }

    function buildStatsForRange(allMissions, range) {
      const mR = allMissions.filter(m => inRange(m.dt, range));
      const total = mR.length;
      const done = mR.filter(m => m.status.includes("complete")).length;

      const statusAll = {
        completed: done,
        pending: mR.filter(m => m.status === "pending").length,
        missed: mR.filter(m => m.status === "missed").length
      };

      const typeDone = {
        hydration: mR.filter(m => m.type === "hydration" && m.status.includes("complete")).length,
        medication: mR.filter(m => m.type === "medication" && m.status.includes("complete")).length,
        dressing:  mR.filter(m => m.type === "dressing"  && m.status.includes("complete")).length,
        custom:    mR.filter(m => m.type === "custom"    && m.status.includes("complete")).length
      };

      const daysCount = (range === "today") ? 1 : (range === "7d" ? 7 : 30);
      const labels = [];
      const values = [];
      for (let i = daysCount - 1; i >= 0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        labels.push(
          (daysCount === 30)
            ? d.toLocaleDateString([], { month: "short", day: "numeric" })
            : d.toLocaleDateString([], { weekday: "short" })
        );
        values.push(
          mR.filter(x => x.dt.toDateString() === d.toDateString() && x.status.includes("complete")).length
        );
      }

      return { range, total, done, statusAll, typeDone, trend: { labels, values } };
    }

    function renderCharts(stats) {
      Object.values(charts).forEach(c => c?.destroy?.());

      const statusCtx = $("chartStatus");
      if (statusCtx && (stats.statusAll.completed + stats.statusAll.pending + stats.statusAll.missed > 0)) {
        charts.status = new Chart(statusCtx, {
          type: "doughnut",
          data: {
            labels: ["Done", "Pending", "Missed"],
            datasets: [{
              data: [stats.statusAll.completed, stats.statusAll.pending, stats.statusAll.missed],
              backgroundColor: [chartColors.sky, "#e2e8f0", chartColors.danger],
              borderWidth: 0
            }]
          },
          options: {
            cutout: "75%",
            plugins: {
              legend: { position: "bottom", labels: { usePointStyle: true } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed}` } }
            }
          }
        });
      } else { showNoData("wrapStatus"); }

      const typeCtx = $("chartType");
      if (typeCtx && stats.total > 0) {
        charts.type = new Chart(typeCtx, {
          type: "bar",
          data: {
            labels: ["Hydration", "Medication", "Dressing", "Custom"],
            datasets: [{
              label: "Completed tasks",
              data: [stats.typeDone.hydration, stats.typeDone.medication, stats.typeDone.dressing, stats.typeDone.custom],
              backgroundColor: chartColors.sky,
              borderRadius: 8
            }]
          },
          options: {
            scales: {
              x: { grid: { display: false }, title: { display: true, text: "Mission type" } },
              y: { beginAtZero: true, grid: { color: "#f1f5f9" }, ticks: { precision: 0 }, title: { display: true, text: "Completed count" } }
            },
            plugins: { legend: { display: false } }
          }
        });
      } else { showNoData("wrapType"); }

      const trendCtx = $("chartTrend");
      if (trendCtx) {
        charts.trend = new Chart(trendCtx, {
          type: "line",
          data: {
            labels: stats.trend.labels,
            datasets: [{
              label: "Completed tasks",
              data: stats.trend.values,
              borderColor: chartColors.sky,
              tension: 0.35,
              borderWidth: 3,
              pointBackgroundColor: chartColors.sky,
              fill: false
            }]
          },
          options: {
            scales: {
              x: { grid: { display: false }, title: { display: true, text: (stats.range === "today" ? "Today" : "Day") } },
              y: { beginAtZero: true, grid: { color: "#f1f5f9" }, ticks: { precision: 0 }, title: { display: true, text: "Completed count" } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    function setActiveRange(range) {
      document.querySelectorAll(".rangeTab").forEach(btn => btn.classList.toggle("active", btn.dataset.range === range));

      const allMissions = window.__allMissions || [];
      const stats = buildStatsForRange(allMissions, range);

      if ($("kpiTotal")) $("kpiTotal").textContent = stats.total;
      if ($("kpiDone")) $("kpiDone").textContent = stats.done;
      if ($("kpiRate")) $("kpiRate").textContent = (stats.total ? Math.round((stats.done / stats.total) * 100) : 0) + "%";

      const label = (range === "today") ? "Today" : (range === "7d" ? "Last 7 days" : "Last 30 days");
      if ($("dataHint")) $("dataHint").textContent = `Showing ${label} (from mission history).`;

      if ($("descStatus")) $("descStatus").textContent = `Completed vs pending/missed tasks for ${label}.`;
      if ($("descType")) $("descType").textContent = `Completed tasks by mission type for ${label}.`;
      if ($("descTrend")) $("descTrend").textContent = `Daily completed tasks for ${label}. `;

      renderCharts(stats);
    }

    async function loadDashboard() {
      const user = auth.currentUser;
      if (!user) return;

      if ($("loadingBox")) $("loadingBox").style.display = "flex";
      if ($("profileBox")) $("profileBox").style.display = "none";

      // ✅ quick greeting immediately (same behavior as chatbot)
      setNavName(user.displayName || user.email || "there");

      let uData = {};
      try {
        const uSnap = await getDoc(doc(db, "users", user.uid));
        uData = uSnap.data() || {};
      } catch (err) {}

      // ✅ final greeting from Firestore profile (username preferred)
      const bestName = uData.username || uData.displayName || uData.name || user.displayName || user.email || "there";
      setNavName(bestName);

      // Profile box values (keep your existing behavior)
      const shownName = String(bestName || "there");
      if ($("profName")) $("profName").textContent = shownName;
      if ($("profMeta")) $("profMeta").textContent = user.email || "";
      if ($("todayPill")) $("todayPill").textContent = new Date().toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});

      const raw = await fetchMissions(user.uid);
      let missions = [];

      if (Array.isArray(raw)) {
        missions = raw.map(r => {
          const tRaw = String(r.type || "custom").toLowerCase();
          const status = String(r.status || "pending").toLowerCase();
          const type = (tRaw === "hydration" || tRaw === "medication" || tRaw === "dressing") ? tRaw : "custom";

          const dt =
            toDateSafe(r.createdAt) ||
            toDateSafe(r.dt) ||
            toDateSafe(r.date) ||
            new Date();

          return { title: r.title || "Task", status, type, dt };
        });
      }

      if (!missions.length) missions = buildMockMissions();

      missions.sort((a,b) => b.dt.getTime() - a.dt.getTime());
      window.__allMissions = missions;

      const profileForReport = normalizeProfileForReport(uData);
      const checkins7 = await tryFetchLast7Checkins(user.uid);
      const history7 = buildHistoryForReport(checkins7, missions);
      window.__reportPayload = { profileForReport, history7 };

      setActiveRange("today");

      if ($("loadingBox")) $("loadingBox").style.display = "none";
      if ($("profileBox")) $("profileBox").style.display = "block";
    }

    // Fixed refresh mechanism
    if ($("refreshBtn")) $("refreshBtn").onclick = (e) => {
      e.preventDefault();
      loadDashboard();
    };

    if ($("genReportBtn")) $("genReportBtn").onclick = async () => {
      const p = window.__reportPayload?.profileForReport || {};
      const h = window.__reportPayload?.history7 || [];
      await generateDailyReport(p, h);
    };

    if ($("regenReportBtn")) $("regenReportBtn").onclick = async () => {
      const p = window.__reportPayload?.profileForReport || {};
      const h = window.__reportPayload?.history7 || [];
      await generateDailyReport(p, h);
    };

    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".rangeTab");
      if (!btn) return;
      setActiveRange(btn.dataset.range);
    });

    if ($("logoutBtn")) $("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.href = "/login";
    };

    onAuthStateChanged(auth, u => u ? loadDashboard() : location.href = "/login");
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
