<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioPal • Weekly Missions</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/apple-touch-icon.png">

  <style>
    :root{
      --primary:#6366f1;
      --primary-hover:#4f46e5;

      --sky:#0ea5e9; --sky2:#38bdf8; --ink:#0b1220; --bg:#f6fbff;
      --panel: rgba(255,255,255,.86);
      --wire: rgba(2,6,23,.08);
      --soft: rgba(14,165,233,.08);
      --muted:#64748b;

      --card:#ffffff;
      --text-main:#0f172a;
      --text-muted:#64748b;
      --border: rgba(2,6,23,.08);

      --radius-lg:24px;
      --radius-md:16px;

      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow: 0 12px 34px -18px rgba(2,6,23,.22);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
    }

    *{ box-sizing:border-box; outline:none; }

    body{
      margin:0;
      font-family:"Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,sans-serif;
      background: radial-gradient(900px 520px at 18% 10%, rgba(56,189,248,.20), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 80px;
      min-height: 100vh;
      overflow-x:hidden;
    }

    .nav{
      position: sticky; top: 16px; z-index: 100;
      max-width: 1200px; width: calc(100% - 24px);
      margin: 16px auto;
      background: rgba(255, 255, 255, .70);
      backdrop-filter: blur(18px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 12px 18px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow);
      gap: 12px;
    }
    .nav-left{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .nav-right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .nav-greet{
      display:flex; flex-direction:column;
      line-height:1.08; padding:6px 2px; min-width:200px;
    }
    .nav-greet .hello{ font-weight:950; letter-spacing:-.35px; font-size:15px; }
    .nav-greet .sub{ font-weight:850; font-size:13px; color: rgba(100,116,139,.95); margin-top:3px; }

    .btn{
      padding:12px 18px; border-radius:14px; border:none;
      font-weight:800; font-size:14px; cursor:pointer;
      transition: all .18s ease; display:inline-flex;
      align-items:center; justify-content:center; gap:8px;
      text-decoration:none;
    }
    .nav-right .btn-ghost{
      background: var(--soft); color: var(--sky);
      border: 1px solid rgba(14,165,233, 0.2); font-weight: 700;
    }
    .nav-right .btn-ghost:hover{
      background: var(--sky); color:#fff; border-color: var(--sky);
      transform: translateY(-1px);
    }
    .btn-dark{ background: var(--ink); color:#fff; }

    #logoutBtn{
      background: rgba(239, 68, 68, 0.08); color: var(--bad);
      border: 1px solid rgba(239, 68, 68, 0.15);
    }
    #logoutBtn:hover{ background: var(--bad); color:#fff; border-color: var(--bad); }

    @media (max-width:768px){
      .nav{ padding:12px 14px; }
      .nav-left, .nav-greet{ min-width: unset; }
    }

    .page-container{
      max-width: 1100px;
      margin: 22px auto;
      padding: 0 20px;
    }

    .bento-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .bento-main{
      grid-column: span 2;
      background: var(--panel);
      border-radius: 32px;
      padding: 2rem;
      border: 1px solid rgba(14,165,233,.16);
      box-shadow: var(--shadow);
      backdrop-filter: blur(24px);
    }
    .bento-side{
      display:flex;
      flex-direction:column;
      gap: 1rem;
    }
    .stat-card{
      background: var(--panel);
      border-radius: 24px;
      padding: 1.25rem;
      border: 1px solid rgba(2,6,23,.08);
      display:flex;
      align-items:center;
      gap: 1rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(24px);
    }
    .stat-icon{
      width: 48px; height: 48px;
      border-radius: 16px;
      background: rgba(14,165,233,.08);
      display:flex; align-items:center; justify-content:center;
      font-size: 1.2rem;
      color: var(--sky);
      flex:0 0 auto;
      border: 1px solid rgba(14,165,233,.14);
    }

    .mission-header-v2{
      border-radius: 32px;
      padding: 2.2rem;
      margin: 18px 0 2.2rem;
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(900px 420px at 12% 18%, rgba(56,189,248,.35), transparent 60%),
        linear-gradient(135deg, rgba(14,165,233,.95), rgba(99,102,241,.92));
      color: white;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.18);
    }
    .mission-header-v2::after{
      content:"";
      position:absolute;
      inset:-60% -40% auto auto;
      width:420px; height:420px;
      background: rgba(255,255,255,.32);
      filter: blur(120px);
      opacity: .55;
      pointer-events:none;
      transform: rotate(12deg);
    }
    .mission-title{
      font-weight: 950;
      letter-spacing: -0.8px;
      margin: 0 0 6px;
      font-size: clamp(26px, 2.4vw, 38px);
      text-shadow: 0 10px 30px rgba(2,6,23,.22);
    }
    .mission-sub{
      margin:0;
      font-weight: 750;
      opacity: .92;
    }

    .progress-wrapper{
      background: rgba(255,255,255,0.26);
      height: 12px;
      border-radius: 99px;
      margin-top: 1.25rem;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.22);
    }
    #overallBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
      border-radius: 99px;
      transition: width 1s cubic-bezier(0.4,0,0.2,1);
    }

    .track-section{ margin-bottom: 3.2rem; }
    .track-title-v2{
      font-weight: 950;
      font-size: 1.35rem;
      letter-spacing: -0.02em;
      margin-bottom: .35rem;
      display:flex;
      align-items:center;
      gap:.75rem;
      color: var(--ink);
    }

    /* --- scrolling (no overlap) --- */
    .scroll-shell{
      display:grid;
      grid-template-columns: 46px 1fr 46px;
      gap: 10px;
      align-items: stretch;
    }

    .scroll-container{
      display:flex;
      gap: 1rem;
      overflow-x:auto;
      padding: .75rem 0 1.6rem 0;
      scroll-behavior:smooth;
      scrollbar-width:none;
      scroll-snap-type:x mandatory;
      min-width: 0;
    }
    .scroll-container::-webkit-scrollbar{ display:none; }

    .scroll-btn{
      position: sticky;
      top: 0;
      align-self: center;
      width: 46px;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(2,6,23,.10);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow-sm);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--ink);
      cursor:pointer;
      transition:.2s;
      z-index: 2;
    }
    .scroll-btn:hover{ box-shadow: var(--shadow); transform: scale(1.03); }
    .scroll-btn:active{ transform: scale(.98); }
    .scroll-btn[disabled]{ opacity:.45; cursor:default; box-shadow: var(--shadow-sm); transform:none; }

    .scroll-btn.left{ justify-self: start; }
    .scroll-btn.right{ justify-self: end; }

    @media (max-width:768px){
      .scroll-shell{ grid-template-columns: 1fr; }
      .scroll-btn{ display:none; }
    }

    .mcard-v2{
      flex: 0 0 260px;
      background: rgba(255,255,255,.88);
      border-radius: 22px;
      padding: 14px 14px 14px 14px;
      border: 1px solid rgba(2,6,23,.08);
      transition: all .22s ease;
      position: relative;
      display:flex;
      flex-direction:column;
      box-shadow: var(--shadow);
      scroll-snap-align:start;
      backdrop-filter: blur(18px);
      min-height: 170px;
    }
    .mcard-v2:hover:not(.locked){
      transform: translateY(-6px);
      box-shadow: 0 18px 50px -26px rgba(2,6,23,.35);
      border-color: rgba(14,165,233,.35);
    }
    .mcard-v2.done{
      border-color: rgba(16,185,129,.40);
      background: linear-gradient(180deg, rgba(240,253,244,.95) 0%, rgba(255,255,255,.92) 100%);
    }
    .mcard-v2.locked{
      opacity:.58;
      background: rgba(248,250,252,.85);
      filter: grayscale(1);
    }

    .badge-v2{
      font-size: .68rem;
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: .06em;
      padding: 4px 8px;
      border-radius: 8px;
      width: fit-content;
      margin-bottom: 10px;
    }

    .card-action{
      position:absolute;
      top: 12px;
      right: 12px;
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(2,6,23,.10);
      background: rgba(255,255,255,.92);
      display:grid;
      place-items:center;
      color: var(--ink);
      box-shadow: var(--shadow-sm);
      transition: .18s ease;
      cursor:pointer;
    }
    .card-action:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .card-action:active{ transform: translateY(0px) scale(.98); }
    .card-action[disabled]{ opacity:.45; cursor:default; transform:none; box-shadow: var(--shadow-sm); }

    .card-action.open{
      border-color: rgba(14,165,233,.22);
      background: rgba(14,165,233,.10);
      color: var(--sky);
    }
    .card-action.done{
      border-color: rgba(16,185,129,.25);
      background: rgba(16,185,129,.12);
      color: #047857;
    }

    .reset-link{
      color: var(--muted);
      font-size: .875rem;
      text-decoration:none;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .reset-link:hover{ color: var(--bad); }

    #toastx{
      position:fixed;
      bottom:30px;
      left:50%;
      transform:translateX(-50%);
      background: #0f172a;
      color:#fff;
      padding: 12px 22px;
      border-radius: 999px;
      font-weight: 800;
      z-index: 9999;
      opacity:0;
      transition:.3s;
      box-shadow: var(--shadow);
      pointer-events:none;
    }
    #toastx.show{ opacity:1; bottom:50px; }

    @media (max-width: 992px){
      .bento-grid{ grid-template-columns: 1fr; }
      .bento-main{ grid-column: span 1; }
    }
  </style>
</head>

<body>

  <nav class="nav">
    <div class="nav-left">
      <div class="nav-greet" id="navGreeting" aria-label="Greeting">
        <div class="hello" id="helloLine">Hi, there</div>
        <div class="sub" id="greetSub">Weekly Missions</div>
      </div>
    </div>

    <div class="nav-right" style="display: flex; align-items: center; gap: 8px;">
      <a href="/dashboard" class="btn btn-ghost" id="refreshBtn">
        <i class="bi bi-grid-fill"></i> Dashboard
      </a>

      <a href="/chatbot" class="btn btn-ghost">
        <i class="bi bi-chat-dots-fill"></i> Chatbot
      </a>

      <a href="/resource" class="btn btn-ghost">
        <i class="bi bi-journal-text"></i> Resources
      </a>

      <a href="{{ url_for('main') }}" class="btn btn-ghost">
        <i class="bi bi-hearts"></i> BioPal App
      </a>

      <div class="dropdown">
        <button
          class="btn btn-ghost settings-btn"
          type="button"
          id="settingsMenuBtn"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          aria-label="Settings menu"
          title="Settings"
          style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; padding: 0; border-radius: 12px;"
        >
          <i class="bi bi-gear-fill" style="font-size: 1.1rem;"></i>
        </button>

        <ul class="dropdown-menu dropdown-menu-end menu" aria-labelledby="settingsMenuBtn"
            style="min-width:240px; border-radius:18px; border:1px solid rgba(2,6,23,.10); box-shadow:var(--shadow-xl); overflow:hidden; margin-top: 10px;">

          <li class="dropdown-header"
              style="font-weight:950; letter-spacing:-.2px; padding:12px 14px; color:var(--ink);
                     background:rgba(248,250,252,.95); border-bottom:1px solid rgba(2,6,23,.08);">
            Account
          </li>

          <li>
            <a class="dropdown-item" href="/profile"
               style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
              <i class="bi bi-person-circle" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
              Profile
            </a>
          </li>

          <li id="menuLoginItem" style="display:none;">
            <a class="dropdown-item" href="/login"
               style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
              <i class="bi bi-box-arrow-in-right" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
              Login
            </a>
          </li>

          <li><hr class="dropdown-divider" style="margin:0; border-top-color:rgba(2,6,23,.08);"></li>

          <li id="menuLogoutItem">
            <button class="dropdown-item danger" id="logoutBtn"
                    style="padding:10px 14px; font-weight:900; display:flex; align-items:center; gap:10px;
                           color:var(--bad); background:transparent; border:0; width:100%; text-align:left;">
              <i class="bi bi-box-arrow-right" style="width:22px; font-size:1.05rem; color:var(--bad);"></i>
              Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="page-container">

    <div class="bento-grid">
      <div class="bento-main">
        <div class="d-flex justify-content-between align-items-start mb-4">
          <h4 class="fw-black mb-0" style="letter-spacing:-.35px;">Weekly Analysis</h4>
          <span class="badge rounded-pill px-3 py-2" id="reportBadge"
                style="background:rgba(14,165,233,.10); color: var(--sky); border:1px solid rgba(14,165,233,.18); font-weight:900;">
            AI Insights
          </span>
        </div>
        <p class="lead fs-6 text-secondary mb-4" id="suggestionParagraph">Analyzing your health patterns...</p>
        <ul class="list-unstyled mb-4" id="suggestionBullets" style="display:none"></ul>
        <div class="p-3 bg-light rounded-3 small text-muted border-start border-4 border-info" id="suggestionDisclaimer" style="display:none"></div>
      </div>

      <div class="bento-side">
        <div class="stat-card">
          <div class="stat-icon"><i class="bi bi-calendar3"></i></div>
          <div>
            <div class="small fw-black text-uppercase" style="color: rgba(100,116,139,.95);">Timeline</div>
            <div class="fw-black" id="weekValue">—</div>
            <div class="small text-muted fw-semibold mt-1">Reset on every Mon. 9:00 AM</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i class="bi bi-compass"></i></div>
          <div>
            <div class="small fw-black text-uppercase" style="color: rgba(100,116,139,.95);">Current Focus</div>
            <div class="fw-black" id="focusValue">—</div>
          </div>
        </div>

        <div class="stat-card d-none">
          <div class="stat-icon"><i class="bi bi-cloud-check"></i></div>
          <div>
            <div class="small fw-black text-uppercase" style="color: rgba(100,116,139,.95);">Cloud Status</div>
            <div class="fw-black text-success" id="saveValue">Synced</div>
            <div class="small fw-semibold" id="saveHint" style="margin-top:2px; color: rgba(100,116,139,.95);">Loaded</div>
          </div>
        </div>
      </div>
    </div>

    <div class="mission-header-v2">
      <div class="row align-items-center position-relative" style="z-index:1;">
        <div class="col-md-8">
          <h2 class="mission-title">Weekly Missions</h2>
          <p class="mission-sub">Level up your habits. Complete current tasks to unlock advanced challenges.</p>
        </div>
        <div class="col-md-4 text-md-end mt-4 mt-md-0">
          <div class="h1 fw-black mb-0" id="overallPct" style="letter-spacing:-.8px;">0%</div>
          <div class="small fw-black" id="overallText" style="opacity:.95;">0/0 Tasks Done</div>
        </div>
      </div>
      <div class="progress-wrapper position-relative" style="z-index:1;">
        <div id="overallBar"></div>
      </div>
    </div>

    <div id="rows"></div>
  </div>

  <div id="toastx">Action Successful</div>

  <script type="module">
    import { db, auth } from "/static/js/firebase/config.js";
    import {
      doc, getDoc, setDoc, deleteDoc,
      collection, query, limit, getDocs, orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let USER_ID = null;
    let WEEK_KEY = null;
    let categories = [];
    let progress = {}; // { diet:Set([1..]), ... }

    const $ = (id) => document.getElementById(id);

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    function setNavName(nameLike){
      const raw = String(nameLike || "there").trim();
      const clean = raw.includes("@") ? raw.split("@")[0] : raw;
      if ($("helloLine")) $("helloLine").textContent = `Hi, ${clean || "there"}`;
      if ($("greetSub")) $("greetSub").textContent = "Weekly Missions";
    }

    function toast(msg){
      const el = $("toastx");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove("show"), 2200);
    }

    // -----------------------------
    // ✅ Week reset boundary: Monday 09:00 (LOCAL TIME)
    // -----------------------------
    function ymd(d){
      const dt = new Date(d);
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
    }

    function getWeekStartMonday9(d = new Date()){
      // Monday 09:00 is the boundary
      const now = new Date(d);

      // Build today's 09:00
      const boundaryToday = new Date(now);
      boundaryToday.setHours(9,0,0,0);

      // If before 09:00 today, treat as "previous day" for boundary calc
      const anchor = new Date(now);
      if (now < boundaryToday) anchor.setDate(anchor.getDate() - 1);

      // Compute Monday of that week
      // JS getDay(): Sun=0..Sat=6. Convert to Mon=0..Sun=6
      const dowMon0 = (anchor.getDay() + 6) % 7;
      const monday = new Date(anchor);
      monday.setDate(anchor.getDate() - dowMon0);
      monday.setHours(9,0,0,0);
      return monday;
    }

    function weekKeyMonday9(d = new Date()){
      return ymd(getWeekStartMonday9(d));
    }

    function weekPeriodLabelFromKey(weekKey){
      // DATE ONLY (no time)
      const [Y,M,D] = String(weekKey).split("-").map(Number);
      const start = new Date(Y, M-1, D, 9, 0, 0, 0);
      const end = new Date(start);
      end.setDate(end.getDate() + 6);
      return `${ymd(start)} – ${ymd(end)}`;
    }

    function storageKey(){ return `biopal_v3_prog_${USER_ID}_${WEEK_KEY}`; }

    function normalizeOut(){
      const out = {};
      categories.forEach(c => { out[c.category] = Array.from(progress[c.category] || []); });
      return out;
    }

    function loadProgressFromLocal(){
      const obj = JSON.parse(localStorage.getItem(storageKey()) || "{}");
      categories.forEach(c => {
        progress[c.category] = new Set((obj[c.category] || []).filter(n => Number.isInteger(n) && n>=1 && n<=7));
      });
    }

    function saveProgressToLocal(){
      localStorage.setItem(storageKey(), JSON.stringify(normalizeOut()));
    }

    function weeklyDocRef(){
      return doc(db, "users", USER_ID, "weekly_missions", WEEK_KEY);
    }

    async function loadProgressFromFirestore(){
      const snap = await getDoc(weeklyDocRef());
      if(!snap.exists()) return false;
      const d = snap.data() || {};
      const p = d.progress || {};
      categories.forEach(c => {
        progress[c.category] = new Set((p[c.category] || []).filter(n => Number.isInteger(n) && n>=1 && n<=7));
      });
      return true;
    }

    async function saveProgressToFirestore(){
      await setDoc(weeklyDocRef(), {
        weekKey: WEEK_KEY,
        progress: normalizeOut(),
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function resetProgressFirestore(){
      await deleteDoc(weeklyDocRef());
    }

    function getStatus(cat, lvl){
      if (progress[cat]?.has(lvl)) return "done";
      if (lvl === 1 || progress[cat]?.has(lvl - 1)) return "open";
      return "locked";
    }

    function sortMissions(missions){
      const order = ["diet", "exercise", "sleep", "mindset"];
      return [...missions].sort((a,b) => order.indexOf(a.category) - order.indexOf(b.category));
    }

    function pickPrimaryFocus(missions){
      const order = ["diet", "exercise", "sleep", "mindset"];
      const counts = {};
      (missions || []).forEach(m => { counts[m.category] = (counts[m.category] || 0) + (m.cards?.length || 0); });
      let best = null, bestScore = -1;
      order.forEach(k => {
        const s = counts[k] || 0;
        if(s > bestScore){ bestScore = s; best = k; }
      });
      return best || missions?.[0]?.category || "—";
    }

    function renderGuidance(report){
      const p = $("suggestionParagraph");
      const ul = $("suggestionBullets");
      const callout = $("suggestionDisclaimer");

      ul.style.display = "none";
      ul.innerHTML = "";
      callout.style.display = "none";
      callout.textContent = "";

      if(!report){
        p.textContent = "No report yet. Add a check-in to generate weekly guidance.";
        $("reportBadge").textContent = "Not enough data";
        return;
      }

      p.textContent = report.personalized_note || "Your weekly plan is ready.";
      $("reportBadge").textContent = "AI Insights";

      const bullets = Array.isArray(report.bullets) ? report.bullets : [];
      if(bullets.length){
        ul.innerHTML = bullets
          .map(x => `<li class="mb-2"><span style="color:var(--sky); font-weight:900; margin-right:8px;">•</span>${esc(x)}</li>`)
          .join("");
        ul.style.display = "";
      }

      if(report.disclaimer){
        callout.textContent = report.disclaimer;
        callout.style.display = "";
      }
    }

    function updateOverall(){
      let total = 0, done = 0;
      categories.forEach(c => {
        total += c.cards.length;
        done += progress[c.category]?.size || 0;
      });
      const pct = total ? Math.round((done/total)*100) : 0;
      $("overallPct").textContent = pct + "%";
      $("overallText").textContent = `${done}/${total} Tasks Done`;
      $("overallBar").style.width = pct + "%";
    }

    // --- scrolling helpers ---
    function scrollByStep(trackKey, dir){
      const sc = document.getElementById("scroll_" + trackKey);
      if(!sc) return;
      const step = Math.max(260, Math.floor(sc.clientWidth * 0.85));
      sc.scrollBy({ left: dir * step, behavior: "smooth" });
      setTimeout(() => syncScrollButtons(trackKey), 180);
    }

    function syncScrollButtons(trackKey){
      const sc = document.getElementById("scroll_" + trackKey);
      const left = document.getElementById("left_" + trackKey);
      const right = document.getElementById("right_" + trackKey);
      if(!sc || !left || !right) return;

      const max = sc.scrollWidth - sc.clientWidth;
      const x = sc.scrollLeft;

      left.disabled = x <= 2;
      right.disabled = x >= max - 2;
    }

    function wireAllScrollers(){
      categories.forEach(c => {
        const key = c.category;
        const sc = document.getElementById("scroll_" + key);
        if(!sc) return;
        sc.addEventListener("scroll", () => {
          window.requestAnimationFrame(() => syncScrollButtons(key));
        }, { passive:true });
        syncScrollButtons(key);
      });
    }

    function scrollToNextOpen(cat, justCompletedLevel){
      const sc = document.getElementById("scroll_" + cat);
      if(!sc) return;

      const nextLevel = justCompletedLevel + 1;

      const preferred = sc.querySelector(
        `.mcard-v2.open[data-cat="${CSS.escape(cat)}"][data-level="${nextLevel}"]`
      );

      const fallback = sc.querySelector(
        `.mcard-v2.open[data-cat="${CSS.escape(cat)}"]`
      );

      const target = preferred || fallback;
      if(!target) return;

      target.scrollIntoView({ behavior: "smooth", inline: "start", block: "nearest" });
      setTimeout(() => syncScrollButtons(cat), 200);
    }

    function renderRows(){
      const container = $("rows");

      container.innerHTML = categories.map(cat => {
        const done = progress[cat.category]?.size || 0;
        const pct = Math.round((done / cat.cards.length) * 100);

        return `
          <div class="track-section" id="track_${esc(cat.category)}">
            <div class="d-flex justify-content-between align-items-end mb-3 flex-wrap gap-2">
              <div>
                <h3 class="track-title-v2">
                  <i class="bi ${esc(cat.icon)}" style="color:var(--sky)"></i>
                  ${esc(cat.title)}
                </h3>
                <span class="text-muted small fw-black"><strong>${done}/${cat.cards.length}</strong> Levels Completed • ${pct}%</span>
              </div>
              <a class="reset-link" onclick="window.resetTrack('${cat.category}')">
                <i class="bi bi-arrow-counterclockwise"></i> Reset Track
              </a>
            </div>

            <div class="scroll-shell">
              <button class="scroll-btn left" id="left_${esc(cat.category)}" type="button"
                aria-label="Scroll left" onclick="window.scrollTrack('${cat.category}', -1)">
                <i class="bi bi-chevron-left"></i>
              </button>

              <div class="scroll-container" id="scroll_${esc(cat.category)}">
                ${cat.cards.map(card => {
                  const status = getStatus(cat.category, card.level);

                  let badgeClass = "bg-secondary-subtle text-secondary";
                  let badgeText = "Locked";
                  if(status === "done"){ badgeClass = "bg-success-subtle text-success"; badgeText = "Completed"; }
                  if(status === "open"){ badgeClass = "bg-primary-subtle text-primary"; badgeText = "Current Step"; }

                  const actionDisabled = (status !== "open") ? "disabled" : "";
                  const actionCls = status === "open" ? "open" : (status === "done" ? "done" : "");

                  return `
                    <div class="mcard-v2 ${status}" data-cat="${esc(cat.category)}" data-level="${card.level}">
                      <button class="card-action ${actionCls}" ${actionDisabled}
                        title="${status === "open" ? "Mark as complete" : (status === "done" ? "Completed" : "Locked")}"
                        aria-label="Mark as complete"
                        onclick="window.completeLvl('${cat.category}', ${card.level})">
                        <i class="bi ${status === "done" ? "bi-check2" : "bi-check2-circle"}"></i>
                      </button>

                      <div class="badge-v2 ${badgeClass}">${badgeText}</div>
                      <div class="small text-muted fw-black mb-1">Level ${card.level}</div>
                      <h6 class="fw-black mb-2" style="letter-spacing:-.2px;">${esc(card.name)}</h6>
                      <p class="small text-muted mb-0" style="line-height:1.35;">${esc(card.desc || "")}</p>
                    </div>
                  `;
                }).join("")}
              </div>

              <button class="scroll-btn right" id="right_${esc(cat.category)}" type="button"
                aria-label="Scroll right" onclick="window.scrollTrack('${cat.category}', 1)">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        `;
      }).join("");

      updateOverall();
      wireAllScrollers();
    }

    window.scrollTrack = (cat, dir) => scrollByStep(cat, dir);

    window.completeLvl = async (cat, lvl) => {
      const status = getStatus(cat, lvl);
      if(status !== "open"){
        toast("This step is locked.");
        return;
      }

      progress[cat].add(lvl);
      saveProgressToLocal();
      renderRows();

      requestAnimationFrame(() => {
        requestAnimationFrame(() => scrollToNextOpen(cat, lvl));
      });

      toast("Progress Saved!");

      try{
        await saveProgressToFirestore();
        $("saveValue").textContent = "Synced";
        $("saveValue").classList.add("text-success");
        $("saveHint").textContent = "Saved to cloud.";
      }catch(e){
        console.error(e);
        $("saveValue").textContent = "Local only";
        $("saveValue").classList.remove("text-success");
        $("saveHint").textContent = "Cloud save failed (saved on this device).";
        toast("Saved locally (cloud failed).");
      }
    };

    window.resetTrack = async (cat) => {
      if(!confirm("Reset this track for this week?")) return;

      progress[cat] = new Set();
      saveProgressToLocal();
      renderRows();

      toast("Track reset.");

      try{
        await saveProgressToFirestore();
        $("saveValue").textContent = "Synced";
        $("saveValue").classList.add("text-success");
        $("saveHint").textContent = "Saved to cloud.";
      }catch(e){
        console.error(e);
        $("saveValue").textContent = "Local only";
        $("saveValue").classList.remove("text-success");
        $("saveHint").textContent = "Cloud reset failed (local reset ok).";
        toast("Reset locally (cloud failed).");
      }
    };

    if ($("refreshBtn")) $("refreshBtn").onclick = (e) => {
      e.preventDefault();
      if (USER_ID) toast("Refreshing...");
      location.reload();
    };

    if ($("logoutBtn")) $("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.href = "/login";
    };

    onAuthStateChanged(auth, async (user) => {
      if(!user) { location.href = "/login"; return; }

      setNavName(user.displayName || user.email || "there");

      USER_ID = user.uid;
      WEEK_KEY = weekKeyMonday9(new Date()); // ✅ Monday 09:00 reset key
      $("weekValue").textContent = weekPeriodLabelFromKey(WEEK_KEY); // ✅ date only

      try {
        const userSnap = await getDoc(doc(db, "users", user.uid));
        const profile = userSnap.data() || {};

        const bestName = profile.username || profile.displayName || profile.name || user.displayName || user.email || "there";
        setNavName(bestName);

        const logsRef = collection(db, "users", user.uid, "daily_logs");
        const q = query(logsRef, orderBy("updatedAt", "desc"), limit(7));
        const snap = await getDocs(q);
        const history = snap.docs.map(d => d.data());

        const res = await fetch("/api/generate_ai_missions", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ profile, history })
        });

        const data = await res.json();
        categories = Array.isArray(data.missions) ? sortMissions(data.missions) : [];

        renderGuidance(data.report);

        const focus = pickPrimaryFocus(categories);
        const focusMap = { diet:"Diet", exercise:"Exercise", sleep:"Sleep", mindset:"Mindset" };
        $("focusValue").textContent = focusMap[focus] || String(focus || "—");

        categories.forEach(c => { progress[c.category] = new Set(); });

        let loadedCloud = false;
        try{
          loadedCloud = await loadProgressFromFirestore();
        }catch(e){
          console.warn("cloud load failed", e);
        }

        if(!loadedCloud){
          loadProgressFromLocal();
          $("saveValue").textContent = "Local only";
          $("saveValue").classList.remove("text-success");
          $("saveHint").textContent = "No cloud record yet (using device cache).";
        }else{
          saveProgressToLocal();
          $("saveValue").textContent = "Synced";
          $("saveValue").classList.add("text-success");
          $("saveHint").textContent = "Loaded from cloud.";
        }

        renderRows();

      } catch(e) {
        console.error(e);
        $("suggestionParagraph").textContent = "Could not load weekly analysis. Please try again.";
        $("reportBadge").textContent = "Error";
        $("saveValue").textContent = "—";
        $("saveHint").textContent = "—";
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
