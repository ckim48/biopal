<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioPal • Create Account</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/apple-touch-icon.png">

  <style>
    :root{
      --primary:#0070f3;
      --ink:#020617;
      --muted:#64748b;
      --bg:#f8faff;
      --glass:rgba(255,255,255,.95);
      --border:rgba(15,23,42,.08);
      --error:#ef4444;
      --ok:#10b981;
      --panel:#ffffff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
      font-family:'Plus Jakarta Sans',sans-serif;
      background:linear-gradient(-45deg,#f0f9ff,#e0f2fe,#f0fdf4);
      padding:20px;
    }

    .card{
      width:100%;max-width:620px;background:var(--glass);backdrop-filter:blur(20px);
      border-radius:32px;border:1px solid var(--border);
      box-shadow:0 25px 50px -12px rgba(0,0,0,.05);
      padding:40px;
      position:relative;
    }

    .steps-container{display:flex;justify-content:space-between;margin-bottom:32px;position:relative}
    .step-dot{
      width:36px;height:36px;border-radius:12px;background:#f1f5f9;
      display:grid;place-items:center;font-size:14px;font-weight:800;
      color:var(--muted);transition:all .3s ease;z-index:2;
    }
    .step-dot.active{background:var(--primary);color:#fff;transform:scale(1.08)}
    .step-dot.completed{background:var(--ok);color:#fff}
    .steps-container::after{
      content:"";position:absolute;top:18px;left:0;width:100%;height:2px;background:#f1f5f9;z-index:1
    }

    h1{font-size:28px;font-weight:800;margin:0 0 8px;letter-spacing:-1px}
    .subtitle{color:var(--muted);font-size:15px;margin-bottom:24px;font-weight:500}

    .step-content{display:none;animation:slideUp .4s ease}
    .step-content.active{display:block}
    @keyframes slideUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}

    .field{margin-bottom:18px}
    label{
      display:block;font-size:12px;font-weight:700;margin-bottom:6px;color:var(--ink);
      text-transform:uppercase;letter-spacing:.5px
    }
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);
      background:#fbfcfe;font-size:15px;transition:all .2s;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(0,112,243,.1);
      outline:none;
    }

    .btn-group{display:flex;gap:12px;margin-top:32px}
    .btn{
      flex:1;padding:16px;border:none;border-radius:16px;font-weight:800;font-size:16px;
      cursor:pointer;transition:all .2s;
    }
    .btn-next{background:var(--ink);color:#fff}
    .btn-prev{background:#f1f5f9;color:var(--muted)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .info-box{
      font-size:12px;color:var(--muted);background:#f8fafc;padding:14px;border-radius:14px;
      border:1px solid var(--border);margin:0 0 14px;line-height:1.5;
    }

    .section{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:18px;
      padding:14px;
      margin-top:12px;
    }
    .section h3{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
    }

    .hidden{display:none !important}

    .modal-overlay{
      position:fixed;inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal-overlay.show{display:flex}
    .modal-card{
      width:100%;max-width:520px;
      background:rgba(255,255,255,.98);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 30px 70px rgba(2,6,23,.18);
      padding:18px;
    }
    .modal-head{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin-bottom:8px;
    }
    .modal-title{
      font-weight:900;letter-spacing:-.6px;font-size:16px;color:var(--ink);
      margin:0;
    }
    .modal-close{
      border:none;background:#f1f5f9;color:var(--muted);
      border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;
    }
    .modal-body{
      color:var(--muted);font-size:13px;line-height:1.55;margin:8px 0 12px;
    }
    .modal-actions{display:flex;gap:10px;margin-top:10px}
    .modal-actions .btn{
      padding:12px 14px;border-radius:14px;font-size:14px;
    }
    .btn-ack{background:var(--ink);color:#fff}
    .btn-secondary{background:#f1f5f9;color:var(--muted)}
  </style>
</head>

<body>
  <!-- Teen guidance modal -->
  <div class="modal-overlay" id="teenModal" role="dialog" aria-modal="true" aria-labelledby="teenTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 class="modal-title" id="teenTitle">A quick note for teens</h3>
        <button type="button" class="modal-close" id="teenCloseBtn" aria-label="Close">Close</button>
      </div>
      <div class="modal-body">
        It looks like you may be under 20. Please complete this registration with a parent or guardian, and make sure the information you enter is accurate.
        If you’re unsure about any medical details, you can leave optional fields blank and update later.
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ack" id="teenOkBtn">I Understand</button>
        <button type="button" class="btn btn-secondary" id="teenBackBtn">Go Back</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="steps-container">
      <div class="step-dot active" id="dot-1">1</div>
      <div class="step-dot" id="dot-2">2</div>
      <div class="step-dot" id="dot-3">3</div>
      <div class="step-dot" id="dot-4">4</div>
      <div class="step-dot" id="dot-5">5</div>
    </div>

    <h1 id="step-title">Create Account</h1>
    <p class="subtitle" id="step-subtitle">Step 1 of 5: Sign in securely.</p>

    <form id="registerForm" novalidate>
      <!-- STEP 1 -->
      <div class="step-content active" id="step-1">
        <div class="info-box">
          Create your login details. You’ll confirm health and schedule information in the next steps.
        </div>

        <div class="field">
          <label>Email Address</label>
          <input type="email" id="email" placeholder="name@example.com" required>
        </div>

        <div class="field">
          <label>Password</label>
          <input type="password" id="password" placeholder="Min. 6 chars" required minlength="6">
        </div>

        <div class="field">
          <label>Confirm Password</label>
          <input type="password" id="confirmPassword" placeholder="Repeat" required minlength="6">
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="step-content" id="step-2">
        <div class="info-box">
          Share clinical basics so BioPal can tailor reminders and insights to your care context.
        </div>

        <div class="section">
          <h3>Body Basics</h3>

          <div class="field">
            <label>Birth Year</label>
            <input type="number" id="birthYear" placeholder="YYYY" min="1920" max="2026" required>
          </div>

          <div class="field">
            <label>Gender</label>
            <select id="sex" required>
              <option value="" disabled selected>Select</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="not_prefer">Prefer not to say</option>
            </select>
          </div>

          <div class="field">
            <label>Height (cm)</label>
            <input type="number" id="height" placeholder="cm" step="0.1" required>
          </div>

          <div class="field">
            <label>Current Weight (kg)</label>
            <input type="number" id="weight" placeholder="kg" step="0.1" required>
          </div>
        </div>

        <div class="section">
          <h3>Diagnosis Context</h3>

          <div class="field">
            <label>Do you currently have a cancer diagnosis?</label>
            <select id="hasCancer" required>
              <option value="" disabled selected>Select</option>
              <option value="yes">Yes</option>
              <option value="no">No / Not diagnosed</option>
            </select>
          </div>

          <div id="cancerFields" class="hidden">
            <div class="field">
              <label>Cancer Type</label>
              <select id="cancerTypeSelect" required>
                <option value="" disabled selected>Select</option>
                <option value="breast">Breast</option>
                <option value="lung">Lung</option>
                <option value="colorectal">Colorectal</option>
                <option value="prostate">Prostate</option>
                <option value="stomach">Stomach</option>
                <option value="liver">Liver</option>
                <option value="pancreatic">Pancreatic</option>
                <option value="ovarian">Ovarian</option>
                <option value="cervical">Cervical</option>
                <option value="leukemia">Leukemia</option>
                <option value="lymphoma">Lymphoma</option>
                <option value="melanoma">Melanoma</option>
                <option value="brain">Brain</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="field hidden" id="cancerTypeOtherWrap">
              <label>Specify Cancer Type</label>
              <input type="text" id="cancerTypeOther" placeholder="Enter cancer type">
            </div>

            <div class="field">
              <label>Stage (if known)</label>
              <select id="cancerStage">
                <option value="" selected>Not sure/Unknown</option>
                <option value="0">Stage 0</option>
                <option value="1">Stage I</option>
                <option value="2">Stage II</option>
                <option value="3">Stage III</option>
                <option value="4">Stage IV</option>
                <option value="not_applicable">Not applicable</option>
              </select>
            </div>

            <div class="field">
              <label>How long since diagnosis? (optional)</label>
              <select id="diagnosisAge">
                <option value="" selected>Skip</option>
                <option value="lt1m">Less than 1 month</option>
                <option value="1to3m">1–3 months</option>
                <option value="3to6m">3–6 months</option>
                <option value="6to12m">6–12 months</option>
                <option value="1to2y">1–2 years</option>
                <option value="gt2y">More than 2 years</option>
              </select>
            </div>

            <div class="field">
              <label>Current Treatment Stage (optional)</label>
              <select id="treatmentPhase">
                <option value="" selected>Skip</option>
                <option value="active">Active treatment</option>
                <option value="maintenance">Maintenance / ongoing management</option>
                <option value="recovery">Recovery / post-treatment</option>
                <option value="watchful_waiting">Surveillance / watchful waiting</option>
              </select>
            </div>

            <div class="field">
              <label>Time in current treatment stage (optional)</label>
              <select id="phaseDuration">
                <option value="" selected>Skip</option>
                <option value="lt1m">Less than 1 month</option>
                <option value="1to3m">1–3 months</option>
                <option value="3to6m">3–6 months</option>
                <option value="6to12m">6–12 months</option>
                <option value="1to2y">1–2 years</option>
                <option value="gt2y">More than 2 years</option>
              </select>
            </div>

            <div class="field">
              <label>Primary care setting (optional)</label>
              <select id="careSetting">
                <option value="" selected>Skip</option>
                <option value="morethanonce">More than once per week</option>
                <option value="weekly">Weekly</option>
                <option value="2weeks">Every 2 weeks</option>
                <option value="monthly">Monthly</option>
                <option value="rarely">Rarely / as needed</option>
              </select>
            </div>

            <div class="field">
              <label>Hospital/clinic visits frequency (optional)</label>
              <select id="visitFrequency">
                <option value="" selected>Skip</option>
                <option value="weekly2plus">2+ times per week</option>
                <option value="weekly1">About once per week</option>
                <option value="biweekly">Every 2 weeks</option>
                <option value="monthly">About once per month</option>
                <option value="rare">Rarely / only as needed</option>
              </select>
            </div>
          </div>

          <div class="info-box" style="margin:0;">
            If you select “No / Not diagnosed,” diagnosis-specific questions will be skipped automatically.
          </div>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="step-content" id="step-3">
        <div class="info-box">
          Please fill this out as an average for the recent week. This helps BioPal set realistic daily goals and reminders.
        </div>

        <div class="section">
          <h3>Daily Wellness Baseline (Recent Week)</h3>

          <div class="field">
            <label>Hydration (average cups/day)</label>
            <select id="hydration" required>
              <option value="" disabled selected>Select</option>
              <option value="lt2">0–2 cups/day</option>
              <option value="2to4">2–4 cups/day</option>
              <option value="4to6">4–6 cups/day</option>
              <option value="6to8">6–8 cups/day</option>
              <option value="gt8">8+ cups/day</option>
            </select>
          </div>

          <div class="field">
            <label>Diet quality (recent week)</label>
            <select id="dietQuality" required>
              <option value="" disabled selected>Select</option>
              <option value="low">Low (irregular meals / low appetite)</option>
              <option value="mid">Moderate (mostly regular meals)</option>
              <option value="high">High (balanced meals most days)</option>
            </select>
          </div>

          <div class="field">
            <label>Exercise (average minutes/day)</label>
            <select id="exerciseMinutes" required>
              <option value="" disabled selected>Select</option>
              <option value="0">0 minutes/day</option>
              <option value="lt10">1–10 minutes/day</option>
              <option value="10to20">10–20 minutes/day</option>
              <option value="20to40">20–40 minutes/day</option>
              <option value="gt40">40+ minutes/day</option>
            </select>
          </div>

          <div class="field">
            <label>Activity baseline</label>
            <select id="energyBaseline" required>
              <option value="high">Mobile (regular movement)</option>
              <option value="mid">Partial (frequent rest)</option>
              <option value="low">Resting (bed-based)</option>
            </select>
          </div>

          <div class="field">
            <label>Medical Conditions / Allergies (optional)</label>
            <textarea id="conditions" placeholder="e.g. Diabetes, Penicillin allergy..."></textarea>
          </div>
        </div>

        <div class="section">
          <h3>Medication Reminders</h3>
          <div class="info-box" style="margin:0 0 12px;">
            Medication reminders help you stay on schedule for pills, injections, or prescribed routines. Choose “No medication” if this is not needed.
          </div>

          <div class="field" style="margin-bottom:12px;">
            <label>How many times per day?</label>
            <select id="medFreq" required>
              <option value="0" selected>No medication</option>
              <option value="1">1 time/day</option>
              <option value="2">2 times/day</option>
              <option value="3">3 times/day</option>
            </select>
          </div>

          <div id="medTimesWrap" class="hidden">
            <div class="field">
              <label>Medication Times</label>
              <div id="medTimesContainer"></div>
            </div>
            <div class="info-box" style="margin:0;">
              Choose the exact time(s) you usually take medication.
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Dressing / Wound Care Reminders</h3>
          <div class="info-box" style="margin:0 0 12px;">
            Dressing reminders support wound care routines (e.g., changing dressings or checking a site). If you don’t have a schedule, select “No dressing schedule.”
          </div>

          <div class="field" style="margin-bottom:12px;">
            <label>How often?</label>
            <select id="dressingFreq" required>
              <option value="none" selected>No dressing schedule</option>
              <option value="daily">Every day</option>
              <option value="weekly">Every week</option>
            </select>
          </div>

          <div id="dressingWrap" class="hidden">
            <div class="field" id="dressingDayWrap" style="display:none;">
              <label>Day of Week</label>
              <select id="dressingDay">
                <option value="mon">Mon</option>
                <option value="tue">Tue</option>
                <option value="wed">Wed</option>
                <option value="thu">Thu</option>
                <option value="fri">Fri</option>
                <option value="sat">Sat</option>
                <option value="sun">Sun</option>
              </select>
            </div>

            <div class="field">
              <label>Time</label>
              <input type="time" id="dressingTime" value="09:00">
            </div>

            <div class="info-box" style="margin:0;">
              If weekly, select the day and time. If daily, select the time.
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="step-content" id="step-4">
        <div class="info-box">
          Add a trusted contact in case caregivers or clinicians need support reaching someone quickly.
        </div>

        <div class="section">
          <h3>Emergency Contact</h3>

          <div class="field">
            <label>Contact Name</label>
            <input type="text" id="emergencyName" placeholder="Full name" required>
          </div>

          <div class="field">
            <label>Relationship</label>
            <input type="text" id="emergencyRelationship" placeholder="e.g., Spouse, Parent, Friend" required>
          </div>

          <div class="field">
            <label>Phone of Emergency Contact</label>
            <input type="tel" id="emergencyPhone" placeholder="010-0000-0000" required>
          </div>

          <div class="field">
            <label>Email of Emergency Contact (optional)</label>
            <input type="email" id="emergencyEmail" placeholder="contact@example.com">
          </div>
        </div>

        <div class="field" style="margin-top:18px;">
          <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;text-transform:none;letter-spacing:0;">
            <input type="checkbox" id="consent" required style="width:auto;margin-top:3px;">
            <span style="font-size:13px;font-weight:500;color:var(--ink);">
              I consent to BioPal securely storing my data for AI-driven health analysis.
            </span>
          </label>
        </div>
      </div>

      <!-- STEP 5: Email Verification -->
      <div class="step-content" id="step-5">
        <div class="info-box">
          We sent a verification email to <b id="verifyEmailText"></b>.
          Please click the link in that email to verify your account.
        </div>

        <div class="section">
          <h3>Verify to finish</h3>
          <div class="modal-body" style="margin:0;">
            After verifying, come back here and press <b>I Verified</b>.
            If you don’t see the email, check spam/junk.
          </div>

          <div class="modal-actions" style="margin-top:14px;">
            <button type="button" class="btn btn-secondary" id="resendBtn">Resend Email</button>
            <button type="button" class="btn btn-ack" id="verifiedBtn">I Verified</button>
          </div>

          <div class="modal-body" id="verifyStatus" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="btn-group" id="navButtons">
        <button type="button" class="btn btn-prev" id="prevBtn" style="display:none;">Back</button>
        <button type="button" class="btn btn-next" id="nextBtn">Continue</button>
      </div>
    </form>
  </div>

  <script type="module">
    import { auth, db } from "{{ url_for('static', filename='js/firebase/config.js') }}";
    import {
      createUserWithEmailAndPassword,
      sendEmailVerification,
      reload
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ----------------------------
    // Wizard state
    // ----------------------------
    let currentStep = 1;
    const totalSteps = 5;
    const titles = ["Create Account", "Clinical Profile", "Lifestyle & Care Routine", "Emergency & Support", "Verify Email"];
    const subtitles = [
      "Step 1 of 5: Sign in securely.",
      "Step 2 of 5: Your clinical basics (diagnosis fields adjust automatically).",
      "Step 3 of 5: Recent-week averages and reminders.",
      "Step 4 of 5: Support contact and consent.",
      "Step 5 of 5: Verify your email to finish."
    ];

    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");
    const navButtons = document.getElementById("navButtons");

    // ----------------------------
    // Teen modal logic
    // ----------------------------
    const birthYearEl = document.getElementById("birthYear");
    const teenModal = document.getElementById("teenModal");
    const teenCloseBtn = document.getElementById("teenCloseBtn");
    const teenOkBtn = document.getElementById("teenOkBtn");
    const teenBackBtn = document.getElementById("teenBackBtn");

    let teenModalAcknowledged = false;

    function isTeenByYear(year){
      const y = Number(year);
      if (!y || y < 1900) return false;
      const now = new Date();
      const currentYear = now.getFullYear();
      const ageApprox = currentYear - y;
      return ageApprox >= 13 && ageApprox <= 19;
    }

    function openTeenModal(){
      if (teenModalAcknowledged) return;
      teenModal.classList.add("show");
    }
    function closeTeenModal(){
      teenModal.classList.remove("show");
    }

    teenCloseBtn.addEventListener("click", closeTeenModal);
    teenOkBtn.addEventListener("click", () => {
      teenModalAcknowledged = true;
      closeTeenModal();
    });
    teenBackBtn.addEventListener("click", () => {
      closeTeenModal();
      birthYearEl.focus();
    });
    teenModal.addEventListener("click", (e) => {
      if (e.target === teenModal) closeTeenModal();
    });

    function maybeShowTeenModal(){
      if (currentStep !== 2) return;
      const y = birthYearEl.value;
      if (isTeenByYear(y)) openTeenModal();
    }
    birthYearEl.addEventListener("change", () => {
      teenModalAcknowledged = false;
      maybeShowTeenModal();
    });
    birthYearEl.addEventListener("blur", maybeShowTeenModal);

    // ----------------------------
    // Dynamic: cancer diagnosis toggle
    // ----------------------------
    const hasCancer = document.getElementById("hasCancer");
    const cancerFields = document.getElementById("cancerFields");

    const cancerTypeSelect = document.getElementById("cancerTypeSelect");
    const cancerTypeOtherWrap = document.getElementById("cancerTypeOtherWrap");
    const cancerTypeOther = document.getElementById("cancerTypeOther");

    function setRequired(el, yes){
      if (!el) return;
      if (yes) el.setAttribute("required","required");
      else el.removeAttribute("required");
    }

    function syncCancerTypeUI(){
      const v = (cancerTypeSelect && cancerTypeSelect.value) ? cancerTypeSelect.value : "";
      const cancerOn = hasCancer.value === "yes";

      if (cancerOn && v === "other"){
        cancerTypeOtherWrap.classList.remove("hidden");
        setRequired(cancerTypeOther, true);
      } else {
        cancerTypeOtherWrap.classList.add("hidden");
        setRequired(cancerTypeOther, false);
        cancerTypeOther.value = "";
      }
    }

    function syncCancerDiagnosisUI(){
      const v = hasCancer.value;

      if (v === "yes"){
        cancerFields.classList.remove("hidden");
        setRequired(cancerTypeSelect, true);
      } else {
        cancerFields.classList.add("hidden");
        setRequired(cancerTypeSelect, false);

        if (cancerTypeSelect) cancerTypeSelect.value = "";
        if (cancerTypeOther) cancerTypeOther.value = "";
        if (cancerTypeOtherWrap) cancerTypeOtherWrap.classList.add("hidden");

        const ids = ["cancerStage","diagnosisAge","treatmentPhase","phaseDuration","careSetting","visitFrequency"];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
      }
      syncCancerTypeUI();
    }

    hasCancer.addEventListener("change", syncCancerDiagnosisUI);
    cancerTypeSelect.addEventListener("change", syncCancerTypeUI);
    syncCancerDiagnosisUI();

    // ----------------------------
    // Medication UI
    // ----------------------------
    const medFreq = document.getElementById("medFreq");
    const medTimesWrap = document.getElementById("medTimesWrap");
    const medTimesContainer = document.getElementById("medTimesContainer");

    function renderMedTimeInputs(n){
      medTimesContainer.innerHTML = "";
      const defaults = n === 1 ? ["09:00"]
        : n === 2 ? ["09:00","21:00"]
        : ["09:00","14:00","21:00"];

      for (let i = 1; i <= n; i++){
        const wrap = document.createElement("div");
        wrap.className = "field";
        wrap.innerHTML = `
          <label>Time ${i}</label>
          <input type="time" class="med-time" value="${defaults[i-1] || "09:00"}" required>
        `;
        medTimesContainer.appendChild(wrap);
      }
    }

    function syncMedUI(){
      const n = Number(medFreq.value);
      if (n <= 0){
        medTimesWrap.classList.add("hidden");
        medTimesContainer.innerHTML = "";
        return;
      }
      medTimesWrap.classList.remove("hidden");
      renderMedTimeInputs(n);
    }

    medFreq.addEventListener("change", syncMedUI);
    syncMedUI();

    // ----------------------------
    // Dressing UI
    // ----------------------------
    const dressingFreq = document.getElementById("dressingFreq");
    const dressingWrap = document.getElementById("dressingWrap");
    const dressingDayWrap = document.getElementById("dressingDayWrap");

    function syncDressingUI(){
      const f = dressingFreq.value;
      if (f === "none"){
        dressingWrap.classList.add("hidden");
        dressingDayWrap.style.display = "none";
        return;
      }
      dressingWrap.classList.remove("hidden");
      dressingDayWrap.style.display = (f === "weekly") ? "block" : "none";
    }

    dressingFreq.addEventListener("change", syncDressingUI);
    syncDressingUI();

    // ----------------------------
    // Validation
    // ----------------------------
    function markInvalid(el, invalid){
      if (!el) return;
      el.style.borderColor = invalid ? "#ef4444" : "rgba(15, 23, 42, 0.08)";
    }

    function validateStep(step){
      const stepEl = document.getElementById(`step-${step}`);
      let ok = true;

      const requiredEls = stepEl.querySelectorAll("[required]");
      requiredEls.forEach(el => {
        const hidden = el.offsetParent === null;
        if (hidden) return;

        if (el.type === "checkbox"){
          if (!el.checked) ok = false;
          return;
        }

        const hasValue = !!String(el.value || "").trim();
        if (!hasValue) ok = false;
        markInvalid(el, !hasValue);
      });

      if (step === 1){
        const p = document.getElementById("password").value;
        const c = document.getElementById("confirmPassword").value;
        if (p && c && p !== c){
          markInvalid(document.getElementById("password"), true);
          markInvalid(document.getElementById("confirmPassword"), true);
          alert("Passwords do not match.");
          return false;
        }
      }

      if (step === 3){
        const n = Number(medFreq.value);
        if (n > 0){
          const times = [...document.querySelectorAll(".med-time")].map(x => x.value).filter(Boolean);
          if (times.length !== n) ok = false;
        }
        if (dressingFreq.value !== "none"){
          const t = document.getElementById("dressingTime").value;
          if (!t) ok = false;
        }
      }

      if (!ok) alert("Please complete all required fields.");
      return ok;
    }

    // ----------------------------
    // Wizard UI updates
    // ----------------------------
    function updateWizard(){
      document.getElementById("step-title").innerText = titles[currentStep - 1];
      document.getElementById("step-subtitle").innerText = subtitles[currentStep - 1];

      // Step 5 uses custom buttons (Resend / I Verified)
      if (currentStep === 5){
        navButtons.style.display = "none";
        return;
      } else {
        navButtons.style.display = "flex";
      }

      prevBtn.style.display = currentStep === 1 ? "none" : "block";
      nextBtn.innerText = currentStep === 4 ? "Finalize Account" : "Continue";
      nextBtn.disabled = false;
    }

    function goToStep(next){
      if (next < 1 || next > totalSteps) return;

      const curStepEl = document.getElementById(`step-${currentStep}`);
      const curDot = document.getElementById(`dot-${currentStep}`);

      if (curStepEl) curStepEl.classList.remove("active");
      if (curDot) curDot.classList.remove("active");

      currentStep = next;

      const nextStepEl = document.getElementById(`step-${currentStep}`);
      const nextDot = document.getElementById(`dot-${currentStep}`);

      if (nextStepEl) nextStepEl.classList.add("active");
      if (nextDot) nextDot.classList.add("active");

      updateWizard();
    }

    // ----------------------------
    // Navigation
    // ----------------------------
    nextBtn.onclick = async () => {
      if (!validateStep(currentStep)) return;

      if (currentStep === 2){
        const y = birthYearEl.value;
        if (isTeenByYear(y) && !teenModalAcknowledged){
          openTeenModal();
          return;
        }
      }

      if (currentStep < 4){
        document.getElementById(`dot-${currentStep}`).classList.add("completed");
        goToStep(currentStep + 1);
        return;
      }

      if (currentStep === 4){
        await finalizeAccount();
      }
    };

    prevBtn.onclick = () => {
      if (currentStep <= 1) return;
      // remove completed mark on the step we're going back to
      document.getElementById(`dot-${currentStep - 1}`).classList.remove("completed");
      goToStep(currentStep - 1);
    };

    // ----------------------------
    // Finalize + Firestore save + Send verification
    // ----------------------------
    async function finalizeAccount(){
      const pass = document.getElementById("password").value;
      const confirm = document.getElementById("confirmPassword").value;
      if (pass !== confirm) return alert("Passwords do not match.");

      nextBtn.disabled = true;
      nextBtn.innerText = "Creating account...";

      try{
        const email = document.getElementById("email").value.trim();
        const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
        const user = userCredential.user;

        const medN = Number(document.getElementById("medFreq").value);
        const medTimes = (medN > 0)
          ? [...document.querySelectorAll(".med-time")].map(x => x.value).filter(Boolean)
          : [];

        const dressFreq = document.getElementById("dressingFreq").value;

        const schedule = {
          medication: { timesPerDay: medN, times: medTimes },
          dressing: {
            frequency: dressFreq,
            dayOfWeek: (dressFreq === "weekly") ? document.getElementById("dressingDay").value : null,
            time: (dressFreq === "none") ? null : document.getElementById("dressingTime").value
          }
        };

        const cancerOn = document.getElementById("hasCancer").value === "yes";
        const cancerTypeFinal = (cancerOn && cancerTypeSelect.value === "other")
          ? (document.getElementById("cancerTypeOther").value || "").trim()
          : (cancerOn ? (cancerTypeSelect.value || "") : null);

        const clinical = {
          hasCancer: cancerOn,
          cancerType: cancerTypeFinal,
          cancerTypeCategory: cancerOn ? (cancerTypeSelect.value || null) : null,
          stage: cancerOn ? (document.getElementById("cancerStage").value || null) : null,
          diagnosisSince: cancerOn ? (document.getElementById("diagnosisAge").value || null) : null,
          treatmentPhase: cancerOn ? (document.getElementById("treatmentPhase").value || null) : null,
          treatmentStageDuration: cancerOn ? (document.getElementById("phaseDuration").value || null) : null,
          careSetting: cancerOn ? (document.getElementById("careSetting").value || null) : null,
          visitFrequency: cancerOn ? (document.getElementById("visitFrequency").value || null) : null
        };

        const profile = {
          uid: user.uid,
          email,
          body: {
            birthYear: Number(document.getElementById("birthYear").value),
            sex: document.getElementById("sex").value,
            heightCm: Number(document.getElementById("height").value),
            weightKg: Number(document.getElementById("weight").value)
          },
          clinical,
          baseline: {
            hydration: document.getElementById("hydration").value,
            dietQuality: document.getElementById("dietQuality").value,
            exerciseMinutes: document.getElementById("exerciseMinutes").value,
            activityBaseline: document.getElementById("energyBaseline").value,
            conditions: document.getElementById("conditions").value.trim()
          },
          schedule,
          emergency: {
            name: document.getElementById("emergencyName").value.trim(),
            relationship: document.getElementById("emergencyRelationship").value.trim(),
            phone: document.getElementById("emergencyPhone").value.trim(),
            email: (document.getElementById("emergencyEmail").value || "").trim()
          },
          teenNoticeAcknowledged: isTeenByYear(document.getElementById("birthYear").value) ? teenModalAcknowledged : false,
          createdAt: serverTimestamp(),

          // lock until verified
          setupComplete: false,
          emailVerified: false
        };

        // Save initial profile (incomplete until verified)
        await setDoc(doc(db, "users", user.uid), profile);

        // Send verification email
        nextBtn.innerText = "Sending verification...";
        await sendEmailVerification(user);

        // mark step 4 completed and go to step 5
        document.getElementById("dot-4").classList.add("completed");
        document.getElementById("verifyEmailText").innerText = email;

        goToStep(5);

      } catch (error){
        alert(error.message);
        nextBtn.disabled = false;
        nextBtn.innerText = "Finalize Account";
      }
    }

    // ----------------------------
    // Step 5 buttons
    // ----------------------------
    const resendBtn = document.getElementById("resendBtn");
    const verifiedBtn = document.getElementById("verifiedBtn");
    const verifyStatus = document.getElementById("verifyStatus");

    resendBtn.addEventListener("click", async () => {
      try{
        verifyStatus.textContent = "Resending verification email...";
        if (!auth.currentUser) throw new Error("No signed-in user.");
        await sendEmailVerification(auth.currentUser);
        verifyStatus.textContent = "Verification email sent again. Check inbox/spam.";
      } catch(e){
        verifyStatus.textContent = e.message || "Failed to resend.";
      }
    });

    verifiedBtn.addEventListener("click", async () => {
      try{
        verifyStatus.textContent = "Checking verification status...";
        if (!auth.currentUser) throw new Error("No signed-in user.");
        await reload(auth.currentUser);

        if (!auth.currentUser.emailVerified){
          verifyStatus.textContent = "Not verified yet. Click the link in your email, then press “I Verified” again.";
          return;
        }

        // finalize setup in Firestore
        await setDoc(doc(db, "users", auth.currentUser.uid), {
          emailVerified: true,
          setupComplete: true,
          verifiedAt: serverTimestamp()
        }, { merge: true });

        alert("Email verified — account setup complete!");
        window.location.href = "{{ url_for('login') }}";
      } catch(e){
        verifyStatus.textContent = e.message || "Verification check failed.";
      }
    });

    updateWizard();
  </script>
</body>
</html>
