<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioPal • Mission Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link rel="icon" type="image/png" sizes="32x32" href="../static/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/apple-touch-icon.png">
  <style>
    :root{
      --sky:#0ea5e9; --sky2:#38bdf8; --ink:#0b1220; --bg:#f6fbff;
      --panel:rgba(255,255,255,.86); --wire:rgba(2,6,23,.10);
      --soft:rgba(14,165,233,.08); --muted:#64748b;
      --shadow:0 12px 34px -18px rgba(2,6,23,.22);
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --border:rgba(2,6,23,.08);

      --orange:#f59e0b;
      --orange2:#fb923c;
      --orangeSoft: rgba(245,158,11,.12);
      --orangeBorder: rgba(245,158,11,.25);
      --orangeInk: #7c2d12;

      --fz-title: 16.5px;
      --fz-sub: 13.5px;
      --fz-body: 15.5px;
    }
    *{box-sizing:border-box; outline:none;}
    body{
      margin:0; font-family:'Plus Jakarta Sans',sans-serif;
      background: radial-gradient(900px 520px at 18% 10%, rgba(56,189,248,.20), transparent 55%),
                  radial-gradient(900px 520px at 85% 75%, rgba(14,165,233,.16), transparent 60%),
                  linear-gradient(180deg, var(--bg) 0%, #ffffff 55%, #ffffff 100%);
      color:var(--ink); -webkit-font-smoothing:antialiased; padding-bottom:120px;
      font-size: var(--fz-body);
    }

    .nav{
      position:sticky; top:16px; z-index:100; max-width:1200px; margin:16px auto;
      background:rgba(255,255,255,.70); backdrop-filter:blur(18px); border:1px solid var(--border);
      border-radius:24px; padding:12px 18px; display:flex; align-items:center; justify-content:space-between; box-shadow:var(--shadow);
      gap:12px;
    }
    .nav-left{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .nav-right{ display:flex; gap:8px; align-items:center; }

    .btn{ padding:12px 18px; border-radius:14px; border:none; font-weight:800; font-size:14px; cursor:pointer; transition:all .18s ease; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    .btn-primary{ background:linear-gradient(135deg, var(--ink), #101a33); color:#fff; box-shadow:0 14px 26px -18px rgba(2,6,23,.55); }
    .btn-ghost{ background:transparent; color:var(--ink); border:1px solid rgba(2,6,23,.08); }
    .btn-primary:disabled, .btn-ghost:disabled{ opacity:.55; cursor:not-allowed; }

    .nav-greet{
      display:flex; flex-direction:column; line-height:1.08;
      padding:6px 2px;
      min-width: 200px;
    }
    .nav-greet .hello{
      font-weight:950; letter-spacing:-.35px; font-size:15px;
    }
    .nav-greet .sub{
      font-weight:850; font-size:13px;
      color:rgba(100,116,139,.95);
      margin-top:3px;
    }

    .selfcheck-wrap{ max-width:1200px; margin: 0 auto 10px; padding: 0 12px; }
    .selfcheck-banner{
      display:none;
      border-radius:20px;
      padding:14px 14px;
      border:1px solid var(--orangeBorder);
      background:
        radial-gradient(260px 120px at 10% 20%, rgba(251,146,60,.18), transparent 60%),
        radial-gradient(260px 140px at 90% 80%, rgba(245,158,11,.16), transparent 60%),
        rgba(255,255,255,.78);
      box-shadow: 0 22px 54px -40px rgba(2,6,23,.35);
      backdrop-filter: blur(14px);
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .selfcheck-banner.show{ display:flex; }
    .selfcheck-left{ display:flex; align-items:center; gap:10px; }
    .selfcheck-ic{
      width:46px; height:46px; border-radius:18px;
      background: linear-gradient(135deg, var(--orange), var(--orange2));
      display:grid; place-items:center; color:#fff;
      box-shadow: 0 18px 36px -26px rgba(245,158,11,.75);
      border: 1px solid rgba(255,255,255,.40);
      flex:0 0 auto;
    }
    .selfcheck-ic i{ font-size:18px; }
    .selfcheck-txt{ display:flex; flex-direction:column; line-height:1.15; }
    .selfcheck-title{
      margin:0; font-weight:950; letter-spacing:-.3px; font-size: var(--fz-title); color: var(--orangeInk);
      display:flex; align-items:center; gap:8px;
    }
    .selfcheck-sub{
      margin:6px 0 0; font-weight:850; font-size: var(--fz-sub); color: rgba(124,45,18,.80);
    }
    .btn-orange{
      padding:11px 14px;
      border-radius:16px;
      border:1px solid rgba(245,158,11,.30);
      background: linear-gradient(135deg, rgba(245,158,11,.20), rgba(251,146,60,.14));
      color: #7c2d12;
      font-weight:950;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      transition: all .16s ease;
      box-shadow: 0 16px 36px -28px rgba(245,158,11,.55);
      white-space:nowrap;
      font-size: 14px;
    }
    .btn-orange:hover{ transform: translateY(-1px); border-color: rgba(245,158,11,.45); }

    .selfcheck-banner.done{
      border-color: rgba(16,185,129,.25);
      background:
        radial-gradient(260px 120px at 10% 20%, rgba(16,185,129,.16), transparent 60%),
        radial-gradient(260px 140px at 90% 80%, rgba(56,189,248,.16), transparent 60%),
        rgba(255,255,255,.82);
    }
    .selfcheck-banner.done .selfcheck-ic{
      background: linear-gradient(135deg, rgba(16,185,129,1), rgba(56,189,248,1));
      box-shadow: 0 18px 36px -26px rgba(16,185,129,.55);
    }
    .selfcheck-banner.done .selfcheck-title{ color: rgba(6,95,70,1); }
    .selfcheck-banner.done .selfcheck-sub{ color: rgba(6,95,70,.82); }
    .btn-green{
      padding:11px 14px;
      border-radius:16px;
      border:1px solid rgba(16,185,129,.25);
      background: linear-gradient(135deg, rgba(16,185,129,.14), rgba(56,189,248,.10));
      color: rgba(6,95,70,1);
      font-weight:950;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      transition: all .16s ease;
      box-shadow: 0 16px 36px -28px rgba(16,185,129,.45);
      white-space:nowrap;
      font-size: 14px;
    }
    .btn-green:hover{ transform: translateY(-1px); border-color: rgba(16,185,129,.40); }

.page{
  min-height:auto;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:12px;
  padding-top:6px;
}    .board{ width:min(1200px, 100%); border:1px solid rgba(14,165,233,.16); border-radius:28px; background:var(--panel); backdrop-filter:blur(18px); box-shadow: 0 22px 54px -38px rgba(2,6,23,.45); padding:22px; position:relative; overflow:hidden; }
    .pill{ background:rgba(255,255,255,.72); border-radius:18px; padding:12px 16px; display:flex; align-items:center; gap:12px; border:1px solid rgba(2,6,23,.06); }

    .topbar{
      position:relative;
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      min-height: 62px;
    }
    .topbar .sleep-wrap{ flex: 0 0 auto; width: min(420px, 100%); }
    .topbar .time-wrap{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      display:flex;
      justify-content:center;
      width: min(360px, 100%);
      pointer-events:none;
    }
    .topbar .time-wrap .pill{ pointer-events:auto; }

    .sleep-pill{
      padding:12px 14px;
      border-radius:20px;
/*      background: rgba(255,255,255,.74);*/
/*      border:1px solid rgba(2,6,23,.08);*/
/*      box-shadow: 0 14px 28px -24px rgba(2,6,23,.32);*/
      display:flex;
      align-items:center;
/*      justify-content:space-between;*/
      gap:12px;
    }
    .sleep-left{ display:flex; align-items:center; gap:10px; min-width: 0; }
    .sleep-meta{ display:flex; flex-direction:column; line-height:1.15; min-width:0; }
    .sleep-title{
      margin:0; font-weight:950; letter-spacing:-.25px; font-size: 15.5px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sleep-sub{ margin:5px 0 0; font-weight:850; color: var(--muted); font-size: 13px; }
    .sleep-stars{
      display:flex; align-items:center; gap:4px;
      padding:8px 10px; border-radius:999px;
      background: rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.18);
      flex:0 0 auto;
    }
    .sleep-stars i{ font-size:21px; margin-right: 3px; line-height:1; }
    .sleep-stars .on{ color:#f59e0b; }
    .sleep-stars .off{ color:rgba(2,6,23,.22); }

    .mission-card{
      background:rgba(255,255,255,.78);
      border-radius:22px;
      padding:24px 18px;
      min-height:160px;
      display:flex; align-items:center; gap:14px;
      border:1.5px solid rgba(14,165,233,.18);
      box-shadow: 0 12px 26px -20px rgba(2,6,23,.28);
      transition: all .18s ease;
      cursor:pointer; user-select:none;
      position:relative; overflow:hidden;
    }
    .mission-card::after{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(56,189,248,.18), transparent 55%, rgba(14,165,233,.12));
      opacity:.55;
      pointer-events:none;
    }
    .mission-card > *{ position:relative; z-index:1; }
    .mission-card:hover{
      transform: translateY(-1px);
      border-color: rgba(14,165,233,.45);
      box-shadow: 0 18px 34px -24px rgba(2,6,23,.34);
    }
    .mission-card.completed{ opacity:.62; background:rgba(2,6,23,.04); pointer-events:none; transform:none; box-shadow:none; }
    .icon-badge{
      width:64px; height:64px;
      border-radius:24px;
      background:linear-gradient(135deg, var(--sky), var(--sky2));
      color:#fff; display:grid; place-items:center; flex:0 0 auto;
      border:1px solid rgba(255,255,255,0.55);
      box-shadow: 0 16px 30px -24px rgba(14,165,233,.60);
    }
    .icon-badge i{ font-size:24px; }
    .icon-badge img{
      width:45px; height:45px; object-fit:contain; display:block;
      filter: drop-shadow(0 10px 18px rgba(2,6,23,.18));
    }

    .sensor-card{ background:rgba(255,255,255,.72); border-radius:20px; padding:14px; display:flex; align-items:center; gap:16px; border:1px solid rgba(14,165,233,.12); margin-bottom:12px; }
    .gif-slot{ width:64px; height:64px; border-radius:22px; background:rgba(14,165,233,.10); overflow:hidden; flex: 0 0 auto; border:1.5px solid rgba(14,165,233,.18); display:grid; place-items:center; }
    .gif-slot img{ width:100%; height:100%; object-fit:cover; }
    .character-box{ background:rgba(255,255,255,.72); border-radius:22px; width:100%; aspect-ratio:1/1; overflow:hidden; border:1px solid rgba(14,165,233,.14); }
    .character-box img{ width:100%; height:100%; object-fit:cover; }
    /* ===== Ultra-smooth GIF crossfade (double-buffer) ===== */
    .gif-stack{ position:absolute; inset:0; }
    .gif-layer{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transform:scale(1.06);
      filter: blur(14px);
      transition:
    opacity 3.2s cubic-bezier(.22,1,.36,1),
    transform 3.8s cubic-bezier(.22,1,.36,1),
    filter 3.8s cubic-bezier(.22,1,.36,1);
      will-change: opacity, transform, filter;
      backface-visibility:hidden;
      transform-origin: 50% 50%;
    }
    .gif-layer.is-front{
      opacity:1;
      transform:scale(1);
      filter: blur(0px);
    }
    /* subtle glow during swap (keeps it feeling “deep”) */
    .character-box.is-swapping::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(240px 140px at 50% 30%, rgba(56,189,248,.18), transparent 60%);
      opacity:0;
      pointer-events:none;
      animation: gifGlow 1.25s ease forwards;
      z-index: 15;
    }
    @keyframes gifGlow{
      0%{ opacity:0; }
      35%{ opacity:1; }
      100%{ opacity:0; }
    }
    @media (prefers-reduced-motion: reduce){
      .gif-layer{ transition:none; filter:none; transform:none; }
      .character-box.is-swapping::after{ display:none; }
    }

    .sensor-value{ margin-top:6px; display:flex; align-items:center; gap:8px; font-weight:900; font-size:1.05rem; }
    .dot{ width:9px; height:9px; border-radius:50%; display:inline-block; }
    .dot.ok{ background:var(--ok); } .dot.warn{ background:var(--warn); } .dot.bad{ background:var(--bad); }

    .center-feedback{ margin-top:14px; display:flex; justify-content:center; }
    .feedback-card{
      width:min(440px, 100%);
      border-radius:22px;
      padding:16px 16px;
      border:1px solid rgba(14,165,233,.18);
      background:
        radial-gradient(240px 120px at 18% 10%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(260px 140px at 88% 86%, rgba(14,165,233,.18), transparent 60%),
        rgba(255,255,255,.72);
      box-shadow: 0 22px 54px -40px rgba(2,6,23,.42);
      backdrop-filter: blur(14px);
      position:relative; overflow:hidden; text-align:center;
    }
    .feedback-card::after{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(56,189,248,.22), transparent 58%, rgba(14,165,233,.16));
      opacity:.75; pointer-events:none;
    }
    .feedback-inner{ position:relative; z-index:1; }
    #statusTitle{ margin:0; font-weight:950; letter-spacing:-.35px; font-size:19px; line-height:1.25; }

    .overlay{ position:fixed; inset:0; background:rgba(2,6,23,.45); backdrop-filter:blur(14px); display:none; align-items:center; justify-content:center; z-index:1200; padding:20px; }
    .overlay.show{display:flex;}
    .modalX{ background:#fff; width:100%; max-width:680px; border-radius:30px; overflow:hidden; box-shadow: 0 30px 60px rgba(0,0,0,.12); }
    .modal-headerX{ padding:20px 24px; border-bottom:1px solid rgba(2,6,23,.08); display:flex; justify-content:space-between; align-items:center; }
    .modal-bodyX{ padding:24px; max-height: 72vh; overflow-y: auto; }
    .modal-footerX{ padding:16px 24px; border-top:1px solid rgba(2,6,23,.08); display:flex; justify-content:flex-end; gap:10px; background: #fafafa; }

    .confirm-header{
      border-bottom:1px solid rgba(14,165,233,.18);
      background:
        radial-gradient(260px 120px at 12% 20%, rgba(56,189,248,.28), transparent 60%),
        radial-gradient(260px 140px at 90% 80%, rgba(14,165,233,.20), transparent 60%),
        rgba(255,255,255,.92);
    }
    .confirm-title{
      margin:0; font-size:18px; font-weight:950; letter-spacing:-.25px;
      display:flex; align-items:center; gap:10px;
    }
    .confirm-badge{
      width:36px; height:36px; border-radius:14px;
      display:grid; place-items:center; color:#fff;
      background: linear-gradient(135deg, var(--sky), var(--sky2));
      border: 1px solid rgba(255,255,255,.38);
      box-shadow: 0 18px 34px -28px rgba(14,165,233,.55);
      flex:0 0 auto;
    }
    .confirm-sub{ margin:8px 0 0; color: var(--muted); font-weight:800; font-size: 13px; line-height:1.45; }
    .btn-sky{
      padding:11px 14px; border-radius:16px;
      border:1px solid rgba(14,165,233,.22);
      background: linear-gradient(135deg, rgba(14,165,233,.14), rgba(56,189,248,.10));
      color: var(--ink); font-weight:950;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; transition: all .16s ease;
      box-shadow: 0 16px 36px -28px rgba(14,165,233,.35);
      white-space:nowrap; font-size: 14px;
    }
    .btn-sky:hover{ transform: translateY(-1px); border-color: rgba(14,165,233,.40); }

    .survey-step{display:none;}
    .survey-step.active{display:block;}
    .step-title{margin:0 0 10px; font-size:18px; font-weight:900; letter-spacing:-.3px;}
    .step-sub{margin:0 0 18px; color:var(--muted); font-weight:600; font-size:13px;}

    .field-group{margin-bottom:16px;}
    .field-group label{ display:block; font-weight:900; font-size:12px; margin-bottom:8px; }
    input,select,textarea{
      width:100%; padding:12px; border-radius:14px;
      border:1px solid rgba(14,165,233,.16);
      background:rgba(14,165,233,.06);
      font-weight:700; font-family:inherit;
      font-size: 14.5px;
    }
    .inline-2{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
    .subpanel{border:1px solid var(--border); background:#fff; border-radius:16px; padding:14px; margin-top:10px;}
    .hint{font-size:11px; color:var(--muted); margin-top:6px; line-height:1.35;}
    .hidden{display:none !important;}

    .toast-wrap{
      position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
      z-index: 2000; display:flex; flex-direction:column; gap:10px; pointer-events:none;
    }
    .toastX{
      pointer-events:auto;
      width: min(520px, calc(100vw - 28px));
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(2,6,23,.08);
      border-radius: 18px;
      box-shadow: 0 22px 44px -28px rgba(2,6,23,.45);
      padding: 14px 14px;
      display:flex; gap:12px; align-items:flex-start;
      backdrop-filter: blur(12px);
      animation: toastIn .22s cubic-bezier(.16,1,.3,1);
    }
    .toastX .t-ic{
      width:42px; height:42px; border-radius:14px;
      background: rgba(16,185,129,.12);
      border: 1px solid rgba(16,185,129,.22);
      display:grid; place-items:center;
      color: #10b981;
      flex:0 0 auto;
    }
    .toastX .t-title{ margin:0; font-weight:950; font-size:14px; line-height:1.2; }
    .toastX .t-sub{ margin:3px 0 0; font-weight:700; font-size:12px; color: var(--muted); }
    .toastX .t-close{
      margin-left:auto;
      width:36px; height:36px; border-radius:14px;
      border:1px solid rgba(2,6,23,.08);
      background: rgba(255,255,255,.75);
      display:grid; place-items:center;
      cursor:pointer;
    }
    @keyframes toastIn{
      from{ transform: translateY(-8px); opacity:.0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .mission-card.loading{
      cursor:default; pointer-events:none;
      background:rgba(255,255,255,.58);
      border:1.5px dashed rgba(14,165,233,.35);
      transform:none !important;
      box-shadow:none;
    }
    .mission-card.loading::after{ opacity:.25; }
    .mission-card.loading .icon-badge{
      background:rgba(14,165,233,.12);
      color:var(--ink);
      border:1px solid rgba(14,165,233,.22);
      box-shadow:none;
    }
    .mission-card.loading .spinner-border{ width:1.05rem; height:1.05rem; }

    .mission-card.locked{
      opacity:.95;
      background:rgba(255,255,255,.70);
      border:1.5px dashed rgba(14,165,233,.35);
      box-shadow:none;
    }
    .mission-card.locked::after{ opacity:.25; }
    .mission-card.locked:hover{ transform: translateY(-1px); border-color: var(--sky); }

    .debug-panel{ position: fixed; bottom: 42px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    .btn-debug{ width: 56px; height: 56px; border-radius: 18px; background: #0b1220; color: #fff; display: grid; place-items: center; border: 1px solid rgba(255,255,255,0.1); cursor:pointer; }

    @media (max-width:900px){
      .topbar{ flex-direction:column; align-items:stretch; gap:10px; min-height: unset; }
      .topbar .time-wrap{ position:static; transform:none; width: 100%; }
      .topbar .sleep-wrap{ width: 100%; }
    }
    @media (max-width:768px){
      .inline-2{grid-template-columns:1fr;}
      .nav{ padding:12px 14px; }
      .nav-left{ min-width: unset; }
      .nav-greet{ min-width: unset; }
      .selfcheck-banner{ flex-direction:column; align-items:flex-start; }
    }

    .nav-right .btn-ghost {
      background: var(--soft);
      color: var(--sky);
      border: 1px solid rgba(14,165,233, 0.2);
      font-weight: 700;
    }
    .nav-right .btn-ghost:hover {
      background: var(--sky);
      color: white;
      border-color: var(--sky);
      transform: translateY(-1px);
    }
    #logoutBtn {
      background: rgba(239, 68, 68, 0.08);
      color: var(--bad);
      border-color: rgba(239, 68, 68, 0.15);
    }
    #logoutBtn:hover { background: var(--bad); color: white; }

    /* ✅ NEW: blinking highlight for the chosen mission card */
    .mission-card.is-alarming{
      border-color: rgba(245,158,11,.65) !important;
      box-shadow: 0 22px 44px -28px rgba(245,158,11,.55) !important;
      animation: alarmBlink 1s ease-in-out infinite;
    }
    @keyframes alarmBlink{
      0%,100%{ transform: translateY(0); filter:saturate(1); }
      50%{ transform: translateY(-2px); filter:saturate(1.25); }
    }
    .sensor-card.is-warning {
  border-color: var(--bad) !important;
  background: rgba(239, 68, 68, 0.05); /* Very light red tint */
  box-shadow: 0 12px 24px -12px rgba(239, 68, 68, 0.4);
  animation: sensorBump 1.2s ease-in-out infinite;
}

@keyframes sensorBump {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}
    .level-line{display:flex; align-items:center; gap:10px; margin-bottom:6px}
.level-badge{
  display:inline-flex; align-items:center; justify-content:center;
  padding:6px 14px; border-radius:999px;
  margin: 0 auto;
  text-align:center;
  font-weight:950; letter-spacing:.2px; font-size:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
}
.level-badge.l1{color:#ED7EE5; background:white; border-color:#ED7EE5;}
.level-badge.l2{color:#F0B159; background:white; border-color:rgba(245,158,11,.45)}
.level-badge.l3{color:#57A0EB; background:white; border-color:rgba(59,130,246,.25)}
.level-badge.l4{color:#36D190; background:white; border-color:rgba(34,197,94,.25)}
.level-msg{font-weight:950; font-size:15px; letter-spacing:-.2px}
.character-box{
  position:relative;            /* makes overlay align to the box */
  display:inline-block;
  border-radius:22px;           /* match your design */
  overflow:hidden;              /* keeps overlay inside rounded corners */
}

.alarm-text-overlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:950;
  font-size:22px;
  letter-spacing:-.3px;
  color:#fff;
  text-align:center;
  background:rgba(2,6,23,.80);
  backdrop-filter:blur(6px);
  z-index:20;
  opacity:0;
  transition:opacity .25s ease;
  pointer-events:none;
}

    /* Mission completion screen over the character GIF */
    .gif-overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      border-radius: 26px;
      opacity:0;
      pointer-events:none;
      transition: opacity .45s ease;
    }
    .gif-overlay.show{ opacity:1; }
    .gif-overlay .gif-overlay-inner{
      text-align:center;
      width:100%;
      max-width: 320px;
      padding:14px 16px;
      border-radius:16px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 16px 34px rgba(2,6,23,.20);
      color:#0f172a;
    }
    .gif-overlay .gif-overlay-title{
      font-weight:900;
      letter-spacing:.2px;
      font-size: 18px;
      line-height: 1.1;
    }
    .gif-overlay .gif-overlay-sub{
      margin-top:6px;
      font-size: 13px;
      color: rgba(15,23,42,.65);
      font-weight:700;
    }


.alarm-text-overlay.show{ opacity:1; }
.hidden{ display:none !important; }
/* ===== Page Loader ===== */
/* ===== BioPal Page Loader ===== */
.page-loader{
  position:fixed;
  inset:0;
  z-index:5000;
  background:
    radial-gradient(420px 240px at 20% 15%, rgba(56,189,248,.25), transparent 60%),
    radial-gradient(520px 320px at 80% 85%, rgba(14,165,233,.22), transparent 65%),
    linear-gradient(180deg, #f8fafc, #eef2ff);
  display:flex;
  align-items:center;
  justify-content:center;
  transition:opacity .45s ease, visibility .45s ease;
}

.page-loader.hidden{
  opacity:0;
  visibility:hidden;
  pointer-events:none;
}

.loader-card{
  background:rgba(255,255,255,.78);
  border-radius:26px;
  padding:34px 38px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
  border:1px solid rgba(14,165,233,.22);
  box-shadow:
    0 40px 70px -40px rgba(2,6,23,.45),
    inset 0 0 0 1px rgba(255,255,255,.35);
  backdrop-filter:blur(16px);
}

/* ===== Ring Loader ===== */
.ring-loader{
  width:54px;
  height:54px;
  border-radius:50%;
  border:4px solid rgba(14,165,233,.18);
  border-top-color:#0ea5e9;
  animation:ring-spin 1.1s linear infinite;
  box-shadow:0 0 0 rgba(14,165,233,.0);
}

@keyframes ring-spin{
  to{ transform:rotate(360deg); }
}

/* ===== Text ===== */
.loader-text{
  font-weight:800;
  font-size:14px;
  letter-spacing:-.2px;
  color:#0b1220;
  opacity:.9;
}
/* ===== FIX RANGE INPUT FILL EDGE ISSUE ===== */
input[type="range"]{
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 8px;
  background: transparent;
  cursor: pointer;
}

/* Track */
input[type="range"]::-webkit-slider-runnable-track{
  height: 8px;
  border-radius: 999px;
  background:
    linear-gradient(
      to right,
      var(--sky) 0%,
      var(--sky) var(--range-fill, 0%),
      rgba(14,165,233,.15) var(--range-fill, 0%),
      rgba(14,165,233,.15) 100%
    );
}

input[type="range"]::-moz-range-track{
  height: 8px;
  border-radius: 999px;
  background: rgba(14,165,233,.15);
}

/* Fill (Firefox) */
input[type="range"]::-moz-range-progress{
  height: 8px;
  border-radius: 999px;
  background: var(--sky);
}

/* Thumb */
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--sky);
  border: 2px solid #fff;
  box-shadow: 0 4px 10px rgba(14,165,233,.4);
  margin-top: -5px; /* centers thumb perfectly */
}

input[type="range"]::-moz-range-thumb{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--sky);
  border: 2px solid #fff;
}



    /* Center GIF ultra-smooth fade (fade-out -> src swap -> fade-in) */
.gif-fade{
  opacity:1;
  transform:scale(1);
  transition:
    opacity 2.2s cubic-bezier(.4,0,.2,1),
    transform 2.2s cubic-bezier(.4,0,.2,1);
  will-change:opacity,transform;
}
.gif-fade.is-fading{
  opacity:0;
  transform:scale(.97);
}

/* Disable interaction inside Mission Reveal Modal */
#missionRevealModal .mission-card,
#missionRevealModal .mission-card *{
  pointer-events: none !important;
  cursor: default !important;
}


/* Static mission cards used ONLY inside Mission Reveal Modal */
.mission-card-static{
  pointer-events: none !important;
  cursor: default !important;
}

</style>
</head>

<body>
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

   <nav class="nav">
  <div class="nav-left">
    <div class="nav-greet" id="navGreeting" aria-label="Greeting">
      <div class="hello" id="helloLine">Hi, there</div>
      <div class="sub" id="greetSub">Weekly Missions</div>
    </div>
  </div>
<div id="openSurveyBtn" class="d-none">

</div>
  <div class="nav-right" style="display: flex; align-items: center; gap: 8px;">
    <a href="/dashboard" class="btn btn-ghost" id="refreshBtn">
      <i class="bi bi-grid-fill"></i> Dashboard
    </a>

    <a href="/chatbot" class="btn btn-ghost">
      <i class="bi bi-chat-dots-fill"></i> Chatbot
    </a>

    <a href="/resource" class="btn btn-ghost">
      <i class="bi bi-journal-text"></i> Resources
    </a>

    <a href="{{ url_for('main') }}" class="btn btn-ghost">
      <i class="bi bi-hearts"></i> BioPal App
    </a>

    <div class="dropdown">
      <button
        class="btn btn-ghost settings-btn"
        type="button"
        id="settingsMenuBtn"
        data-bs-toggle="dropdown"
        aria-expanded="false"
        aria-label="Settings menu"
        title="Settings"
        style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; padding: 0; border-radius: 12px;"
      >
        <i class="bi bi-gear-fill" style="font-size: 1.1rem;"></i>
      </button>

      <ul class="dropdown-menu dropdown-menu-end menu" aria-labelledby="settingsMenuBtn"
          style="min-width:240px; border-radius:18px; border:1px solid rgba(2,6,23,.10); box-shadow:var(--shadow-xl); overflow:hidden; margin-top: 10px;">

        <li class="dropdown-header"
            style="font-weight:950; letter-spacing:-.2px; padding:12px 14px; color:var(--ink);
                   background:rgba(248,250,252,.95); border-bottom:1px solid rgba(2,6,23,.08);">
          Account
        </li>

        <li>
          <a class="dropdown-item" href="/profile"
             style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
            <i class="bi bi-person-circle" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
            Profile
          </a>
        </li>

        <li id="menuLoginItem" style="display:none;">
          <a class="dropdown-item" href="/login"
             style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
            <i class="bi bi-box-arrow-in-right" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
            Login
          </a>
        </li>

        <li><hr class="dropdown-divider" style="margin:0; border-top-color:rgba(2,6,23,.08);"></li>

        <li id="menuLogoutItem">
          <button class="dropdown-item danger" id="logoutBtn"
                  style="padding:10px 14px; font-weight:900; display:flex; align-items:center; gap:10px;
                         color:var(--bad); background:transparent; border:0; width:100%; text-align:left;">
            <i class="bi bi-box-arrow-right" style="width:22px; font-size:1.05rem; color:var(--bad);"></i>
            Logout
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <div class="selfcheck-wrap">
    <div class="selfcheck-banner" id="selfCheckBanner" role="status" aria-live="polite">
      <div class="selfcheck-left">
        <div class="selfcheck-ic" id="selfCheckIcon"><i class="bi bi-exclamation-triangle-fill"></i></div>
        <div class="selfcheck-txt">
          <p class="selfcheck-title" id="selfCheckTitle">Self-check is not completed</p>
          <p class="selfcheck-sub" id="selfCheckSub">Please complete today’s check-in so BioPal can help you better.</p>
        </div>
      </div>

      <button class="btn-orange" id="selfCheckGoBtn" type="button">
        <i class="bi bi-clipboard2-heart"></i> Start Check-in
      </button>

      <button class="btn-green hidden d-none" id="selfCheckDoneBtn" type="button">
        <i class="bi bi-check2-circle"></i> View Check-in
      </button>
    </div>
  </div>
<div id="pageLoader" class="page-loader">
  <div class="loader-card">
    <div class="ring-loader"></div>
    <div class="loader-text">Preparing your BioPal dashboard</div>
  </div>
</div>

  <div class="page">
    <div class="board">

      <div class="topbar">
        <div class="sleep-wrap">
          <div class="sleep-pill">

<div class="sleep-stars d-flex align-items-center gap-2">
  <div id="stars"></div>

  <i class="bi bi-question-circle-fill text-muted"
     data-bs-toggle="tooltip"
     data-bs-placement="top"
     data-bs-title="This score is based on your sleep check-in (hours, quality, awakenings, and morning fatigue)."
     style="font-size:14px; cursor:help;"></i>
</div>
          </div>
        </div>

        <div class="time-wrap">
          <div class="pill">
            <div class="rating-top" style="font-weight:950; letter-spacing:-.2px; display:flex; align-items:center; gap:10px;">
              <i class="bi bi-clock-history"></i>
              <span id="realtime-label">--:--</span>
            </div>
          </div>
        </div>
      </div>

      <div class="row mid-row g-4">
        <div class="col-lg-4 d-flex flex-column gap-3">
          <div class="d-flex flex-column gap-4" id="mission-container"></div>
        </div>

        <div class="col-lg-4 text-center">
<div class="character-box">
  <div class="gif-stack" id="characterGifStack" aria-label="Guardian">
  <img id="characterSprite" class="gif-layer is-front" src="/static/gifs/character2.gif" alt="Guardian" data-current-src="/static/gifs/character2.gif">
  <img id="characterSpriteB" class="gif-layer" src="/static/gifs/character2.gif" alt="" aria-hidden="true">
</div>

  <div id="alarmTextOverlay" class="alarm-text-overlay hidden">
    It’s time to do your mission
  </div>
<div id="returnTextOverlay" class="alarm-text-overlay hidden">
  Let’s keep going
</div>
  <div id="missionCompleteOverlay" class="gif-overlay" aria-hidden="true">
    <div class="gif-overlay-inner">
      <div class="gif-overlay-title">Mission completed!</div>
      <div class="gif-overlay-sub">Great job — keep going.</div>
    </div>
  </div>
</div>



<div class="center-feedback">
  <div class="feedback-card" aria-live="polite">
    <div class="feedback-inner">

      <!-- Level badge (replaces statusTitle text) -->
      <span id="levelBadge" class="level-badge l3">Level 3</span>
      <br>
      <!-- Message below level -->
      <span id="levelMsg" class="level-msg"></span>

    </div>
  </div>
</div>

        </div>

        <div class="col-lg-4 d-flex flex-column gap-3">
          <div class="sensor-card">
            <div class="gif-slot"><img id="gif-temp" src="" alt="Temp"></div>
            <div class="card-text"><p class="m-0 fw-bold">Temperature</p><div class="sensor-value" id="val-temp"><span class="dot"></span> --</div></div>
          </div>
          <div class="sensor-card">
            <div class="gif-slot"><img id="gif-heart" src="" alt="Heart"></div>
            <div class="card-text"><p class="m-0 fw-bold">Heart Rate</p><div class="sensor-value" id="val-heart"><span class="dot"></span> --</div></div>
          </div>
          <div class="sensor-card">
            <div class="gif-slot"><img id="gif-stress" src="" alt="Stress"></div>
            <div class="card-text"><p class="m-0 fw-bold">Stress Level</p><div class="sensor-value" id="val-stress"><span class="dot"></span> --</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Mission Confirmation Modal -->
  <div class="overlay" id="confirmOverlay" aria-hidden="true">
    <div class="modalX" style="max-width:520px;">
      <div class="modal-headerX confirm-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="confirm-badge" id="confirmIcon"><i class="bi bi-check2-circle"></i></div>
          <div>
            <h3 class="confirm-title" id="confirmTitle">Complete mission?</h3>
            <p class="confirm-sub" id="confirmSub">Are you ready to mark this mission as done?</p>
          </div>
        </div>
        <button id="confirmCloseBtn" class="btn btn-ghost" type="button">✕</button>
      </div>

      <div class="modal-bodyX" style="padding:16px 20px;">
        <div style="border:1px solid rgba(14,165,233,.16); background:rgba(14,165,233,.06); border-radius:18px; padding:14px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <div class="icon-badge" style="width:54px; height:54px; border-radius:20px;">
              <img id="confirmPng" src="/static/img/missions/custom.png" alt="mission">
            </div>
            <div style="min-width:0;">
              <div id="confirmMissionName" style="font-weight:950; font-size:16px; letter-spacing:-.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Mission</div>
              <div id="confirmMissionDesc" style="margin-top:4px; color:var(--muted); font-weight:800; font-size:13px; line-height:1.35;">Description</div>
            </div>
          </div>

          <div id="confirmExtra" style="margin-top:12px; font-weight:850; font-size:13px; color:rgba(2,6,23,.80);"></div>
        </div>
      </div>

      <div class="modal-footerX" style="background:rgba(255,255,255,.92); border-top:1px solid rgba(14,165,233,.14);">
        <button type="button" id="confirmCancelBtn" class="btn btn-ghost">Not yet</button>
        <button type="button" id="confirmOkBtn" class="btn-sky"><i class="bi bi-check2"></i> Yes, complete</button>
      </div>
    </div>
  </div>

  <!-- Survey Modal -->
  <div class="overlay" id="overlay">
    <div class="modalX">
      <div class="modal-headerX">
        <div>
          <h2 style="margin:0; font-size:20px; font-weight:900;">Daily Check-in</h2>
          <span id="stepIndicator" style="font-size:12px; color:var(--muted); font-weight:800;">STEP 1 OF 5</span>
        </div>
        <button id="closeModalBtn" class="btn btn-ghost" type="button">✕</button>
      </div>

      <form id="wizardForm" novalidate>
        <div class="modal-bodyX">
          <!-- steps ... (unchanged) -->
          <div class="survey-step active" data-step="1">
            <h3 class="step-title">A. Overall Condition</h3>
            <p class="step-sub">A quick snapshot of your physical condition today.</p>
            <div class="field-group">
              <label for="a_condition">Overall physical condition</label>
              <select id="a_condition" required>
                <option value="" selected disabled>Select...</option>
                <option value="good">Good</option>
                <option value="average">Average</option>
                <option value="bad">Bad</option>
              </select>
            </div>
            <div class="field-group">
              <label for="a_painLevel">Pain level</label>
              <select id="a_painLevel" required>
                <option value="" selected disabled>Select...</option>
                <option value="none">None</option>
                <option value="mild">Mild</option>
                <option value="moderate">Moderate</option>
                <option value="severe">Severe</option>
              </select>
            </div>
            <div class="inline-2">
              <div class="field-group">
                <label for="a_painTiming">Pain timing (optional)</label>
                <select id="a_painTiming">
                  <option value="" selected>Not selected</option>
                  <option value="morning">Morning</option>
                  <option value="midday">Midday</option>
                  <option value="evening">Evening</option>
                  <option value="persistent">Persistent</option>
                </select>
              </div>
              <div class="field-group">
                <label for="a_nausea">Nausea/Vomiting (optional)</label>
                <select id="a_nausea">
                  <option value="" selected>Not selected</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>
            <div class="field-group">
              <label for="a_skin">Skin / mucosa status (optional)</label>
              <select id="a_skin">
                <option value="" selected>Not selected</option>
                <option value="normal">Normal</option>
                <option value="dry">Dry</option>
                <option value="sensitive">Sensitive</option>
                <option value="inflammation">Inflammation</option>
              </select>
            </div>
          </div>

          <div class="survey-step" data-step="2">
            <h3 class="step-title">B. Sleep Status</h3>
            <p class="step-sub">Your sleep routine helps BioPal provide feedback.</p>
            <div class="inline-2">
              <div class="field-group"><label for="b_sleepHours">Hours slept last night</label><input id="b_sleepHours" type="number" min="0" max="24" required></div>
              <div class="field-group"><label for="b_sleepQuality">Sleep quality</label>
                <select id="b_sleepQuality" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="good">Slept well</option>
                  <option value="woke_often">Woke up often</option>
                  <option value="hardly">Hardly slept</option>
                </select>
              </div>
            </div>
            <div class="inline-2">
              <div class="field-group"><label for="b_awakenings">Night awakenings</label>
                <select id="b_awakenings" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="0">0</option>
                  <option value="1-2">1-2</option>
                  <option value="3plus">3+</option>
                </select>
              </div>
              <div class="field-group"><label for="b_morningFatigue">Morning fatigue</label>
                <select id="b_morningFatigue" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="refreshed">Refreshed</option>
                  <option value="slightly">Slightly tired</option>
                  <option value="very">Very tired</option>
                </select>
              </div>
            </div>
          </div>

          <div class="survey-step" data-step="3">
            <h3 class="step-title">C. Activity and Fatigue</h3>
            <p class="step-sub">Track how active you were and how tired you feel.</p>
            <div class="field-group"><label for="c_activityLevel">Daily activity level</label>
              <select id="c_activityLevel" required>
                <option value="" selected disabled>Select...</option>
                <option value="low">Almost none</option>
                <option value="normal">Normal</option>
                <option value="active">Active</option>
              </select>
            </div>
            <div class="field-group">
              <label for="c_fatigue">Perceived fatigue (0–10)</label>
              <input id="c_fatigue" type="range" min="0" max="10" value="0" required>
              <div class="hint"><span id="c_fatigueLabel">0</span> / 10</div>
            </div>
          </div>

          <div class="survey-step" data-step="4">
            <h3 class="step-title">D. Emotion and Stress</h3>
            <p class="step-sub">Emotional check-in.</p>
            <div class="field-group"><label for="d_mood">Mood today</label>
<select id="d_mood" required>
  <option value="" selected disabled>Select...</option>
  <option value="good">Good</option>
  <option value="neutral">Neutral</option>
  <option value="sad">Sad</option>
  <option value="scared">Scared</option>
  <option value="angry">Angry</option>
  <option value="tired">Tired</option>
  <option value="other">Other</option>
</select>
            </div>
            <div class="field-group hidden" id="d_moodOtherWrap">
  <label for="d_moodOther">Please describe your mood</label>
  <input
    id="d_moodOther"
    type="text"
    placeholder="Describe your mood..."
  >
</div>

            <div class="field-group">
              <label for="d_anxiety">Worry/Anxiety (0-10)</label>
              <input id="d_anxiety" type="range" min="0" max="10" value="0" required>
              <div class="hint"><span id="d_anxietyLabel">5</span> / 10</div>
            </div>
            <div class="field-group"><label for="d_hardMoment">Difficult moment today?</label>
              <select id="d_hardMoment" required>
                <option value="" selected disabled>Select...</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="field-group"><label for="d_note">Emotion note (optional)</label><textarea id="d_note"></textarea></div>
            <div class="field-group d-none"><label for="d_gsr">Stress sensor (optional)</label><input id="d_gsr" type="number" step="0.01"></div>
          </div>

          <div class="survey-step" data-step="5">
            <h3 class="step-title">E. Care Routine Updates</h3>
            <p class="step-sub">Record any changes in medication or dressing plans.</p>

            <div class="field-group">
              <label for="e_medChanged">Medication changed today?</label>
              <select id="e_medChanged" required>
                <option value="" selected disabled>Select...</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div id="e_medPanel" class="subpanel hidden">
              <div class="field-group"><label for="e_medFreq">Times per day</label>
                <select id="e_medFreq">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div id="e_medTimesContainer" class="inline-2"></div>
            </div>

            <div class="field-group mt-3">
              <label for="e_dressChanged">Dressing changed today?</label>
              <select id="e_dressChanged" required>
                <option value="" selected disabled>Select...</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div id="e_dressPanel" class="subpanel hidden">
              <div class="field-group"><label for="e_dressFreq">Frequency</label>
                <select id="e_dressFreq">
                  <option value="none">None</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                </select>
              </div>
              <div id="e_dressDayWrap" class="hidden">
                <label for="e_dressDay">Day of week</label>
                <select id="e_dressDay">
                  <option value="mon">Mon</option><option value="tue">Tue</option><option value="wed">Wed</option>
                  <option value="thu">Thu</option><option value="fri">Fri</option>
                  <option value="sat">Sat</option><option value="sun">Sun</option>
                </select>
              </div>
              <div class="field-group mt-2"><label for="e_dressTime">Time</label><input id="e_dressTime" type="time" value="09:00"></div>
            </div>
          </div>
        </div>

        <div class="modal-footerX">
          <button type="button" id="prevBtn" class="btn btn-ghost" style="visibility:hidden;">Back</button>
          <button type="button" id="nextBtn" class="btn btn-primary">Next Step</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Condition Report Modal -->
  <div class="overlay" id="reportOverlay" aria-hidden="true">
    <div class="modalX">
      <div class="modal-headerX">
        <div>
          <h2 style="margin:0; font-size:20px; font-weight:900;">Condition Report</h2>
          <span id="reportSubhead" style="font-size:12px; color:var(--muted); font-weight:800;">Last 7 days summary</span>
        </div>
        <button id="closeReportBtn" class="btn btn-ghost" type="button">✕</button>
      </div>
      <div class="modal-bodyX" id="reportBody"></div>
      <div class="modal-footerX">
        <button type="button" id="refreshReportBtn" class="btn btn-ghost"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        <button type="button" id="closeReportBtn2" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Mission Reveal Modal -->
  <div class="overlay" id="missionRevealOverlay" aria-hidden="true">
    <div class="modalX">
      <div class="modal-headerX">
        <div>
          <h2 style="margin:0; font-size:20px; font-weight:900;">New Mission Unlocked</h2>
          <span id="missionRevealSub" style="font-size:12px; color:var(--muted); font-weight:800;">Tap the mission card to complete it.</span>
        </div>
        <button id="closeMissionRevealBtn" class="btn btn-ghost" type="button">✕</button>
      </div>
      <div class="modal-bodyX" id="missionRevealBody"></div>
      <div class="modal-footerX">
        <button type="button" id="closeMissionRevealBtn2" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <div class="debug-panel d-none">
    <button class="btn-debug" style="background:#ef4444" id="test-reset" title="Reset day"><i class="bi bi-trash3-fill"></i></button>
    <button class="btn-debug" id="test-skip-1h" title="Skip +1 hour"><i class="bi bi-hourglass-split"></i></button>
    <button class="btn-debug" id="test-skip-3h" title="Skip +3 hours"><i class="bi bi-hourglass"></i></button>
  </div>

<script type="module">
import { db, auth } from "/static/js/firebase/config.js";
  import { doc, setDoc, getDoc, onSnapshot, updateDoc, deleteField, serverTimestamp, deleteDoc }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const $ = (id) => document.getElementById(id);

  // Clamp helpers (module-scope)
//  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
//  const clampInt = (v, min, max) => {
//    const n = Number.isFinite(+v) ? Math.trunc(+v) : min;
//    return clamp(n, min, max);
//  };


  let userSession = null, timeOffset = 0, currentStep = 1, cachedUserProfile = null;
  let cachedHistory7d = [];

  const API_GENERATE_MISSION_URL = "/api/generate_mission";
  const API_CONDITION_REPORT_URL = "/api/condition_report";

  const MAX_VISIBLE = 2;

  const REVEAL_DELAY_MS = 60 * 60 * 1000;
  const REMINDER_EVERY_MS = 5 * 60 * 1000;

  const REMINDER_GIF = {
    WATER: "/static/gifs/hydration_alarm.gif",
    MED:   "/static/gifs/medication_alarm.gif",
    DRESS: "/static/gifs/dressing_alarm.gif"
  };
  const REMINDER_DURATION_MS = 2200;


  const MISSION_ALARM_MS = 200_000;

  const INTERVALS = [
    { id: "09-12", startHr: 9,  endHr: 12, label: "09:00 - 12:00" },
    { id: "12-15", startHr: 12, endHr: 15, label: "12:00 - 15:00" },
    { id: "15-18", startHr: 15, endHr: 18, label: "15:00 - 18:00" },
    { id: "18-21", startHr: 18, endHr: 21, label: "18:00 - 21:00" }
  ];

  const MISSION_ICON_PNG = {
    WATER:  "/static/img/missions/hydration.png",
    MED:    "/static/img/missions/medicine.png",
    DRESS:  "/static/img/missions/dressing.png",
    CUSTOM: "/static/img/missions/custom.png",
    INFO:   "/static/img/missions/custom.png"
  };
    const NEW_USER_LOADING_GIF = "/static/gifs/loading.gif";


/* -------------------- Character Level Engine -------------------- */
// Stored on user profile: users/{uid}.characterLevelState
// - Rolls over at 9am automatically because medicalDay changes at 9am (see getMedicalDayID()).
// - Level up: every 3 completed missions today (3, 6, 9...) → +1 level (max 4).
// - Level down: if 2 consecutive intervals end with 0 missions completed → -1 level (min 1).

function defaultCharacterLevelState(medicalDay){
  // New users: start at level 3 for the first day (but they still see loading.gif until they do something).
  const base = 3;
  return {
    medicalDay,
    level: base,
    upgradeMilestones: 0,      // floor(completedToday / 3)
    emptyIntervalsStreak: 0,   // count of consecutive ended intervals with 0 completion
    evaluatedIntervals: []     // interval ids already evaluated today
  };
}

function safeArray(x){ return Array.isArray(x) ? x : []; }

function endedIntervalsForNow(now){
  const hr = now.getHours();
  const out = [];
  for (const it of INTERVALS){
    if (it.endHr <= hr) out.push(it);
  }
  return out;
}

function missionsCompletedInInterval(completedList, intervalId){
  const prefix = `${intervalId}_`;
  return safeArray(completedList).filter(x => String(x).startsWith(prefix)).length;
}

async function persistCharacterLevelState(stateOrUid, maybeLevel, reasonMeta = {}) {
  // Backward-compatible signature:
  // - persistCharacterLevelState(uid, nextLevel, meta)
  // - persistCharacterLevelState(stateObj) where stateObj has { medicalDay, level, ... }
  let uid, nextLevel, state;
  if (typeof stateOrUid === "string") {
    uid = stateOrUid;
    nextLevel = maybeLevel;
    state = null;
  } else {
    state = stateOrUid || {};
    uid = userSession?.uid;
    nextLevel = state.level;
  }
  if (!uid) return null;

  const safeLevel = clampInt(nextLevel, 1, 4);
  const idleGif = levelToIdleGif(safeLevel);

  const characterLevelState = state && typeof state === "object"
    ? { ...state, level: safeLevel, gif: idleGif, lastUpdatedAtMs: Date.now(), ...reasonMeta }
    : { level: safeLevel, gif: idleGif, lastUpdatedAtMs: Date.now(), ...reasonMeta };

  // Canonical status object to mirror everywhere
  const characterStatus = { level: safeLevel, gif: idleGif, updatedAtMs: Date.now() };

  // 1) users/{uid} field (backward compatibility)
  await setDoc(doc(db, "users", uid), { characterLevelState, characterStatus }, { merge: true });

  // 2) users/{uid}/meta/{docId} (used by other pages in this project)
  await setDoc(doc(db, "users", uid, "meta", "characterLevelState"), characterLevelState, { merge: true });
  await setDoc(doc(db, "users", uid, "meta", "characterStatus"), characterStatus, { merge: true });

  // 3) Root collection: characterStatus/{uid}  ✅ (explicitly requested "document 'characterStatus'")
  await setDoc(doc(db, "characterStatus", uid), characterStatus, { merge: true });

  // 4) Daily snapshot: users/{uid}/daily_logs/{medicalDay}
  // Store the same status inside today's daily log for history/report pages.
  const dayId = (state && typeof state.medicalDay === "string" && state.medicalDay)
    ? state.medicalDay
    : (typeof getMedicalDayID === "function" ? getMedicalDayID(getNow()) : null);

  if (dayId) {
    await setDoc(
      doc(db, "users", uid, "daily_logs", dayId),
      { characterStatus, characterLevelState, lastUpdate: serverTimestamp() },
      { merge: true }
    );
  }


  cachedUserProfile = { ...(cachedUserProfile || {}), characterLevelState };
  return { characterLevelState, characterStatus };
}

async function persistIntervalOutcome(medicalDay, intervalId, anyCompleted){
  try{
    const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
    await setDoc(ref, {
      intervalOutcome: {
        [intervalId]: { anyCompleted: !!anyCompleted, evaluatedAtMs: Date.now() }
      },
      lastUpdate: serverTimestamp()
    }, { merge:true });
  } catch(e){
    // optional, so ignore failures
    console.warn("[Level] persistIntervalOutcome failed:", e);
  }
}

async function ensureCharacterLevelUpToDate(medicalDay, logData, now){
  // Load from cached profile first
  const prof = cachedUserProfile || {};
  let state = (prof.characterLevelState && typeof prof.characterLevelState === "object")
    ? { ...prof.characterLevelState }
    : null;

  if (!state || typeof state.level !== "number"){
    state = defaultCharacterLevelState(medicalDay);
  }

  // 9am rollover (medicalDay changes at 9am)
  if (state.medicalDay !== medicalDay){
    state = {
      ...state,
      medicalDay,
      upgradeMilestones: 0,
      emptyIntervalsStreak: 0,
      evaluatedIntervals: []
    };
  }

  const completed = safeArray(logData?.completedMissions);
  const milestone = Math.floor(completed.length / 3);

  // Level up for every +1 milestone reached today
  if (milestone > Number(state.upgradeMilestones || 0)){
    const diff = milestone - Number(state.upgradeMilestones || 0);
    state.level = clamp(Number(state.level || 3) + diff, 1, 4);
    state.upgradeMilestones = milestone;
  }

  // Level down if 2 consecutive ended intervals have 0 completion
  const already = new Set(safeArray(state.evaluatedIntervals).map(String));
  const ended = endedIntervalsForNow(now);

  for (const it of ended){
    const id = String(it.id);
    if (already.has(id)) continue;

    const done = missionsCompletedInInterval(completed, id);
    const anyCompleted = done > 0;

    if (anyCompleted){
      state.emptyIntervalsStreak = 0;
    } else {
      state.emptyIntervalsStreak = Number(state.emptyIntervalsStreak || 0) + 1;
      if (state.emptyIntervalsStreak >= 2){
        state.level = clamp(Number(state.level || 3) - 1, 1, 4);
        state.emptyIntervalsStreak = 0; // reset after downgrade
      }
    }

    state.evaluatedIntervals = safeArray(state.evaluatedIntervals).concat([id]);
    await persistIntervalOutcome(medicalDay, id, anyCompleted);
  }

  // Publish to globals
  currentCharacterLevel = clamp(Number(state.level || 3), 1, 4);

  // Keep cached profile in sync so subsequent calls are consistent
  cachedUserProfile = { ...(cachedUserProfile || {}), characterLevelState: state };

  await persistCharacterLevelState(state);
  return state;
}


  function missionPngSrc(missionId){
    const id = String(missionId || "");
    if (id.startsWith("CUSTOM_")) return MISSION_ICON_PNG.CUSTOM;
    return MISSION_ICON_PNG[id] || MISSION_ICON_PNG.INFO;
  }

  /* -------------------- csCode -------------------- */
  function isNewUserFromHistory(history){
    const arr = Array.isArray(history) ? history : [];
    if (!arr.length) return true;
    const anyActivity = arr.some(d =>
      !!d?.survey_v2 ||
      (Array.isArray(d?.completedMissions) && d.completedMissions.length > 0) ||
      (Array.isArray(d?.customMissionTexts) && d.customMissionTexts.length > 0) ||
      (d?.customMissions && typeof d.customMissions === "object" && Object.keys(d.customMissions).length > 0)
    );
    return !anyActivity;
  }
  function computeCSCode(profile, history){
    const isNew = isNewUserFromHistory(history);
    const fromProfile = (profile && typeof profile.csCode === "string") ? profile.csCode : "";
    if (isNew) return "cs01";
    if (fromProfile) return fromProfile;
    return "cs02";
  }

  /* -------------------- Navbar greeting -------------------- */
  function resolveUserName(profile){
    const p = profile || {};
    return (p.username || p.displayName || p.name || p.fullName || p.nickname || p.email || "there");
  }
  function greetingSublineByTime(now){
    const h = now.getHours();
    if (h >= 5 && h < 12) return "Good morning • Stay steady today";
    if (h >= 12 && h < 17) return "Good afternoon • Small steps count";
    if (h >= 17 && h < 22) return "Good evening • Keep it gentle";
    return "Late night • Prioritize rest";
  }
  function updateGreeting(){
    const name = resolveUserName(cachedUserProfile);
    const nice = String(name).split("@")[0] || "there";
    const now = getNow();
    $("helloLine").textContent = `Hi, ${nice}`;
    $("greetSub").textContent = greetingSublineByTime(now);
  }

  /* -------------------- Toasts -------------------- */
  const toastState = { lastKey: "", lastAt: 0 };
  function showToast({ title, message, ms = 3200, key = "" }){
    const wrap = $("toastWrap");
    if (!wrap) return;
    const now = Date.now();
    const guardKey = String(key || `${title}|${message}`);
    if (toastState.lastKey === guardKey && (now - toastState.lastAt) < 1500) return;
    toastState.lastKey = guardKey; toastState.lastAt = now;

    const el = document.createElement("div");
    el.className = "toastX";
    el.innerHTML = `
      <div class="t-ic"><i class="bi bi-check2-circle" style="font-size:18px;"></i></div>
      <div><p class="t-title">${title}</p><p class="t-sub">${message}</p></div>
      <button class="t-close" type="button"><i class="bi bi-x-lg"></i></button>
    `;
    el.querySelector(".t-close").onclick = () => el.remove();
    wrap.appendChild(el);
    window.setTimeout(() => el.remove(), ms);
  }

  /* -------------------- Character & Gifs -------------------- */

  // Live character status sync (listens to Firestore document 'characterStatus')
  let unsubscribeCharacterStatus = null;
  let currentCharacterLevel = 3;

  function fadeSwapGif(imgEl, newSrc){
    // Backward-compatible wrapper (older parts of the file call fadeSwapGif)
    // Uses the same smooth timing as swapGif.
    if (!imgEl || !newSrc) return;
    swapGif(imgEl, newSrc, { durationMs: 800 });
  }

  function renderLevelBadge(level){
    const badge = document.getElementById("levelBadge");
    const msg = document.getElementById("levelMsg");
    if (!badge) return;
    const lv = clampInt(level, 1, 4);
    badge.textContent = `Level ${lv}`;
    badge.classList.remove("l1","l2","l3","l4");
    badge.classList.add(`l${lv}`);
    if (msg){
if (lv === 4) msg.textContent = "Wow! You did a fantastic job today! ";
else if (lv === 3) msg.textContent = "Nice work! You’re on the right track ";
else if (lv === 2) msg.textContent = "That’s okay—let’s try one little thing ";
else msg.textContent = "No worries! Let’s do one mission together ";
    }
  }

  function applyCharacterStatus(status){
    if (!status || typeof status !== "object") return;
    const level = clampInt(status.level ?? 3, 1, 4);
    currentCharacterLevel = level;

    const sprite = document.getElementById("characterSprite");
    const srcFromDoc = (typeof status.gif === "string" && status.gif) ? status.gif : levelToIdleGif(level);
    fadeSwapGif(sprite, srcFromDoc);
    renderLevelBadge(level);
  }

  async function seedCharacterStatusIfMissing(uid){
    try{
      const rootRef = doc(db, "characterStatus", uid);
      const rootSnap = await getDoc(rootRef);
      if (rootSnap.exists()) return;

      const userSnap = await getDoc(doc(db, "users", uid));
      const userData = userSnap.exists() ? userSnap.data() : {};
      const status = userData?.characterStatus || userData?.characterLevelState || null;

      if (status && typeof status === "object"){
        const lv = clampInt(status.level ?? 3, 1, 4);
        const gif = status.gif || levelToIdleGif(lv);
        await setDoc(rootRef, { level: lv, gif, updatedAtMs: Date.now() }, { merge: true });
      } else {
        await setDoc(rootRef, { level: 3, gif: levelToIdleGif(3), updatedAtMs: Date.now() }, { merge: true });
      }
    } catch(e){
      console.warn("[characterStatus] seed failed:", e);
    }
  }

  function subscribeCharacterStatus(uid){
    if (unsubscribeCharacterStatus) { try{ unsubscribeCharacterStatus(); }catch(e){} }
    const rootRef = doc(db, "characterStatus", uid);
    unsubscribeCharacterStatus = onSnapshot(rootRef, (snap) => {
      if (snap.exists()) applyCharacterStatus(snap.data());
    }, (err) => console.warn("[characterStatus] onSnapshot error:", err));
  }

  const STATUS_IDLE_GIF = {
    "Happy / Energized": "/static/gifs/character1.gif",
    "Neutral / Calm": "/static/gifs/character2.gif",
    "Tired / Low Energy": "/static/gifs/character3.gif",
    "Concern / Warning": "/static/gifs/character4.gif"
  };



// Character "level" uses the same 4 character gifs, but mapped to performance.
// Level 4 = best = character1.gif, Level 1 = worst = character4.gif
const LEVEL_IDLE_GIF = {
  4: "/static/gifs/character1.gif", // Level 4 (best)
  3: "/static/gifs/character2.gif", // Level 3
  2: "/static/gifs/character3.gif", // Level 2
  1: "/static/gifs/character4.gif"  // Level 1 (worst)
};

    function levelToIdleGif(level){
      return LEVEL_IDLE_GIF[clampInt(level, 1, 4)] || LEVEL_IDLE_GIF[3];
    }

const COMPLETE_GIF = {
    WATER: "/static/gifs/hydration_complete.gif",
    MED: "/static/gifs/medication_complete.gif",
    DRESS: "/static/gifs/dressing_complete.gif",
    CUSTOM:"/static/gifs/custom_complete.gif"
  };

  const ALARM_GIF = {
    WATER: "/static/gifs/hydration_alarm.gif",
    MED:   "/static/gifs/medication_alarm.gif",
    DRESS: "/static/gifs/dressing_alarm.gif",
    CUSTOM:"/static/gifs/custom_alarm.gif"
  };
  const ALARM_LOOP_MS = 2400;

  let currentStatusLabel = "Neutral / Calm";
  let currentSelfScore = null;


  let isPlayingCompletion = false;
  let isPlayingReminder = false;
  let isPlayingAlarm = false;

  let characterTimer = null;
  let reminderTimer = null;
  let alarmTimer = null;

  let activeBasicsSet = new Set();


  function swapGif(img, nextSrc, { durationMs = 2400, settleMs = 3300 } = {}) {
    // Ultra-smooth double-buffer crossfade for the center character GIF.
    // Works when the character box contains 2 stacked <img> layers:
    //   #characterSprite (front) and #characterSpriteB (back)
    if (!img || !nextSrc) return;

    const box = img.closest(".character-box") || img.parentElement;
    const a = document.getElementById("characterSprite");
    const b = document.getElementById("characterSpriteB");

    // If stack isn't present, fall back to simple fade swap (legacy)
    if (!a || !b){
      const current = img.getAttribute("data-current-src") || img.src || "";
      if (current === nextSrc || current.endsWith(nextSrc)) return;
      if (img._swapLock) return;
      img._swapLock = true;
      img.classList.add("is-fading");
      window.setTimeout(() => {
        img.src = nextSrc;
        img.setAttribute("data-current-src", nextSrc);
        window.requestAnimationFrame(() => {
          img.classList.remove("is-fading");
          window.setTimeout(() => { img._swapLock = false; }, 1100);
        });
      }, durationMs);
      return;
    }

    // Choose current front/back
    const front = a.classList.contains("is-front") ? a : b;
    const back  = (front === a) ? b : a;

    const current = front.getAttribute("data-current-src") || front.src || "";
    if (current === nextSrc || current.endsWith(nextSrc)) return;

    // Lock on container to avoid rapid flicker from multiple snapshot events
    if (box && box._swapLock) return;
    if (box) box._swapLock = true;

    // Start "deep" transition
    if (box) box.classList.add("is-swapping");

    // Load new GIF into back layer first (prevents blank frame)
    const finish = () => {
      back.classList.add("is-front");
      front.classList.remove("is-front");

      back.setAttribute("data-current-src", nextSrc);

      // release lock after transition settles
      window.setTimeout(() => {
        if (box) {
          box._swapLock = false;
          box.classList.remove("is-swapping");
        }
      }, Math.max(1200, settleMs));
    };

    // If already set, just crossfade
    if ((back.getAttribute("data-pending-src") || "") === nextSrc){
      finish();
      return;
    }

    back.setAttribute("data-pending-src", nextSrc);

    // Attach one-time load handler
    const onLoad = () => {
      back.removeEventListener("load", onLoad);
      // slight delay to let first frame paint (avoids “flash”)
      window.requestAnimationFrame(() => window.requestAnimationFrame(finish));
    };

    back.addEventListener("load", onLoad, { once: true });

    // Trigger load
    back.src = nextSrc;

    // Safety: if load doesn't fire (cached / same URL edge), proceed anyway
    window.setTimeout(() => {
      if (back.classList.contains("is-front")) return;
      finish();
    }, Math.max(260, Math.min(1200, durationMs)));
  }

  function setCharacterSrc(src, opts = {}) {
    const img = $("characterSprite");
    if (!img) return;
    swapGif(img, `${src}`, opts);
  }

const ALARM_TEXT_DURATION_MS = 2500;

  const COMPLETION_TEXT_DURATION_MS = 3000;


  // How long the *_complete.gif stays on screen (feel free to tweak)
  const COMPLETION_HOLD_MS = 8000;

function showCharacterText(message, duration = 2500){
  const el = $("alarmTextOverlay");
  if (!el) return;

  el.textContent = message;
  el.classList.remove("hidden");
  el.classList.add("show");

  setTimeout(() => {
    el.classList.remove("show");
    setTimeout(() => el.classList.add("hidden"), 250);
  }, duration);
}

  function flashGifOverlay(title = "Mission completed!", sub = "Great job — keep going.", ms = 3000){
    const overlay = document.getElementById("missionCompleteOverlay");
    if (!overlay) return;

    const t = overlay.querySelector(".gif-overlay-title");
    const s = overlay.querySelector(".gif-overlay-sub");
    if (t) t.textContent = title;
    if (s) s.textContent = sub;

    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden", "false");

    window.clearTimeout(overlay.__hideTimer);
    overlay.__hideTimer = window.setTimeout(() => {
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
    }, ms);
  }

  // Utility: clamp & coerce to int (used by characterStatus updates)
  function clampInt(v, min, max){
    const n = Number.parseInt(v, 10);
    const safe = Number.isFinite(n) ? n : 0;
    return Math.max(min, Math.min(max, safe));
  }


  function showAlarmText(message = "It’s time to do your mission"){
  const el = $("alarmTextOverlay");
  if (!el) return;

  el.textContent = message;
  el.classList.remove("hidden");
  el.classList.add("show");

  setTimeout(() => {
    el.classList.remove("show");
    setTimeout(() => el.classList.add("hidden"), 250);
  }, ALARM_TEXT_DURATION_MS);
}

function showReturnText(message = "All set — let’s keep going"){
  const el = $("returnTextOverlay");
  if (!el) return;

  el.textContent = message;
  el.classList.remove("hidden");
  el.classList.add("show");

  setTimeout(() => {
    el.classList.remove("show");
    setTimeout(() => el.classList.add("hidden"), 250);
  }, RETURN_TEXT_DURATION_MS);
}

function playAlarmOnce(type){
  // Block if other animations are running
  if (isPlayingCompletion || isPlayingReminder) return;

  const t = (type === "WATER" || type === "MED" || type === "DRESS") ? type : "CUSTOM";
  const alarmGif = ALARM_GIF[t];
  if (!alarmGif) return;

  // Step 0) Start from current idle character
  const idleLv = clamp(Number(currentCharacterLevel || 3), 1, 4);
  const idleSrc = LEVEL_IDLE_GIF[idleLv] || LEVEL_IDLE_GIF[3];

  stopAlarmAnim();
  isPlayingAlarm = true;

  // Step 1) Idle + "It’s time..." overlay
  setCharacterSrc(idleSrc);
  showAlarmText("It’s time to do your mission");

  // Step 2) Swap to alarm gif after the text finishes
  setTimeout(() => {
    setCharacterSrc(alarmGif);

    // Step 3) After alarm gif loop, show "All set..." then return to idle
    alarmTimer = setTimeout(() => {
      showReturnText("All set — let’s keep going");

      setTimeout(() => {
        isPlayingAlarm = false;
        setIdleCharacterByLevel(currentCharacterLevel);
      }, RETURN_TEXT_DURATION_MS);

    }, ALARM_LOOP_MS);

  }, ALARM_TEXT_DURATION_MS);
}

function setIdleCharacterByLevel(level){
  // brand-new user → show loading.gif
  if (isNewUserFromHistory(cachedHistory7d)) {
    setCharacterSrc(NEW_USER_LOADING_GIF);
    return;
  }

  const lv = clamp(Number(level || 3), 1, 4);
  const idleSrc = LEVEL_IDLE_GIF[lv] || LEVEL_IDLE_GIF[3];
  setCharacterSrc(idleSrc);
}



  function stopReminderAnim(){
    if (reminderTimer) clearTimeout(reminderTimer);
    reminderTimer = null;
    isPlayingReminder = false;
  }
  function stopAlarmAnim(){
    if (alarmTimer) clearTimeout(alarmTimer);
    alarmTimer = null;
    isPlayingAlarm = false;
  }
function playCharacterOnce(type) {
  stopReminderAnim();
  stopAlarmAnim();
  if (characterTimer) clearTimeout(characterTimer);

  isPlayingCompletion = true;

  // 1️⃣ Text overlay (keep it visible while the GIF transitions)
  showCharacterText("Mission completed!", COMPLETION_TEXT_DURATION_MS);

  // 2️⃣ Idle → completion (slow, deep crossfade)
  const completionSrc = COMPLETE_GIF[type] || COMPLETE_GIF.CUSTOM;
  const idleSrc = (LEVEL_IDLE_GIF[currentCharacterLevel] || LEVEL_IDLE_GIF[3]);

  // start swapping shortly after the text appears (feels like one animation)
  setTimeout(() => {
    setCharacterSrc(completionSrc, { durationMs: 2400, settleMs: 3300 });

    // 3️⃣ Hold completion, then completion → idle (even slower return)
    characterTimer = setTimeout(() => {
      isPlayingCompletion = false;
      setCharacterSrc(idleSrc, { durationMs: 2800, settleMs: 3600 });
    }, COMPLETION_HOLD_MS);
  }, 180);
}


  function playReminderOnce(type){
    if (isPlayingCompletion || isPlayingAlarm) return;
    if (!type) return;
    const gif = REMINDER_GIF[type];
    if (!gif) return;

    stopReminderAnim();
    isPlayingReminder = true;

    playAlarmOnce(type);

    reminderTimer = setTimeout(() => {
      isPlayingReminder = false;
      setIdleCharacterByLevel(currentCharacterLevel);
    }, REMINDER_DURATION_MS);
  }



  function weightedPick(types){
    const w = [];
    for (const t of types){
      const weight = (t === "MED" || t === "DRESS") ? 3 : 1;
      for (let i=0; i<weight; i++) w.push(t);
    }
    if (!w.length) return null;
    return w[Math.floor(Math.random() * w.length)];
  }

  async function maybePlayReminderGif(){
    if (!userSession) return;
    if (isPlayingCompletion || isPlayingReminder || isPlayingAlarm) return;

    const options = Array.from(activeBasicsSet).filter(t => (t === "WATER" || t === "MED" || t === "DRESS"));
    if (!options.length) return;

    const pick = weightedPick(options);
    playReminderOnce(pick);
  }

  /* -------------------- ✅ Self-check Scoring (Rubric) -------------------- */
  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
  function safeNum(v, fallback=0){
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function scoreA1(cond){
    const v = String(cond || "");
    if (v === "good") return 30;
    if (v === "average") return 15;
    if (v === "bad") return 0;
    return 0;
  }
  function scoreA2(pain){
    const v = String(pain || "");
    if (v === "none") return 20;
    if (v === "mild") return 15;
    if (v === "moderate") return 10;
    if (v === "severe") return 0;
    return 0;
  }
  function scoreC(fatigue){
    const f = clamp(safeNum(fatigue, 10), 0, 10);
    return (10 - f) * 2.5;
  }
  function scoreD(mood){
    const v = String(mood || "");
    if (v === "good") return 25;
    if (v === "neutral") return 15;
    return 5;
  }
  function computeDailyScoreFromSurvey(surveyV2){
    if (!surveyV2) return null;
    const A = surveyV2.A || {};
    const C = surveyV2.C || {};
    const D = surveyV2.D || {};

    const a1 = scoreA1(A.cond);
    const a2 = scoreA2(A.pain);
    const c  = scoreC(C.fatigue);
    const d  = scoreD(D.mood);

    const total = a1 + a2 + c + d;
    return Math.round(clamp(total, 0, 100));
  }
  function mapScoreToState(score){
    const s = clamp(safeNum(score, 0), 0, 100);
    if (s >= 80) return "Happy / Energized";
    if (s >= 50) return "Neutral / Calm";
    if (s >= 30) return "Tired / Low Energy";
    return "Concern / Warning";
  }

  function shiftDay(yyyy_mm_dd, deltaDays){
    const d = new Date(yyyy_mm_dd + "T00:00:00");
    d.setDate(d.getDate() + deltaDays);
    return d.toISOString().slice(0,10);
  }

  async function resolveTodayOrYesterdaySelfStatus(medicalDay, todayLogData){
    const todaySurvey = todayLogData?.survey_v2 || null;
    if (todaySurvey){
      const sc = computeDailyScoreFromSurvey(todaySurvey);
      const label = mapScoreToState(sc);

      try{
        const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
        await setDoc(ref, {
          selfStatus: { score: sc, label, updatedAtMs: Date.now() },
          lastUpdate: serverTimestamp()
        }, { merge:true });
      } catch(e){
        console.warn("[SelfStatus] persist failed:", e);
      }

      return { score: sc, label, from: "today" };
    }

    const yDay = shiftDay(medicalDay, -1);
    try{
      const ySnap = await getDoc(doc(db, "users", userSession.uid, "daily_logs", yDay));
      if (ySnap.exists()){
        const yData = ySnap.data() || {};
        const ySelf = yData.selfStatus || null;

        if (ySelf && typeof ySelf.label === "string") {
          const yScore = (typeof ySelf.score === "number") ? ySelf.score : null;
          return { score: yScore, label: ySelf.label, from: "yesterday" };
        }

        if (yData.survey_v2){
          const sc = computeDailyScoreFromSurvey(yData.survey_v2);
          const label = mapScoreToState(sc);
          return { score: sc, label, from: "yesterday_survey" };
        }
      }
    } catch(e){
      console.warn("[SelfStatus] yesterday fetch failed:", e);
    }

    return { score: null, label: "Neutral / Calm", from: "default" };
  }

  /* -------------------- Mission Reveal Modal -------------------- */
  function openMissionRevealModal(missionObj, intervalId, medicalDay){
    const overlay = $("missionRevealOverlay");
    const body = $("missionRevealBody");
    if (!overlay || !body) return;
    body.innerHTML = "";
    const card = createMissionCard(missionObj, intervalId, medicalDay, false);
    body.appendChild(card);
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden", "false");
  }
  function closeMissionRevealModal(){
    const overlay = $("missionRevealOverlay");
    if (!overlay) return;
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden", "true");
    $("missionRevealBody").innerHTML = "";
  }

  /* -------------------- Confirm Modal logic -------------------- */
  const confirmState = { open:false, fullId:"", medicalDay:"", type:"", missionTitle:"", missionSub:"", missionPng:"" };

  const CONFIRM_TEXT = {
    WATER: { title:"Hydration check", sub:"Did you drink about 250ml of water?", extra:"Tip: Slow sips are okay. Any water counts." },
    MED:   { title:"Medication check", sub:"Did you take your medication as scheduled?", extra:"Tip: If you’re unsure, check with your care plan or an adult." },
    DRESS: { title:"Dressing check", sub:"Did you check or change your dressing?", extra:"Tip: Wash hands first. If something looks off, tell an adult." },
    CUSTOM:{ title:"Custom mission", sub:"Did you finish the custom mission?", extra:"Tip: Small effort is enough — you’re building a habit." }
  };

  function isCustomId(id){ return String(id || "").startsWith("CUSTOM_"); }
  function missionTypeFromMission(m){
    const id = String(m?.id || "");
    if (id === "WATER" || id === "MED" || id === "DRESS") return id;
    if (id.startsWith("CUSTOM_")) return "CUSTOM";
    return "CUSTOM";
  }

  function openConfirmModal({ type, fullId, medicalDay, missionTitle, missionSub, missionPng }){
    const overlay = $("confirmOverlay");
    if (!overlay) return;

    const t = (type === "WATER" || type === "MED" || type === "DRESS") ? type : "CUSTOM";
    const copy = CONFIRM_TEXT[t] || CONFIRM_TEXT.CUSTOM;

    $("confirmTitle").textContent = copy.title;
    $("confirmSub").textContent = copy.sub;
    $("confirmExtra").textContent = copy.extra || "";

    $("confirmMissionName").textContent = missionTitle || "Mission";
    $("confirmMissionDesc").textContent = missionSub || "";
    $("confirmPng").src = missionPng || MISSION_ICON_PNG.INFO;

    const iconEl = $("confirmIcon");
    if (iconEl){
      if (t === "WATER") iconEl.innerHTML = `<i class="bi bi-droplet-fill"></i>`;
      else if (t === "MED") iconEl.innerHTML = `<i class="bi bi-capsule"></i>`;
      else if (t === "DRESS") iconEl.innerHTML = `<i class="bi bi-bandaid"></i>`;
      else iconEl.innerHTML = `<i class="bi bi-stars"></i>`;
    }

    confirmState.open = true;
    confirmState.fullId = fullId;
    confirmState.medicalDay = medicalDay;
    confirmState.type = type;
    confirmState.missionTitle = missionTitle || "";
    confirmState.missionSub = missionSub || "";
    confirmState.missionPng = missionPng || "";

    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
  }

  function closeConfirmModal(){
    const overlay = $("confirmOverlay");
    if (!overlay) return;
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    confirmState.open=false;
    confirmState.fullId="";
    confirmState.medicalDay="";
    confirmState.type="";
    confirmState.missionTitle="";
    confirmState.missionSub="";
    confirmState.missionPng="";
  }

  $("confirmCloseBtn").onclick = closeConfirmModal;
  $("confirmCancelBtn").onclick = closeConfirmModal;
  $("confirmOkBtn").onclick = async () => {
    try{
      const { fullId, medicalDay, type } = confirmState;
      closeConfirmModal();

      await finishMission(fullId, medicalDay, type);
    } catch(e){
      console.warn("[Confirm] failed:", e);
    }
  };

  /* -------------------- Time Utils -------------------- */
  function getNow() {
    const d = new Date(Date.now() + timeOffset * 3600000);
    $("realtime-label").textContent = d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false });
    return d;
  }
  function ymdLocal(d){
    try { return d.toLocaleDateString("en-CA"); } catch(e) {}
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function getCalendarDayID(){
    return ymdLocal(getNow());
  }

  function getMedicalDayID() {
    const now = getNow();
    const medDate = new Date(now);
    if (now.getHours() < 9) medDate.setDate(medDate.getDate() - 1);
    return ymdLocal(medDate);
  }
  function lastNDaysFrom(baseDay, n){
    const days = [];
    for(let i=0;i<n;i++) days.push(shiftDay(baseDay, -i));
    return days;
  }
  function getIntervalByHour(hr){
    return INTERVALS.find(i => hr >= i.startHr && hr < i.endHr) || null;
  }
  function getIntervalEndDate(now, interval){
    const end = new Date(now);
    end.setHours(interval.endHr, 0, 0, 0);
    return end;
  }

  /* -------------------- Schedule helpers -------------------- */
  function timeStrToMinutes(t){
    if (!t || typeof t !== "string") return null;
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    const hh = Number(m[1]), mm = Number(m[2]);
    if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
    return hh * 60 + mm;
  }
  function intervalToMinuteRange(interval){
    const start = interval.startHr * 60;
    const end = interval.endHr * 60;
    return { start, end };
  }
  function isTimeInInterval(timeStr, interval){
    const mins = timeStrToMinutes(timeStr);
    if (mins === null) return false;
    const r = intervalToMinuteRange(interval);
    return mins >= r.start && mins < r.end;
  }
  function getWeekdayKeyFromYYYYMMDD(yyyy_mm_dd){
    const d = new Date(yyyy_mm_dd + "T00:00:00");
    const map = ["sun","mon","tue","wed","thu","fri","sat"];
    return map[d.getDay()];
  }
  function pickTimesWithinInterval(timesArr, interval){
    const out = [];
    const arr = Array.isArray(timesArr) ? timesArr : [];
    for (const t of arr){
      if (isTimeInInterval(t, interval)) out.push(t);
    }
    out.sort((a,b) => (timeStrToMinutes(a) ?? 0) - (timeStrToMinutes(b) ?? 0));
    return out;
  }
  function isDressingDueForInterval(scheduleDressing, interval, medicalDay){
    const d = scheduleDressing || {};
    const freq = d.frequency || "none";
    const time = d.time || null;

    if (freq === "none" || !time) return { due:false, dueTime:null };
    if (!isTimeInInterval(time, interval)) return { due:false, dueTime:null };

    if (freq === "daily") return { due:true, dueTime: time };

    if (freq === "weekly") {
      const dayKey = d.dayOfWeek || null;
      const todayKey = getWeekdayKeyFromYYYYMMDD(medicalDay);
      if (!dayKey) return { due:false, dueTime:null };
      return { due: dayKey === todayKey, dueTime: (dayKey === todayKey ? time : null) };
    }
    return { due:false, dueTime:null };
  }

  /* -------------------- History -------------------- */
  async function fetchHistoryDays(n=7){
    try{
      const base = getMedicalDayID();
      const days = lastNDaysFrom(base, n);
      const out = [];
      for(const day of days){
        const snap = await getDoc(doc(db, "users", userSession.uid, "daily_logs", day));
        if (snap.exists()){
          const d = snap.data() || {};
          out.push({
            day,
            survey_v2: d.survey_v2 || null,
            completedMissions: d.completedMissions || [],
            customMissionTexts: d.customMissionTexts || [],
            customMissions: d.customMissions || {},
            statusState: d.statusState || null,
            intervalOutcome: d.intervalOutcome || null,
            selfStatus: d.selfStatus || null
          });
        } else {
          out.push({ day, survey_v2:null, completedMissions:[], customMissionTexts:[], customMissions:{}, statusState:null, intervalOutcome:null, selfStatus:null });
        }
      }
      return out;
    } catch(e){
      console.warn("[History] fetch failed:", e);
      return [];
    }
  }

  /* -------------------- AI Custom Mission API -------------------- */
  function makeReqId(prefix="REQ"){ return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2,8)}`; }
  function looksLikeGptMissionPayload(data){
    return !!(data && typeof data === "object" && typeof data.name === "string" && typeof data.desc === "string" && typeof data.icon === "string");
  }

  async function fetchCustomMission(index, avoidTitles = new Set()) {
    const reqId = makeReqId(`AI${index}`);
    const csCode = computeCSCode(cachedUserProfile || {}, cachedHistory7d || []);
    const payload = { index, csCode, profile: cachedUserProfile || {}, history: cachedHistory7d || [], nowISO: new Date().toISOString() };

    try {
      const response = await fetch(API_GENERATE_MISSION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const t = await response.text().catch(()=> "");
        console.warn(`[AI][${reqId}] server non-200`, response.status, t);
        showToast({ title:"AI Mission Failed", message:`Server error (${response.status}). Using fallback.`, key:`ai_fail_${reqId}` });
        throw new Error(`API ${response.status}`);
      }

      const data = await response.json();

      const safeIcon = (data && typeof data.icon === "string" && data.icon.startsWith("bi-")) ? data.icon : "bi-stars";
      const safeName = (data && data.name) ? String(data.name) : "Custom Mission";
      const safeDesc = (data && data.desc) ? String(data.desc) : "A small goal tailored for you.";

      let finalName = safeName;
      let guard = 0;
      while (avoidTitles.has(finalName.trim().toLowerCase()) && guard < 3) {
        guard += 1;
        finalName = `${safeName} +`;
      }

      const mission = { id: `CUSTOM_1`, title: finalName, sub: safeDesc, icon: safeIcon };

      if (looksLikeGptMissionPayload(data)) {
        showToast({ title:"AI Mission Ready", message:`Custom mission generated.`, key:`ai_ok_${reqId}` });
      }
      return mission;

    } catch (e) {
      console.warn(`[AI][${reqId}] fetchCustomMission error:`, e);

      const fallbacks = [
        { id:"CUSTOM_1", title:"Body Stretch", sub:"5-min gentle stretch", icon:"bi-wind" },
        { id:"CUSTOM_1", title:"Nature Breath", sub:"2-min deep breathing", icon:"bi-tree" },
        { id:"CUSTOM_1", title:"Calm Sip", sub:"Warm tea or water, slow pace", icon:"bi-cup-hot" },
        { id:"CUSTOM_1", title:"Mini Walk", sub:"3-min light walk", icon:"bi-person-walking" }
      ];

      const lowered = new Set(Array.from(avoidTitles).map(s => String(s).trim().toLowerCase()));
      const pick = fallbacks.find(f => !lowered.has(f.title.trim().toLowerCase())) || fallbacks[0];
      return pick;
    }
  }

  /* -------------------- Custom mission persistence per interval (ONE SLOT) -------------------- */
  function getIntervalMeta(logData, intervalId){
    const meta = (logData && logData.intervalMeta && logData.intervalMeta[intervalId]) ? logData.intervalMeta[intervalId] : null;
    const fallback = (logData && typeof logData.nextRevealAt === "number") ? logData.nextRevealAt : 0;
    return { startedAt: meta?.startedAt || 0, nextRevealAt: meta?.nextRevealAt || fallback || 0, lastCompletedAt: meta?.lastCompletedAt || 0 };
  }

  function getCustomSlot(logData, intervalId){
    const cm = logData?.customMissions?.[intervalId];
    const slots = Array.isArray(cm?.slots) ? cm.slots : [];
    return slots[0] || null;
  }

  function hasCustomStored(logData, intervalId){
    return !!getCustomSlot(logData, intervalId);
  }

  async function saveCustomSlot(medicalDay, intervalId, missionObj){
    const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
    const snap = await getDoc(ref);
    const d = snap.exists() ? (snap.data() || {}) : {};
    const prev = d.customMissions || {};
    const prevInterval = prev[intervalId] || {};
    const prevSlots = Array.isArray(prevInterval.slots) ? prevInterval.slots.slice(0,2) : [null, null];

    prevSlots[0] = missionObj;

    const next = {
      ...prev,
      [intervalId]: { ...prevInterval, slots: prevSlots.slice(0,2), updatedAtMs: Date.now() }
    };

    await setDoc(ref, { customMissions: next, lastUpdate: serverTimestamp() }, { merge: true });
  }

  function lowerTitle(m){ return String(m?.title || "").trim().toLowerCase(); }

  async function generateAndSaveCustom(medicalDay, intervalId, avoidTitles){
    cachedHistory7d = await fetchHistoryDays(7);
    setIdleCharacterByLevel(currentCharacterLevel);

    let mission = await fetchCustomMission(1, avoidTitles);
    let key = String(mission.title || "").trim().toLowerCase();
    if (avoidTitles.has(key)) {
      mission = await fetchCustomMission(2, avoidTitles);
    }
    await saveCustomSlot(medicalDay, intervalId, mission);
    return mission;
  }

  /* -------------------- Mission plan builder -------------------- */
function buildBasicPoolForInterval(interval, medicalDay){
  const pool = [];

  // Hydration appears in every interval EXCEPT 3pm–6pm (15–18)
  if ((interval?.id || "") !== "15-18") {
    pool.push({
      id:"WATER",
      title:"Hydration",
      sub:"Drink 250ml Water",
      icon:"bi-droplet-fill"
    });
  }

  const med = cachedUserProfile?.schedule?.medication || {};
  const medTimes = Array.isArray(med.times) ? med.times : [];
  const dueMedTimes = pickTimesWithinInterval(medTimes, interval);
  if (dueMedTimes.length > 0) {
    const t = dueMedTimes[0];
    pool.push({
      id:"MED",
      title:"Medication",
      sub:`Take scheduled medication at ${t}`,
      icon:"bi-capsule"
    });
  }

  const dress = cachedUserProfile?.schedule?.dressing || { frequency:"none" };
  const dressDue = isDressingDueForInterval(dress, interval, medicalDay);
  if (dressDue.due) {
    pool.push({
      id:"DRESS",
      title:"Dressing",
      sub:`Check or change bandage (${dressDue.dueTime})`,
      icon:"bi-bandaid"
    });
  }
  return pool;
}

  function toFullId(intervalId, missionId){ return `${intervalId}_${missionId}`; }

  /* -------------------- UI helpers for missions -------------------- */
  function createMissionCard(m, intervalId, medicalDay, isDone=false){
    const card = document.createElement("div");
    card.className = "mission-card" + (isDone ? " completed" : "");
    card.dataset.missionId = String(m?.id || "");
    card.dataset.intervalId = String(intervalId || "");

    const png = missionPngSrc(m.id);

    card.innerHTML = `
      <div class="icon-badge">
        <img src="${png}" alt="${String(m.title || "mission")}">
      </div>
      <div>
        <p class="m-0 fw-bold" style="font-size:16px">${m.title}</p>
        <p class="m-0 small text-muted" style="font-size:13.5px">${m.sub}</p>
      </div>
    `;

    const fullId = `${intervalId}_${m.id}`;
    if (!isDone) {
      card.onclick = () => {
        const type = isCustomId(m.id) ? "CUSTOM" : m.id;
        openConfirmModal({ type, fullId, medicalDay, missionTitle:m.title, missionSub:m.sub, missionPng:png });
      };
    }
    return card;
  }

  function createLoadingCard(label="Generating custom mission..."){
    const card = document.createElement("div");
    card.className = "mission-card loading";
    card.innerHTML = `
      <div class="icon-badge">
        <img src="${MISSION_ICON_PNG.CUSTOM}" alt="loading">
      </div>
      <div style="flex:1 1 auto;">
        <p class="m-0 fw-bold" style="font-size:16px">${label}</p>
        <p class="m-0 small text-muted" style="font-size:13.5px">This will take a moment.</p>
      </div>
      <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
        <div class="spinner-border spinner-border-sm" role="presentation"></div>
      </div>
    `;
    return card;
  }

  function createLockedCard(minutes, onClick){
    const card = document.createElement("div");
    card.className = "mission-card locked";
    card.innerHTML = `
      <div class="icon-badge">
        <img src="${MISSION_ICON_PNG.CUSTOM}" alt="locked">
      </div>
      <div>
        <p class="m-0 fw-bold" style="font-size:16px">Refresh to Unlock</p>
        <p class="m-0 small text-muted" style="font-size:13.5px">Available in about ${minutes} min • Tap to refresh</p>
      </div>`;
    if (typeof onClick === "function") card.onclick = onClick;
    return card;
  }

  function createSuccessCard(){
    const card = document.createElement("div");
    card.className = "mission-card completed";
    card.innerHTML = `
      <div class="icon-badge">
        <img src="${MISSION_ICON_PNG.CUSTOM}" alt="done">
      </div>
      <div>
        <p class="m-0 fw-bold" style="font-size:16px">All Missions Completed</p>
        <p class="m-0 small text-muted" style="font-size:13.5px">Excellent work for this time window.</p>
      </div>
    `;
    return card;
  }

  function createInfoCard(title, sub){
    const card = document.createElement("div");
    card.className = "mission-card completed";
    card.innerHTML = `
      <div class="icon-badge">
        <img src="${MISSION_ICON_PNG.INFO}" alt="info">
      </div>
      <div>
        <p class="m-0 fw-bold" style="font-size:16px">${title}</p>
        <p class="m-0 small text-muted" style="font-size:13.5px">${sub}</p>
      </div>
    `;
    return card;
  }

  function replaceNode(oldNode, newNode){
    if (!oldNode || !oldNode.parentNode) return;
    oldNode.parentNode.replaceChild(newNode, oldNode);
  }

  /* -------------------- Center message -------------------- */
  function setCenterMessage(title="Doing great"){ $("statusTitle").textContent = title; }
function pickNiceTitleByCompleteness(_, isRest = false) {
  if (isRest) {
    return `
      <div class="level-line"><span class="level-badge l2">REST</span></div>
      <div class="level-msg">Recovery time — rest and breathe</div>
    `;
  }

  let level = 2;
  let msg = "Keep going — every mission counts";

  switch (currentStatusLabel) {
    case "Happy / Energized":   // character1.gif
      level = 4;
      msg = "Excellent work — maintain your mission completions to keep this level";
      break;

    case "Neutral / Calm":      // character2.gif
      level = 3;
      msg = "Great progress — keep completing your missions";
      break;

    case "Tired / Low Energy":  // character3.gif
      level = 2;
      msg = "Nice start — keep working on your missions";
      break;

    case "Concern / Warning":   // character4.gif
      level = 1;
      msg = "You can do better — start with one small mission";
      break;
  }

  return `
    <div class="level-line"><span class="level-badge l${level}">LEVEL ${level}</span></div>
    <div class="level-msg">${msg}</div>
  `;
}

  function updateCenterByCompleteness(pct, isRest=false){
  if (!isPlayingCompletion && !isPlayingReminder && !isPlayingAlarm) {
    setIdleCharacterByLevel(currentCharacterLevel);
  }
  $("statusTitle").innerHTML = pickNiceTitleByCompleteness(pct, isRest);
}


  /* -------------------- Sleep Stars -------------------- */
  function computeSleepStarsFromSurvey(surveyV2){
    const B = surveyV2?.B || null;
    if (!B) return { stars: 0, msg: "Your next check-in will update this score." };

    const hours = safeNum(B.hours, 0);
    let score = 0;

    if (hours >= 7 && hours <= 9) score += 40;
    else if (hours >= 6 && hours < 7) score += 30;
    else if (hours > 9 && hours <= 10) score += 30;
    else if (hours >= 5 && hours < 6) score += 18;
    else if (hours > 10 && hours <= 12) score += 18;
    else if (hours >= 3 && hours < 5) score += 8;

    const qual = String(B.qual || "");
    if (qual === "good") score += 30;
    else if (qual === "woke_often") score += 15;
    else if (qual === "hardly") score += 5;

    const aw = String(B.awakenings || "");
    if (aw === "0") score += 20;
    else if (aw === "1-2") score += 12;
    else if (aw === "3plus") score += 4;

    const mf = String(B.morningFatigue || "");
    if (mf === "refreshed") score += 10;
    else if (mf === "slightly") score += 6;
    else if (mf === "very") score += 2;

    let stars = 1;
    if (score >= 90) stars = 5;
    else if (score >= 75) stars = 4;
    else if (score >= 55) stars = 3;
    else if (score >= 35) stars = 2;

    const msg =
      stars >= 5 ? "Super sleep. Keep it up." :
      stars === 4 ? "Nice sleep. Great work." :
      stars === 3 ? "Okay sleep. Try a calm bedtime." :
      stars === 2 ? "Light sleep. Early bedtime helps." :
                    "Tough night. Rest a little more today.";

    return { stars, msg };
  }
  function renderSleepStars(stars, msg){
    const el = $("stars");
    if (!el) return;
    el.innerHTML = "";
    const s = Math.max(0, Math.min(5, Number(stars || 0)));
    for(let i=0; i<5; i++){
      const on = (s > 0 && i < s);
      el.innerHTML += `<i class="bi bi-star${on?'-fill on':' off'}"></i>`;
    }

  }

 async function updateSensors() {
  // ---- helpers ----
  const STATUSES = ["Stable", "Caution", "Warning"];

  const pickStatus = () => {
    const r = Math.random();
    if (r < 0.65) return "Stable";
    if (r < 0.90) return "Caution";
    return "Warning";
  };

  const dotClassFor = (status) => {
    if (status === "Stable") return "ok";
    if (status === "Caution") return "warn";
    return "bad";
  };

  const tempGif = (status) =>
    status === "Stable"  ? "/static/gifs/temperature_stable.gif" :
    status === "Caution" ? "/static/gifs/temperature_caution.gif" :
                           "/static/gifs/temperature_warning.gif";

  const heartGif = (status) =>
    status === "Stable"  ? "/static/gifs/heart_stable.gif" :
    status === "Caution" ? "/static/gifs/heart_caution.gif" :
                           "/static/gifs/heart_warning.gif";

  const stressGif = (status) =>
    status === "Stable"  ? "/static/gifs/stress_stable.gif" :
    status === "Caution" ? "/static/gifs/stress_caution.gif" :
                           "/static/gifs/stress_warning.gif";

  const randBetween = (a, b) => +(a + Math.random() * (b - a)).toFixed(1);
  const randInt = (a, b) => Math.floor(a + Math.random() * (b - a + 1));

  // ---- pick statuses ----
  const tempStatus = pickStatus();
  const heartStatus = pickStatus();
  const stressStatus = pickStatus();

  // ---- sensor values ----
  const temp =
    tempStatus === "Stable"  ? randBetween(36.3, 36.8) :
    tempStatus === "Caution" ? randBetween(37.1, 37.7) :
                               randBetween(38.0, 39.2);

  const heart =
    heartStatus === "Stable"  ? randInt(65, 85) :
    heartStatus === "Caution" ? randInt(90, 110) :
                                randInt(115, 145);

  const stress = stressStatus;

  // ---- UI updates & Warning Animations ----
  const tempCard = $("val-temp").closest('.sensor-card');
  const heartCard = $("val-heart").closest('.sensor-card');
  const stressCard = $("val-stress").closest('.sensor-card');

  // Update Temperature
  $("val-temp").innerHTML = `<span class="dot ${dotClassFor(tempStatus)}"></span> ${temp}°C (${tempStatus})`;
  $("gif-temp").src = tempGif(tempStatus);
  tempCard.classList.toggle('is-warning', tempStatus === "Warning");

  // Update Heart Rate
  $("val-heart").innerHTML = `<span class="dot ${dotClassFor(heartStatus)}"></span> ${heart} bpm (${heartStatus})`;
  $("gif-heart").src = heartGif(heartStatus);
  heartCard.classList.toggle('is-warning', heartStatus === "Warning");

  // Update Stress
  $("val-stress").innerHTML = `<span class="dot ${dotClassFor(stressStatus)}"></span> ${stress}`;
  $("gif-stress").src = stressGif(stressStatus);
  stressCard.classList.toggle('is-warning', stressStatus === "Warning");

  // ---- Save current status in Firestore ----
  try {
    if (!userSession?.uid) return;
    const medicalDay = getMedicalDayID();
    const payload = {
      sensorStatus: {
        temp:  { value: temp, unit: "C",   status: tempStatus },
        heart: { value: heart, unit: "bpm", status: heartStatus },
        stress:{ value: stress,            status: stressStatus }
      },
      sensorUpdatedAt: serverTimestamp()
    };
    const anyWarning = [tempStatus, heartStatus, stressStatus].includes("Warning");
    if (anyWarning) {
      await maybeSendSensorWarningEmail({
        medicalDay,
        sensorStatus: payload.sensorStatus, // temp/heart/stress with value+status
      });
    }

    await setDoc(doc(db, "users", userSession.uid, "daily_logs", medicalDay), payload, { merge: true });
  } catch (e) {
    console.warn("[updateSensors] Firestore save failed:", e);
  }
}

  /* -------------------- Self-check banner -------------------- */
  function computeChildStatusFromSurvey(surveyV2){
    if (!surveyV2) {
      return { tier:"none", title:"Self-check is not completed", sub:"Please complete today’s check-in so BioPal can help you better." };
    }

    const A = surveyV2.A || {};
    const B = surveyV2.B || {};
    const C = surveyV2.C || {};
    const D = surveyV2.D || {};

    let score = 60;

    if (A.cond === "good") score += 12;
    else if (A.cond === "bad") score -= 12;

    const pain = String(A.pain || "");
    if (pain === "none") score += 10;
    else if (pain === "mild") score += 4;
    else if (pain === "moderate") score -= 6;
    else if (pain === "severe") score -= 14;

    const hours = safeNum(B.hours, 0);
    if (hours >= 8) score += 10;
    else if (hours >= 7) score += 7;
    else if (hours >= 6) score += 3;
    else if (hours >= 5) score -= 4;
    else score -= 10;

    const fatigue = safeNum(C.fatigue, 5);
    score -= clamp(fatigue, 0, 10) * 2;

    const anxiety = safeNum(D.anxiety, 5);
    score -= clamp(anxiety, 0, 10) * 1.5;

    const mood = String(D.mood || "");
    if (mood === "good") score += 6;
    else if (mood === "neutral") score += 2;
    else if (mood === "tired") score -= 2;
    else score -= 6;

    score = clamp(score, 0, 100);

    if (score >= 75) return { tier:"great", title:"Check-in finished — you’re doing great", sub:"Keep sipping water and take short breaks. You’ve got this." };
    if (score >= 50) return { tier:"okay", title:"Check-in finished — nice job", sub:"Go slow today: water, a small rest, and gentle movement." };
    return { tier:"care", title:"Check-in finished — take extra care today", sub:"Rest more, drink water, and tell an adult if you feel worse." };
  }

  function setSelfCheckBannerBySurvey(surveyV2){
    const banner = $("selfCheckBanner");
    if (!banner) return;

    const goBtn = $("selfCheckGoBtn");
    const doneBtn = $("selfCheckDoneBtn");

    const status = computeChildStatusFromSurvey(surveyV2);

    $("selfCheckTitle").textContent = status.title;
    $("selfCheckSub").textContent = status.sub;

    banner.classList.add("show");

    if (status.tier === "none") {
      banner.classList.remove("done");
      $("selfCheckIcon").innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i>`;
      goBtn?.classList.remove("hidden");
      doneBtn?.classList.add("hidden");
      return;
    }

    banner.classList.add("done");
    $("selfCheckIcon").innerHTML = `<i class="bi bi-check2-circle"></i>`;
    goBtn?.classList.add("hidden");
    doneBtn?.classList.remove("hidden");

    if (status.tier === "great") $("selfCheckIcon").innerHTML = `<i class="bi bi-emoji-smile-fill"></i>`;
    if (status.tier === "okay") $("selfCheckIcon").innerHTML = `<i class="bi bi-heart-fill"></i>`;
    if (status.tier === "care") $("selfCheckIcon").innerHTML = `<i class="bi bi-shield-exclamation"></i>`;
  }

  /* -------------------- Interval start marker -------------------- */
  async function ensureIntervalStarted(medicalDay, intervalId, logData){
    const meta = getIntervalMeta(logData, intervalId);
    if (meta.startedAt && meta.startedAt > 0) return meta.startedAt;

    const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
    try{
      const snap = await getDoc(ref);
      const d = snap.exists() ? (snap.data() || {}) : {};
      const im = d.intervalMeta || {};
      const cur = im[intervalId] || {};
      if (!cur.startedAt) {
        im[intervalId] = { ...cur, startedAt: Date.now(), nextRevealAt: cur.nextRevealAt || 0, lastCompletedAt: cur.lastCompletedAt || 0 };
        await setDoc(ref, { intervalMeta: im, lastUpdate: serverTimestamp() }, { merge:true });
        return im[intervalId].startedAt;
      }
      return cur.startedAt || 0;
    } catch(e){
      console.warn("[Interval] ensureIntervalStarted failed:", e);
      return 0;
    }
  }

  /* =========================================================
     ✅ NEW: Alarm Engine (NO duplicates, NO sequential)
     - If there are active missions (max 2 shown), every 10s:
       pick ONE mission randomly from current active missions,
       blink that card + play its alarm gif once.
     - runs forever, and auto-updates when missions change.
  ========================================================= */

  let alarmEngineTimer = null;
  let alarmEngineKey = "";
  let alarmEngineList = []; // current active missions (ONLY current missions)

  function stopAlarmEngine(){
    if (alarmEngineTimer) clearInterval(alarmEngineTimer);
    alarmEngineTimer = null;
    alarmEngineKey = "";
    alarmEngineList = [];
    clearMissionBlink();
  }

  function buildAlarmKey(medicalDay, intervalId, missions){
    const ids = (Array.isArray(missions) ? missions : []).map(m => String(m?.id || "")).join("|");
    return `${medicalDay}::${intervalId}::${ids}`;
  }

  function clearMissionBlink(){
    const container = $("mission-container");
    if (!container) return;
    container.querySelectorAll(".mission-card.is-alarming").forEach(el => el.classList.remove("is-alarming"));
  }

  function blinkMissionCard(missionId){
    const container = $("mission-container");
    if (!container) return;
    clearMissionBlink();
    const id = String(missionId || "");
    const card = container.querySelector(`.mission-card[data-mission-id="${CSS.escape(id)}"]`);
    if (card) card.classList.add("is-alarming");
  }

  function pickRandomMission(list){
    const arr = Array.isArray(list) ? list : [];
    if (!arr.length) return null;
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function startOrUpdateAlarmEngine({ medicalDay, intervalId, missions }){
    const list = (Array.isArray(missions) ? missions : []).slice(0, MAX_VISIBLE); // only current missions on screen
    const key = buildAlarmKey(medicalDay, intervalId, list);

    alarmEngineList = list;

    // if missions changed, clear old blink so we don't blink a removed card
    if (alarmEngineKey !== key) clearMissionBlink();
    alarmEngineKey = key;

    if (alarmEngineTimer) return; // already running forever

    alarmEngineTimer = setInterval(() => {
      // if no active missions, do nothing (but keep timer alive)
      if (!alarmEngineList.length) return;

      // if completion/reminder is playing, skip this tick
      if (isPlayingCompletion || isPlayingReminder) return;

      // choose ONE mission from current missions, random
      const chosen = pickRandomMission(alarmEngineList);
      if (!chosen) return;

      blinkMissionCard(chosen.id);
      playAlarmOnce(missionTypeFromMission(chosen));
    }, MISSION_ALARM_MS);
  }
/** * Synchronizes currently visible missions to Firestore
 * for Arduino/Hardware consumption.
 */
async function syncActiveMissionsToFirestore(medicalDay, intervalId, missions) {
  if (!userSession?.uid) return;

  // 1. Filter out nulls and 2. Map valid data
  const arduinoPayload = missions
    .filter(m => m && m.title) // Ensure mission exists and has at least a title
    .map(m => ({
      id: m.id || "UNKNOWN",
      fullId: intervalId ? `${intervalId}_${(m.id || "UNKNOWN")}` : (m.id || "UNKNOWN"),
      title: m.title,
      description: m.sub || "Check BioPal dashboard for details"
    }));

  try {
    const calendarDay = getCalendarDayID();

    const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
    await setDoc(ref, {
      arduinoActiveMissions: arduinoPayload,
      arduinoLastSync: serverTimestamp()
    }, { merge: true });

    // Also mirror into calendar day so dashboard.html (YYYY-MM-DD) always matches
    if (calendarDay && calendarDay !== medicalDay) {
      const ref2 = doc(db, "users", userSession.uid, "daily_logs", calendarDay);
      await setDoc(ref2, {
        arduinoActiveMissions: arduinoPayload,
        arduinoLastSync: serverTimestamp()
      }, { merge: true });
    }
    // console.log("[Sync] Success:", arduinoPayload);
  } catch (e) {
    console.warn("[Sync] Firestore update failed:", e);
  }
}
  /* -------------------- Dashboard Logic -------------------- */
  async function updateDashboard(opts = {}) {
    if (!userSession) return;

    const now = getNow();
    const medicalDay = getMedicalDayID();
    const hr = now.getHours();
    const interval = getIntervalByHour(hr);

    const [pSnap, lSnap] = await Promise.all([
      getDoc(doc(db, "users", userSession.uid)),
      getDoc(doc(db, "users", userSession.uid, "daily_logs", medicalDay))
    ]);

    cachedUserProfile = pSnap.exists() ? pSnap.data() : {};
    updateGreeting();

    const logData = lSnap.exists() ? lSnap.data() : {};
    const completed = logData.completedMissions || [];

    const surveyV2 = logData.survey_v2 || null;
    const hasTodayCheckin = !!surveyV2;

    const selfRes = await resolveTodayOrYesterdaySelfStatus(medicalDay, logData);
    currentStatusLabel = selfRes.label;
    currentSelfScore = selfRes.score;
    await saveCharacterStatusToFirestore({
  medicalDay,
  label: currentStatusLabel,
  score: currentSelfScore
});

// Character level depends on mission completions + interval streaks (not self-check mood).
await ensureCharacterLevelUpToDate(medicalDay, logData, now);

if (!isPlayingCompletion && !isPlayingReminder && !isPlayingAlarm) {
  setIdleCharacterByLevel(currentCharacterLevel);
}

setSelfCheckBannerBySurvey(surveyV2);

    const sleepStars = computeSleepStarsFromSurvey(surveyV2);
    if (hasTodayCheckin) renderSleepStars(sleepStars.stars, sleepStars.msg);
    else renderSleepStars(0, "Your next check-in will update this score.");

    if (hasTodayCheckin) {
      $("openSurveyBtn").disabled = true;
      $("openSurveyBtn").innerHTML = `<i class="bi bi-check2-circle"></i> Check-in Finished`;
    } else {
      $("openSurveyBtn").disabled = false;
      $("openSurveyBtn").innerHTML = `<i class="bi bi-clipboard2-pulse"></i> Daily Check-in`;
    }

    const container = $("mission-container");
    container.innerHTML = "";
    activeBasicsSet = new Set();

    if (!interval) {
      // sleep time: stop mission alarm blink + stop alarm engine list
      clearMissionBlink();
      alarmEngineList = [];
      container.appendChild(createInfoCard("Sleep Time","It’s sleep time now. Take a full rest — your body is working hard for you. We’ll continue tomorrow."));
      container.appendChild(createInfoCard("Gentle Reminder","If you’re still awake, a small sip of water is enough. No pressure — rest comes first."));

      updateSensors();
      return;
    }

    const intervalId = interval.id;
    const intervalEndMs = getIntervalEndDate(now, interval).getTime();
    const nowMs = Date.now();

    const startedAt = await ensureIntervalStarted(medicalDay, intervalId, logData);

    const basicPool = buildBasicPoolForInterval(interval, medicalDay);
    const activeBasics = basicPool.filter(m => !completed.includes(toFullId(intervalId, m.id)));
    for (const m of activeBasics) if (m.id === "WATER" || m.id === "MED" || m.id === "DRESS") activeBasicsSet.add(m.id);

    const usedTitles = new Set(activeBasics.map(lowerTitle));
    const customSaved = getCustomSlot(logData, intervalId);
    const customActive = (customSaved && !completed.includes(toFullId(intervalId, customSaved.id))) ? customSaved : null;
    if (customActive) usedTitles.add(lowerTitle(customActive));

    const noMedDressThisInterval = !basicPool.some(m => m.id === "MED" || m.id === "DRESS");
    const isBeginningOfInterval = !!startedAt && (nowMs - startedAt) < (5 * 60 * 1000);
    const allowCustomAtStart = noMedDressThisInterval && isBeginningOfInterval;

    // If custom needs to be generated at interval start
    if (allowCustomAtStart && !hasCustomStored(logData, intervalId)) {
      clearMissionBlink();
      alarmEngineList = [];

      const ph = createLoadingCard("Generating custom mission...");
      if (activeBasics[0]) container.appendChild(createMissionCard(activeBasics[0], intervalId, medicalDay, false));
      container.appendChild(ph);

      try{
        const mission = await generateAndSaveCustom(medicalDay, intervalId, usedTitles);
        replaceNode(ph, createMissionCard(mission, intervalId, medicalDay, false));
        openMissionRevealModal(mission, intervalId, medicalDay);

        // ✅ show current missions (max 2), then alarm engine uses only these
        container.innerHTML = "";
        const currentMissions = [];
        if (activeBasics[0]) currentMissions.push(activeBasics[0]);
        currentMissions.push(mission);

        for (const m of currentMissions.slice(0, MAX_VISIBLE)) {
          container.appendChild(createMissionCard(m, intervalId, medicalDay, false));
        }
        if (currentMissions.slice(0, MAX_VISIBLE).length < MAX_VISIBLE) {
          container.appendChild(createInfoCard("Next Mission", "Finish this mission — BioPal will generate the next one."));
        }

        startOrUpdateAlarmEngine({ medicalDay, intervalId, missions: currentMissions.slice(0, MAX_VISIBLE) });

      } catch(e){
        console.warn("[StartCustom] failed:", e);
        replaceNode(ph, createInfoCard("Custom Mission", "Could not generate right now. Try refresh later."));
      }


      updateSensors();
      return;
    }

    // Reveal timing for custom (kept)
    const meta = getIntervalMeta(logData, intervalId);
    const basicsDoneCount = basicPool.filter(m => completed.includes(toFullId(intervalId, m.id))).length;
    const allBasicsDone = (basicsDoneCount === basicPool.length);

    const nextRevealAt = meta.nextRevealAt || 0;
    const revealPending = nextRevealAt > 0 && nowMs < nextRevealAt && nextRevealAt < intervalEndMs;
    const revealDue = nextRevealAt > 0 && nowMs >= nextRevealAt && nextRevealAt < intervalEndMs;

    // If revealDue and no custom stored -> generate it
    if (revealDue && !hasCustomStored(logData, intervalId)) {
      clearMissionBlink();
      alarmEngineList = [];

      container.innerHTML = "";
      const ph = createLoadingCard("Unlocking custom mission...");
      const firstBasic = activeBasics[0] || null;
      if (firstBasic) container.appendChild(createMissionCard(firstBasic, intervalId, medicalDay, false));
      container.appendChild(ph);

      try{
        const mission = await generateAndSaveCustom(medicalDay, intervalId, usedTitles);
        replaceNode(ph, createMissionCard(mission, intervalId, medicalDay, false));
        openMissionRevealModal(mission, intervalId, medicalDay);
        showToast({ title:"New Mission Unlocked", message:"A custom mission is ready.", key:`unlocked_${intervalId}_${Date.now()}` });

        // clear nextRevealAt
        try{
          const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
          const snap3 = await getDoc(ref);
          const d3 = snap3.exists() ? (snap3.data() || {}) : {};
          const im = d3.intervalMeta || {};
          const cur = im[intervalId] || {};
          im[intervalId] = { ...cur, nextRevealAt: 0 };
          await setDoc(ref, { intervalMeta: im, lastUpdate: serverTimestamp() }, { merge: true });
        } catch(e){
          console.warn("[Reveal] Failed to clear nextRevealAt:", e);
        }

        // ✅ show current missions (max 2) only
        container.innerHTML = "";
        const currentMissions = [];
        for (const m of activeBasics) currentMissions.push(m);
        currentMissions.push(mission);

        for (const m of currentMissions.slice(0, MAX_VISIBLE)) {
          container.appendChild(createMissionCard(m, intervalId, medicalDay, false));
        }
        if (currentMissions.slice(0, MAX_VISIBLE).length < MAX_VISIBLE) {
          container.appendChild(createInfoCard("Next Mission", "Finish this mission — BioPal will generate the next one."));
        }

        startOrUpdateAlarmEngine({ medicalDay, intervalId, missions: currentMissions.slice(0, MAX_VISIBLE) });

      } catch(e){
        console.warn("[Reveal] generation failed:", e);
        replaceNode(ph, createInfoCard("Custom Mission", "Could not generate right now. Try refresh later."));
      }


      updateSensors();
      return;
    }

    // ✅ Normal case: current active missions = basics + active custom (then display only first 2)
    const activeMissions = [];
    for (const m of activeBasics) activeMissions.push(m);
    if (customActive) activeMissions.push(customActive);

    if (activeMissions.length > 0) {
      container.innerHTML = "";

      // show only the current missions on screen (max 2)
      const currentShown = activeMissions.slice(0, MAX_VISIBLE);
      for (const m of currentShown) {
        container.appendChild(createMissionCard(m, intervalId, medicalDay, false));
      }
      if (currentShown.length < MAX_VISIBLE) {
        container.appendChild(createInfoCard("Next Mission", "Finish this mission — BioPal will generate the next one."));
      }

    await syncActiveMissionsToFirestore(medicalDay, intervalId, currentShown);
      // start the forever alarm engine using only currently shown missions
      startOrUpdateAlarmEngine({ medicalDay, intervalId, missions: currentShown });

    } else {
      // No active missions: clear blink + no alarm targets

      await syncActiveMissionsToFirestore(medicalDay, intervalId, []);
      clearMissionBlink();
      alarmEngineList = [];

      container.innerHTML = "";
      if (revealPending && !hasCustomStored(logData, intervalId) && allBasicsDone) {
        const mins = Math.max(1, Math.round((nextRevealAt - nowMs) / 60000));
        container.appendChild(createLockedCard(mins, async () => { await updateDashboard({ manualRefresh:true }); }));
        container.appendChild(createInfoCard("Almost there", "A custom mission will unlock soon. Take a short rest."));
      } else if (allBasicsDone && !customActive) {
        container.appendChild(createSuccessCard());
        container.appendChild(createInfoCard("Next Interval", "New missions will appear in the next time window."));
      } else {
        container.appendChild(createInfoCard("Keep Going", "Complete what you see here. BioPal will unlock more when it’s time."));
        container.appendChild(createInfoCard("Tip", "Small steps count. You’re doing fine."));
      }
    }

    const pct = calcIntervalPct(intervalId, basicPool, logData);

    updateSensors();

    if (opts.manualRefresh && revealPending) {
      const mins = Math.max(1, Math.round((nextRevealAt - nowMs) / 60000));
      showToast({ title:"Not Ready Yet", message:`Custom mission unlocks in ~${mins} min.`, key:`not_ready_${intervalId}` });
    }
  }

  function calcIntervalPct(intervalId, basicPool, logData){
    const completed = Array.isArray(logData?.completedMissions) ? logData.completedMissions : [];
    const basicsGiven = basicPool.length;

    const hasCustom = !!getCustomSlot(logData, intervalId);
    const meta = getIntervalMeta(logData, intervalId);
    const customPlanned = hasCustom ? 1 : (meta.nextRevealAt ? 1 : 0);

    const totalGiven = Math.max(1, basicsGiven + customPlanned);
    const doneInterval = completed.filter(x => String(x).startsWith(`${intervalId}_`)).length;

    return Math.max(0, Math.min(100, Math.round((doneInterval / totalGiven) * 100)));
  }

  /* -------------------- Finish Mission -------------------- */
  async function finishMission(fullId, medicalDay, type) {
    try {
      const now = getNow();
      const hr = now.getHours();
      const interval = getIntervalByHour(hr);
      const intervalId = interval ? interval.id : null;

      // If a mission is completed, stop blink immediately (avoid blinking completed item)
      clearMissionBlink();

      playCharacterOnce(type);

      const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
      const snap = await getDoc(ref);
      const d = snap.exists() ? (snap.data() || {}) : {};
      let list = Array.isArray(d.completedMissions) ? d.completedMissions.slice() : [];

      if (!list.includes(fullId)) {
        list.push(fullId);


        // ✅ Update character level immediately using the NEW completion list
        // so the idle GIF after the completion animation reflects the new level.
        try{
          await ensureCharacterLevelUpToDate(medicalDay, { ...(d||{}), completedMissions: list }, now);
        } catch(e){
          console.warn("[Level] ensure after completion failed:", e);
        }

        const isBasic = (type === "WATER" || type === "MED" || type === "DRESS");
        let nextRevealAt = 0;

        if (interval && intervalId && isBasic) {
          const basicPool = buildBasicPoolForInterval(interval, medicalDay);
          const allBasicsDoneAfterThis = basicPool.every(m => list.includes(`${intervalId}_${m.id}`));

          const alreadyHasCustom = hasCustomStored(d, intervalId);
          const end = getIntervalEndDate(now, interval).getTime();
          const completeAt = Date.now();
          const candidate = completeAt + REVEAL_DELAY_MS;

          const canSchedule = allBasicsDoneAfterThis && !alreadyHasCustom && (candidate < end);
          if (canSchedule) nextRevealAt = candidate;
        }

        const intervalMeta = d.intervalMeta || {};
        if (intervalId) {
          const cur = intervalMeta[intervalId] || {};
          intervalMeta[intervalId] = {
            ...cur,
            startedAt: cur.startedAt || 0,
            nextRevealAt: nextRevealAt || (cur.nextRevealAt || 0),
            lastCompletedAt: Date.now()
          };
        }

        await setDoc(ref, {
          completedMissions: list,
          intervalMeta,
          nextRevealAt: deleteField(),
          lastUpdate: serverTimestamp()
        }, { merge: true });

        // Mirror completion to calendar day doc so dashboard.html stays in sync
        const calendarDay = getCalendarDayID();
        if (calendarDay && calendarDay !== medicalDay) {
          const ref2 = doc(db, "users", userSession.uid, "daily_logs", calendarDay);
          await setDoc(ref2, {
            completedMissions: list,
            intervalMeta,
            nextRevealAt: deleteField(),
            lastUpdate: serverTimestamp()
          }, { merge: true });
        }


        // ✅ If there are NO medication/dressing missions this interval,
        // keep exactly ONE custom mission active at a time.
        // - Generate one custom at the start of the interval (handled in updateDashboard)
        // - When the custom mission is completed, immediately generate the next one.
        try{
          if (interval && intervalId) {
            const basicPoolNow = buildBasicPoolForInterval(interval, medicalDay);
            const noMedDressNow = !basicPoolNow.some(m => m.id === "MED" || m.id === "DRESS");
            const endMs = getIntervalEndDate(now, interval).getTime();
            const timeOk = (Date.now() + 15000) < endMs; // avoid generating at the very end

            if (noMedDressNow && timeOk) {
              const dAfter = { ...(d||{}), completedMissions: list, intervalMeta };
              const saved = getCustomSlot(dAfter, intervalId);
              const customIsActive = !!(saved && !list.includes(`${intervalId}_${saved.id}`));

              // If the completed mission was CUSTOM, and there is no active custom left, generate the next one.
              if (type === "CUSTOM" && !customIsActive) {
                const activeBasicsNow = basicPoolNow.filter(m => !list.includes(`${intervalId}_${m.id}`));
                const usedTitlesNow = new Set(activeBasicsNow.map(lowerTitle));
                if (saved) usedTitlesNow.add(lowerTitle(saved));

                await generateAndSaveCustom(medicalDay, intervalId, usedTitlesNow);
              }
            }
          }
        } catch(e){
          console.warn("[AutoCustomAfterComplete] failed:", e);
        }

        if (nextRevealAt) {
          const mins = Math.max(1, Math.round((nextRevealAt - Date.now()) / 60000));
          showToast({ title:"Great!", message:`Custom mission will unlock in about ${mins} min.`, key:`schedule_${intervalId}_${nextRevealAt}` });
        } else {
          showToast({ title:"Mission Complete!", message:"Nice job — keep going.", key:`done_${fullId}` });
        }

        await updateDashboard();

      }
    } catch (e) {
      console.error(e);
    }
  }

  /* -------------------- Survey Wizard Logic -------------------- */
  const updateWizard = () => {
    document.querySelectorAll('.survey-step').forEach(s => s.classList.toggle('active', Number(s.dataset.step) === currentStep));
    $("stepIndicator").textContent = `STEP ${currentStep} OF 5`;
    $("prevBtn").style.visibility = currentStep === 1 ? 'hidden' : 'visible';
    $("nextBtn").textContent = currentStep === 5 ? 'Save Check-in' : 'Next Step';
  };

  const fatigue = $("c_fatigue"), fatigueLabel = $("c_fatigueLabel");
  if (fatigue && fatigueLabel) fatigue.oninput = () => (fatigueLabel.textContent = fatigue.value);

  const anxiety = $("d_anxiety"), anxietyLabel = $("d_anxietyLabel");
  if (anxiety && anxietyLabel) anxiety.oninput = () => (anxietyLabel.textContent = anxiety.value);

  function renderWizardMedInputs(n){
    const c = $("e_medTimesContainer"); if (!c) return;
    c.innerHTML = "";
    const standard = ["09:00","14:00","21:00"];
    for(let i=1;i<=n;i++){
      const val = standard[i-1] || "09:00";
      c.innerHTML += `<div class="field-group"><label>Time ${i}</label><input type="time" class="e-med-time" value="${val}"></div>`;
    }
  }

  const eMedChanged = $("e_medChanged");
  const eMedPanel = $("e_medPanel");
  const eMedFreq = $("e_medFreq");
  if (eMedChanged && eMedPanel) {
    eMedChanged.onchange = () => {
      const show = eMedChanged.value === "yes";
      eMedPanel.classList.toggle("hidden", !show);
      if (show) renderWizardMedInputs(Number(eMedFreq?.value || 0));
    };
  }
  if (eMedFreq) eMedFreq.onchange = () => renderWizardMedInputs(Number(eMedFreq.value || 0));

  const eDressChanged = $("e_dressChanged");
  const eDressPanel = $("e_dressPanel");
  const eDressFreq = $("e_dressFreq");
  const eDressDayWrap = $("e_dressDayWrap");
  if (eDressChanged && eDressPanel) {
    eDressChanged.onchange = () => {
      const show = eDressChanged.value === "yes";
      eDressPanel.classList.toggle("hidden", !show);
      if (show) eDressDayWrap?.classList.toggle("hidden", (eDressFreq?.value || "none") !== "weekly");
    };
  }
  if (eDressFreq && eDressDayWrap) {
    eDressFreq.onchange = () => { eDressDayWrap.classList.toggle("hidden", eDressFreq.value !== "weekly"); };
  }

  $("nextBtn").onclick = async () => {
    if (currentStep < 5) { currentStep++; updateWizard(); return; }

    const medicalDay = getMedicalDayID();

    const eMedChangedVal = $("e_medChanged")?.value || "no";
    const eDressChangedVal = $("e_dressChanged")?.value || "no";

    let medUpdate = null;
    if (eMedChangedVal === "yes") {
      const n = Number($("e_medFreq")?.value || 0);
      const times = Array.from(document.querySelectorAll(".e-med-time")).map(i => i.value);
      medUpdate = { timesPerDay: n, times: times.slice(0, n) };
    }

    let dressUpdate = null;
    if (eDressChangedVal === "yes") {
      dressUpdate = {
        frequency: $("e_dressFreq")?.value || "none",
        dayOfWeek: $("e_dressDay")?.value || "mon",
        time: $("e_dressTime")?.value || "09:00"
      };
    }

    const payload = {
      survey_v2: {
        A: {
          cond: $("a_condition").value,
          pain: $("a_painLevel").value,
          painTiming: $("a_painTiming")?.value || "",
          nausea: $("a_nausea")?.value || "",
          skin: $("a_skin")?.value || ""
        },
        B: {
          hours: $("b_sleepHours").value,
          qual: $("b_sleepQuality").value,
          awakenings: $("b_awakenings")?.value || "",
          morningFatigue: $("b_morningFatigue")?.value || ""
        },
        C: {
          activityLevel: $("c_activityLevel")?.value || "",
          fatigue: $("c_fatigue").value
        },
        D: {
          mood: $("d_mood").value,
          anxiety: $("d_anxiety").value,
          hardMoment: $("d_hardMoment")?.value || "",
          note: $("d_note")?.value || "",
          gsr: $("d_gsr")?.value || ""
        },
        E: {
          medChanged: eMedChangedVal,
          dressChanged: eDressChangedVal,
          medication: medUpdate,
          dressing: dressUpdate
        }
      },
      updatedAt: serverTimestamp()
    };

    await setDoc(doc(db, "users", userSession.uid, "daily_logs", medicalDay), payload, { merge: true });

    if (medUpdate || dressUpdate) {
      const up = {};
      if (medUpdate) up["schedule.medication"] = medUpdate;
      if (dressUpdate) up["schedule.dressing"] = dressUpdate;
      if (Object.keys(up).length) await updateDoc(doc(db, "users", userSession.uid), up);
    }

    $("overlay").classList.remove("show");
    showToast({ title:"Saved!", message:"Check-in recorded.", key:"checkin_saved" });

    cachedHistory7d = await fetchHistoryDays(7).catch(()=>[]);
    setIdleCharacterByLevel(currentCharacterLevel);

    await updateDashboard();
  };

  $("prevBtn").onclick = () => { currentStep--; updateWizard(); };
  $("openSurveyBtn").onclick = () => { currentStep = 1; updateWizard(); $("overlay").classList.add("show"); };
  $("closeModalBtn").onclick = () => $("overlay").classList.remove("show");
  updateWizard();

  /* -------------------- Condition Report (kept minimal UI) -------------------- */
  let reportBusy = false;
  let reportCache = { key:"", at:0, data:null };

  function openReportModal(){
    $("reportOverlay").classList.add("show");
    $("reportOverlay").setAttribute("aria-hidden","false");
  }
  function closeReportModal(){
    $("reportOverlay").classList.remove("show");
    $("reportOverlay").setAttribute("aria-hidden","true");
  }
  function setReportLoadingUI({ title="Generating report...", sub="Analyzing last 7 days of check-ins and missions." } = {}){
    const body = $("reportBody");
    body.innerHTML = `
      <div class="report-loading">
        <div class="spinner-border" role="presentation" aria-hidden="true"></div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <div style="font-weight:950; letter-spacing:-.2px;">${title}</div>
          <div style="font-weight:800; color:var(--muted); font-size:12px;">${sub}</div>
        </div>
      </div>
      <div class="report-block" style="margin-top:14px;">
        <h6>What BioPal is checking</h6>
        <p>Self check-ins (sleep, fatigue, mood), completed missions (hydration/med/dressing/custom), and routine consistency over the last 7 days.</p>
      </div>
    `;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function renderReportUI(data){
    const body = $("reportBody");
    const d = (data && typeof data === "object") ? data : {};
    const title = escapeHtml(d.title || "BioPal Report");
    const summary = escapeHtml(d.summary || "Here is your recent condition summary.");
    const highlights = Array.isArray(d.highlights) ? d.highlights : [];
    const tips = Array.isArray(d.tips) ? d.tips : [];
    const warnings = Array.isArray(d.warnings) ? d.warnings : [];

    const listHtml = (arr, icon) => {
      const a = Array.isArray(arr) ? arr : [];
      if (!a.length) return `<p style="margin:0; color:var(--muted); font-weight:800; font-size:12px;">No items.</p>`;
      return a.map(x => `<p style="margin:0 0 8px; display:flex; gap:10px; align-items:flex-start;"><i class="bi ${icon}" style="margin-top:2px;"></i><span>${escapeHtml(x)}</span></p>`).join("");
    };

    body.innerHTML = `
      <div class="report-block">
        <h6>${title}</h6>
        <p>${summary}</p>
      </div>

      <div class="report-block">
        <h6><i class="bi bi-stars"></i> Highlights</h6>
        ${listHtml(highlights, "bi-check2-circle")}
      </div>

      <div class="report-block">
        <h6><i class="bi bi-lightbulb"></i> Tips</h6>
        ${listHtml(tips, "bi-lightbulb")}
      </div>

      <div class="report-block">
        <h6><i class="bi bi-shield-exclamation"></i> Warnings</h6>
        ${listHtml(warnings, "bi-shield-exclamation")}
      </div>
    `;
  }

  async function fetchConditionReport(force=false){
    if (!userSession) return;
    if (reportBusy) return;
    reportBusy = true;

    const medicalDay = getMedicalDayID();
    const key = `${userSession.uid}_${medicalDay}`;

    try{
      const now = Date.now();
      if (!force && reportCache.data && reportCache.key === key && (now - reportCache.at) < 60_000) {
        renderReportUI(reportCache.data);
        return;
      }

      setReportLoadingUI();

      cachedHistory7d = await fetchHistoryDays(7);
      setIdleCharacterByLevel(currentCharacterLevel);

      const payload = { profile: cachedUserProfile || {}, history: cachedHistory7d || [], medicalDay };

      const res = await fetch(API_CONDITION_REPORT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(`Report API ${res.status}: ${t}`);
      }

      const data = await res.json();
      reportCache = { key, at: Date.now(), data };
      renderReportUI(data);
    } catch(e){
      console.warn("[Report] failed:", e);
      $("reportBody").innerHTML = `<div class="report-block"><h6>Report unavailable</h6><p>Could not generate the report right now. Try again later.</p></div>`;
    } finally{
      reportBusy = false;
    }
  }

  $("closeReportBtn").onclick = closeReportModal;
  $("closeReportBtn2").onclick = closeReportModal;
  $("refreshReportBtn").onclick = () => fetchConditionReport(true);

  $("closeMissionRevealBtn").onclick = closeMissionRevealModal;
  $("closeMissionRevealBtn2").onclick = closeMissionRevealModal;

  $("selfCheckGoBtn").onclick = () => { currentStep = 1; updateWizard(); $("overlay").classList.add("show"); };
  $("selfCheckDoneBtn").onclick = () => { currentStep = 1; updateWizard(); $("overlay").classList.add("show"); };

  /* -------------------- Debug buttons -------------------- */
  $("test-skip-1h").onclick = async () => { timeOffset += 1; await updateDashboard({ debugSkip:true }); };
  $("test-skip-3h").onclick = async () => { timeOffset += 3; await updateDashboard({ debugSkip:true }); };
  $("test-reset").onclick = async () => {
    if (!userSession) return;
    const medicalDay = getMedicalDayID();
    try{
      await deleteDoc(doc(db, "users", userSession.uid, "daily_logs", medicalDay));
      showToast({ title:"Reset", message:"Today’s log cleared (debug).", key:"reset_today" });
      cachedHistory7d = await fetchHistoryDays(7);
      setIdleCharacterByLevel(currentCharacterLevel);

      await updateDashboard({ debugReset:true });
    } catch(e){
      console.warn("[Debug reset] failed:", e);
    }
  };

  /* -------------------- Auth -------------------- */
  function tickClock(){
    getNow();
    window.setTimeout(tickClock, 1000);
  }

  function startReminderLoop(){
    window.setInterval(() => {
      maybePlayReminderGif();
    }, REMINDER_EVERY_MS);
  }

/* -------------------- Character Level Loop -------------------- */
// Needed so "2 empty intervals → level down" still applies even if the user stays on the page
// and doesn't click anything. Runs lightweight checks every minute.
let levelEngineTimer = null;

async function refreshCharacterLevelOnly(){
  if (!userSession) return;
  try{
    const now = getNow();
    const medicalDay = getMedicalDayID();

    const [pSnap, lSnap] = await Promise.all([
      getDoc(doc(db, "users", userSession.uid)),
      getDoc(doc(db, "users", userSession.uid, "daily_logs", medicalDay))
    ]);

    cachedUserProfile = pSnap.exists() ? (pSnap.data() || {}) : (cachedUserProfile || {});
    const logData = lSnap.exists() ? (lSnap.data() || {}) : {};

    await ensureCharacterLevelUpToDate(medicalDay, logData, now);

    if (!isPlayingCompletion && !isPlayingReminder && !isPlayingAlarm) {
      setIdleCharacterByLevel(currentCharacterLevel);
    }
  } catch(e){
    console.warn("[Level] refreshCharacterLevelOnly failed:", e);
  }
}

function startLevelEngineLoop(){
  if (levelEngineTimer) clearInterval(levelEngineTimer);
  levelEngineTimer = setInterval(refreshCharacterLevelOnly, 60 * 1000);
}

function stopLevelEngineLoop(){
  if (levelEngineTimer) clearInterval(levelEngineTimer);
  levelEngineTimer = null;
}


  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      $("logoutBtn").disabled = true;
      $("openSurveyBtn").disabled = true;
      setCenterMessage("Please sign in to continue.");
      stopAlarmEngine();
      stopLevelEngineLoop();
      return;
    }

    userSession = user;

    await seedCharacterStatusIfMissing(user.uid);
    subscribeCharacterStatus(user.uid);
    $("logoutBtn").disabled = false;
    $("logoutBtn").onclick = async () => {
      try{
        if (typeof unsubscribeCharacterStatus === 'function') { try{ unsubscribeCharacterStatus(); }catch(e){} unsubscribeCharacterStatus=null; }
      await signOut(auth);
          stopAlarmEngine();
          stopLevelEngineLoop();
          window.location.href = "/login";
      } catch(e){
        console.warn("[Logout] failed:", e);
      }
    };

    tickClock();

    cachedHistory7d = await fetchHistoryDays(7);
    setIdleCharacterByLevel(currentCharacterLevel);

    await updateDashboard();

    // keep character level correct at interval boundaries
    await refreshCharacterLevelOnly();
    startLevelEngineLoop();

    startReminderLoop();

    startOrUpdateAlarmEngine({ medicalDay:getMedicalDayID(), intervalId:"", missions:[] });
  });
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
  const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))



const API_SENSOR_WARNING_EMAIL_URL = "/api/sensor_warning_email";

async function maybeSendSensorWarningEmail({ medicalDay, sensorStatus }) {
  // Basic validation
  if (!userSession?.uid) {
    console.warn("[Email] skipped: no userSession yet");
    return;
  }
  if (!medicalDay || !sensorStatus) return;

  // Only send when at least one is WARNING
  const anyWarning =
    sensorStatus?.temp?.status === "Warning" ||
    sensorStatus?.heart?.status === "Warning" ||
    sensorStatus?.stress?.status === "Warning";

  if (!anyWarning) return;

  // Throttle: at most once per 30 minutes per medicalDay
  const THROTTLE_MS = 30 * 60 * 1000;

  const ref = doc(db, "users", userSession.uid, "daily_logs", medicalDay);
  const snap = await getDoc(ref);
  const data = snap.exists() ? (snap.data() || {}) : {};
  const lastSent = Number(data?.sensorWarningEmailSentAtMs || 0);

//  if (Date.now() - lastSent < THROTTLE_MS) {
//    console.warn("[Email] throttled");
//    return;
//  }

  // Mark as sent FIRST (prevents double-send if user refreshes fast)
  await setDoc(ref, { sensorWarningEmailSentAtMs: Date.now() }, { merge: true });

  // Call backend to actually send email
  try {
    console.warn("[Email] sending warning email...", { medicalDay, sensorStatus });

    const res = await fetch(API_SENSOR_WARNING_EMAIL_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
    email: userSession.email,
    uid: userSession.uid,
        medicalDay,
        sensorStatus
      })
    });

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      console.warn("[Email] backend failed:", res.status, t);
      return;
    }

    console.warn("[Email] sent");
  } catch (e) {
    console.warn("[Email] fetch failed:", e);
  }
}

function waitForAllImages() {
  const images = Array.from(document.images);

  if (!images.length) return Promise.resolve();

  return Promise.all(
    images.map(img => {
      if (img.complete) return Promise.resolve();
      return new Promise(resolve => {
        img.onload = img.onerror = resolve;
      });
    })
  );
}

const MIN_LOADER_MS = 3000;

window.addEventListener("load", async () => {
  const start = Date.now();

  try {
    await waitForAllImages();
  } finally {
    const elapsed = Date.now() - start;
    const remaining = Math.max(0, MIN_LOADER_MS - elapsed);

    setTimeout(() => {
      const loader = document.getElementById("pageLoader");
      if (!loader) return;

      loader.classList.add("hidden");

      setTimeout(() => loader.remove(), 600);
    }, remaining);
  }
});

  // ---- Character state helpers (1~4) ----
function statusLabelToCharacterId(label){
  switch (label) {
    case "Happy / Energized":   return 1; // character1.gif
    case "Neutral / Calm":      return 2; // character2.gif
    case "Tired / Low Energy":  return 3; // character3.gif
    case "Concern / Warning":   return 4; // character4.gif
    default: return 2;
  }
}

async function saveCharacterStatusToFirestore({ uid, statusId, statusLabel, score, level, gif }) {
  if (!uid || typeof uid !== "string") {
    console.warn("saveCharacterStatusToFirestore: missing uid", { uid });
    return null;
  }
  try{
    // Always derive gif from level to keep level<->gif consistent
    const safeLevel = clampInt(level ?? currentCharacterLevel ?? 3, 1, 4);
    const safeGif = levelToIdleGif(safeLevel);

    const payload = {
      id: Number.isFinite(+statusId) ? +statusId : null,
      label: typeof statusLabel === "string" ? statusLabel : null,
      score: (score === null || score === undefined) ? null : +score,
      level: safeLevel,
      gif: safeGif,
      updatedAtMs: Date.now()
    };

    // 1) Store as a field on the user document (easy to inspect + reuse)
    await setDoc(doc(db, "users", uid), { characterStatus: payload }, { merge: true });

    // 2) Also mirror into a dedicated doc for any pages that prefer a standalone document
    await setDoc(doc(db, "users", uid, "meta", "characterStatus"), payload, { merge: true });

    return payload;
  }catch(err){
    console.error("saveCharacterStatusToFirestore failed:", err);
    return null;
  }
}
function syncRangeFill(el){
  const min = Number(el.min || 0);
  const max = Number(el.max || 100);
  const val = Number(el.value);
  const pct = ((val - min) / (max - min)) * 100;
  el.style.setProperty("--range-fill", `${pct}%`);
}
function saveMissionCompletion(mission) {
  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

  const history = JSON.parse(localStorage.getItem("missionHistory") || "[]");

  history.push({
    id: mission.id,
    name: mission.name,
    type: mission.type,          // Hydration / Medication / etc
    status: "completed",
    date: today,
    completedAt: Date.now()
  });

  localStorage.setItem("missionHistory", JSON.stringify(history));
}

[fatigue, anxiety].forEach(r => {
  if (!r) return;
  syncRangeFill(r);
  r.addEventListener("input", () => syncRangeFill(r));
});

const moodSelect = document.getElementById("d_mood");
const moodOtherWrap = document.getElementById("d_moodOtherWrap");
const moodOtherInput = document.getElementById("d_moodOther");

if (moodSelect) {
  moodSelect.addEventListener("change", () => {
    if (moodSelect.value === "other") {
      moodOtherWrap.classList.remove("hidden");
      moodOtherInput.required = true;
    } else {
      moodOtherWrap.classList.add("hidden");
      moodOtherInput.required = false;
      moodOtherInput.value = "";
    }
  });
}


</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
