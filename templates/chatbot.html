<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioPal • Chat Coach</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --sky:#0ea5e9; --sky2:#38bdf8; --ink:#0b1220; --bg:#f6fbff;
      --panel:rgba(255,255,255,.86);
      --border:rgba(2,6,23,.08);
      --shadow:0 12px 34px -18px rgba(2,6,23,.22);
      --muted:#64748b;

      /* missing in your snippet but used below */
      --soft: rgba(14,165,233,.08);
      --bad: #ef4444;

      --fz-title: 16.5px;
      --fz-sub: 13.5px;
      --fz-body: 15.5px;
    }

    *{ box-sizing:border-box; outline:none; }

    body{
      margin:0;
      font-family:'Plus Jakarta Sans',sans-serif;
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(56,189,248,.20), transparent 55%),
        radial-gradient(900px 520px at 85% 75%, rgba(14,165,233,.16), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #ffffff 55%, #ffffff 100%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      font-size: var(--fz-body);
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      padding-bottom: 40px;
    }

    .nav{
      position:sticky; top:16px; z-index:100;
      max-width:1200px; width: calc(100% - 24px);
      margin:16px auto;
      background:rgba(255,255,255,.70);
      backdrop-filter:blur(18px);
      border:1px solid var(--border);
      border-radius:24px;
      padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:var(--shadow);
      gap:12px;
    }
    .nav-left{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .nav-right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      padding:12px 18px;
      border-radius:14px;
      border:none;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:all .18s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-primary{
      background:linear-gradient(135deg, var(--ink), #101a33);
      color:#fff;
      box-shadow:0 14px 26px -18px rgba(2,6,23,.55);
    }
    .btn-ghost{
      background:transparent;
      color:var(--ink);
      border:1px solid rgba(2,6,23,.08);
    }
    .btn-primary:disabled, .btn-ghost:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-ghost:hover{ transform: translateY(-1px); }
    .btn-primary:hover{ transform: translateY(-1px); }

    .nav-greet{
      display:flex;
      flex-direction:column;
      line-height:1.08;
      padding:6px 2px;
      min-width: 200px;
    }
    .nav-greet .hello{
      font-weight:950;
      letter-spacing:-.35px;
      font-size:15px;
    }
    .nav-greet .sub{
      font-weight:850;
      font-size:13px;
      color:rgba(100,116,139,.95);
      margin-top:3px;
    }

    .chat-layout{
      flex:1;
      max-width: 850px;
      width: calc(100% - 24px);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      position:relative;
      min-height: 0;
    }

    .chat-window{
      flex:1;
      overflow-y:auto;
      padding: 18px 4px 10px;
      display:flex;
      flex-direction:column;
      gap: 18px;
      scroll-behavior:smooth;
      min-height: 0;
    }

    .msg-group{ display:flex; width:100%; flex-direction:column; }
    .msg-group.user{ align-items:flex-end; }
    .msg-group.ai{ align-items:flex-start; }

    .bubble{
      max-width: 82%;
      padding: 14px 18px;
      font-size: 14.5px;
      line-height: 1.55;
      font-weight: 700;
      border: 1px solid var(--border);
      box-shadow: 0 14px 30px -20px rgba(2,6,23,.10);
      white-space: pre-wrap;
    }
    .ai .bubble{
      background: var(--panel);
      color: var(--ink);
      border-radius: 4px 22px 22px 22px;
    }
    .user .bubble{
      background: var(--ink);
      color: #fff;
      border-radius: 22px 22px 4px 22px;
      border: none;
    }

    .meta{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .bubble code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .92em;
      background: rgba(2,6,23,.06);
      padding: 1px 6px;
      border-radius: 10px;
      border: 1px solid rgba(2,6,23,.07);
    }
    .bubble pre{
      margin: 10px 0 0;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(2,6,23,.05);
      border: 1px solid rgba(2,6,23,.07);
      overflow:auto;
      font-weight: 750;
    }

    .typingDots{
      display:inline-flex; gap:6px; align-items:center;
      height: 18px;
    }
    .typingDots span{
      width:6px; height:6px; border-radius:50%;
      background: rgba(2,6,23,.35);
      animation: dotPulse 1.1s infinite ease-in-out;
    }
    .typingDots span:nth-child(2){ animation-delay:.14s; }
    .typingDots span:nth-child(3){ animation-delay:.28s; }
    @keyframes dotPulse{
      0%, 80%, 100%{ transform: translateY(0); opacity:.45; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    .composer-wrap{ padding: 18px 0 6px; background: transparent; }
    .composer{
      background:#fff;
      border:1px solid rgba(14,165,233,.18);
      border-radius:24px;
      padding:8px 10px 8px 18px;
      display:flex;
      align-items:flex-end;
      gap:12px;
      box-shadow:0 20px 40px -20px rgba(2,6,23,.15);
    }
    textarea{
      flex:1;
      border:none;
      outline:none;
      padding:10px 0;
      min-height:44px;
      max-height:150px;
      resize:none;
      font-family:inherit;
      font-size:15px;
      font-weight:700;
      background:transparent;
    }

    .btn-send{
      width:44px; height:44px;
      border-radius:18px;
      background: var(--ink);
      color:#fff;
      border:none;
      display:grid;
      place-items:center;
      transition:all .2s;
      flex:0 0 auto;
    }
    .btn-send:hover{ transform: scale(1.05); background:#1a2845; }
    .btn-send:disabled{ opacity:.2; transform:none; }

    .tip-text{
      text-align:center;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      margin-top: 10px;
    }

    @media (max-width: 768px){
      .nav{ padding:12px 14px; }
      .nav-left{ min-width: unset; }
      .nav-greet{ min-width: unset; }
    }

    .nav-right .btn-ghost {
      background: var(--soft);
      color: var(--sky);
      border: 1px solid rgba(14,165,233, 0.2);
      font-weight: 700;
    }
    .nav-right .btn-ghost:hover {
      background: var(--sky);
      color: white;
      border-color: var(--sky);
      transform: translateY(-1px);
    }

    #logoutBtn {
      background: rgba(239, 68, 68, 0.08);
      color: var(--bad);
      border-color: rgba(239, 68, 68, 0.15);
    }
    #logoutBtn:hover {
      background: var(--bad);
      color: white;
    }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav-left">
      <!-- ✅ SAME STYLE AS MAIN PAGE: show username here -->
      <div class="nav-greet" id="navGreeting" aria-label="Greeting">
        <div class="hello" id="helloLine">Hi, there</div>
        <div class="sub" id="greetSub">Chat Coach</div>
      </div>
    </div>

    <div class="nav-right">
      <a href="/dashboard" class="btn btn-ghost nav-btn-dash">
        <i class="bi bi-grid-fill"></i> Dashboard
      </a>

      <a href="/chatbot" class="btn btn-ghost nav-btn-chat">
        <i class="bi bi-chat-dots-fill"></i> Chatbot
      </a>

      <a href="/profile" class="btn btn-ghost nav-btn-user" id="profileNavBtn">
        <i class="bi bi-person-circle"></i> Profile
      </a>

      <a href="{{ url_for('main') }}" class="btn btn-dark rounded-pill px-4 fw-bold me-2">BioPal App</a>

      <button id="logoutBtn" class="btn btn-ghost nav-btn-exit" disabled>
        <i class="bi bi-box-arrow-right"></i> Exit
      </button>
    </div>
  </nav>

  <div class="chat-layout">
    <div class="chat-window" id="chatBody" aria-live="polite" aria-label="Chat messages"></div>

    <div class="composer-wrap">
      <div class="composer">
        <textarea id="msgInput" placeholder="Message your BioPal Coach..." rows="1"></textarea>
        <button class="btn-send" id="sendBtn" disabled type="button" aria-label="Send">
          <i class="bi bi-arrow-up-short" style="font-size: 26px;"></i>
        </button>
      </div>
      <div class="tip-text">Answer the coach’s question to continue.</div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "{{ url_for('static', filename='js/firebase/config.js') }}";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc, collection, query, limit, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);

    const chatBody = $("chatBody");
    const msgInput = $("msgInput");
    const sendBtn = $("sendBtn");
    const logoutBtn = $("logoutBtn");

    const helloLine = $("helloLine");
    const greetSub = $("greetSub");

    const API_CHAT_URL = "/api/chat_coach";

    let userSession = null;
    let contextCache = null;
    let chatHistory = [];
    let didBootQuestion = false;

    function setNavName(nameLike){
      const raw = String(nameLike || "there").trim();
      const clean = raw.includes("@") ? raw.split("@")[0] : raw;
      helloLine.textContent = `Hi, ${clean || "there"}`;
      // keep subtitle consistent with the main-page style (short + stable)
      greetSub.textContent = "Chat Coach";
    }

    // Synchronization with Firestore document ID format (YYYY-MM-DD)
    function getMedicalDayID(){
      const now = new Date();
      const med = new Date(now);
      // dashboard logic for medical day cutover (9 AM)
      if (now.getHours() < 9) med.setDate(med.getDate() - 1);
      return med.toISOString().slice(0, 10);
    }

    function escapeHTML(str){
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function scrollToBottom(){ chatBody.scrollTop = chatBody.scrollHeight; }

    function renderTextWithCodeBlocks(text){
      const s = String(text ?? "");
      const parts = s.split(/```/g);
      if (parts.length === 1) return escapeHTML(s);
      let html = "";
      for (let i = 0; i < parts.length; i++){
        const chunk = parts[i];
        if (i % 2 === 0) html += escapeHTML(chunk);
        else {
          const lines = chunk.split("\n");
          if (lines.length > 1 && /^[a-zA-Z0-9+#._-]{1,18}$/.test(lines[0].trim())) lines.shift();
          html += `<pre><code>${escapeHTML(lines.join("\n"))}</code></pre>`;
        }
      }
      return html;
    }

    function renderTyping(){
      const wrap = document.createElement("div");
      wrap.className = "msg-group ai";
      wrap.innerHTML = `
        <div class="bubble">
          <span class="typingDots"><span></span><span></span><span></span></span>
        </div>
        <div class="meta">BioPal Coach • ${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>`;
      chatBody.appendChild(wrap);
      scrollToBottom();
      return wrap;
    }

    async function getLatestLogs(uid){
      const logCollection = "daily_logs";
      try {
        const logsRef = collection(db, "users", uid, logCollection);
        const q = query(logsRef, orderBy("__name__", "desc"), limit(7));
        const snap = await getDocs(q);
        const out = {};
        if (!snap.empty) snap.forEach(d => { out[d.id] = d.data(); });
        return { collectionName: logCollection, data: out };
      } catch(e) {
        console.error("Logs Fetch Fail:", e);
        return { collectionName: null, data: {} };
      }
    }

    async function loadBioContext(){
      if (!userSession) return null;
      try {
        const profileSnap = await getDoc(doc(db, "users", userSession.uid));
        const profile = profileSnap.exists() ? profileSnap.data() : {};
        const logs = await getLatestLogs(userSession.uid);

        contextCache = {
          nowISO: new Date().toISOString(),
          profile,
          last7Days: logs.data,
          medicalDay: getMedicalDayID(),
          logsCollection: logs.collectionName
        };

        // ✅ Update navbar left with username (same behavior as main page)
        const bestName = profile.username || profile.displayName || profile.name || userSession.displayName || userSession.email || "there";
        setNavName(bestName);

        return contextCache;
      } catch (e) {
        console.error("Context Load Fail:", e);
        return null;
      }
    }

    async function handleSend(customText = null, opts = { renderUser: true, roleOverride: null }){
      const text = (customText ?? msgInput.value).trim();
      if (!text) return;

      msgInput.disabled = true;
      sendBtn.disabled = true;

      if (customText == null) {
        if (opts.renderUser) {
          const group = document.createElement("div");
          group.className = "msg-group user";
          group.innerHTML = `
            <div class="bubble">${escapeHTML(text)}</div>
            <div class="meta">You • ${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>`;
          chatBody.appendChild(group);
        }
        chatHistory.push({ role: "user", content: text });
        msgInput.value = "";
        msgInput.style.height = "44px";
      } else {
        chatHistory.push({ role: opts.roleOverride || "system", content: text });
      }

      const typingEl = renderTyping();

      try {
        const res = await fetch(API_CHAT_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            message: text,
            context: contextCache || {},
            history: chatHistory.slice(-10)
          })
        });
        const out = await res.json();
        typingEl.querySelector(".bubble").innerHTML = renderTextWithCodeBlocks(out.reply);
        chatHistory.push({ role: "assistant", content: out.reply });
      } catch(err) {
        typingEl.querySelector(".bubble").textContent = "Connection error. Please try again.";
      } finally {
        msgInput.disabled = false;
        sendBtn.disabled = !msgInput.value.trim();
        msgInput.focus();
        scrollToBottom();
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "/login"; return; }
      userSession = user;

      // ✅ Show a quick name immediately (then overwritten by profile.username if exists)
      setNavName(user.displayName || user.email || "there");

      // Enable logout once signed in
      logoutBtn.disabled = false;

      // Load context + overwrite greeting with profile username
      const context = await loadBioContext();

      if (!didBootQuestion && context && context.last7Days) {
        didBootQuestion = true;

        const todayData = context.last7Days[context.medicalDay] || {};
        const survey = todayData.survey_v2 || {};
        const selfStatus = todayData.selfStatus || {};

        const physicalCond = survey.A?.cond || "not reported";
        const mood = survey.D?.mood || "not reported";
        const pain = survey.A?.pain || "none";
        const score = selfStatus.score || "unknown";
        const label = selfStatus.label || "neutral";

        const dataPrompt =
          `The user has checked in for today (${context.medicalDay}). ` +
          `Physical condition: ${physicalCond}. Mood: ${mood}. ` +
          `Pain: ${pain}. Self-status score: ${score} (${label}). ` +
          `Greet them warmly acknowledging these specific feelings.`;

        handleSend(dataPrompt, { renderUser: false, roleOverride: "system" });
      }
    });

    sendBtn.addEventListener("click", () => handleSend());

    msgInput.addEventListener("input", function(){
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 150) + "px";
      sendBtn.disabled = !this.value.trim();
    });

    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey && !sendBtn.disabled){
        e.preventDefault();
        handleSend();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/login";
    });
  </script>
</body>
</html>
