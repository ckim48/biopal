<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioPal • Chat Coach</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/apple-touch-icon.png">

  <style>
    :root{
      --sky:#0ea5e9; --ink:#0b1220; --bg:#f6fbff;
      --panel:rgba(255,255,255,.86);
      --border:rgba(2,6,23,.08);
      --shadow:0 12px 34px -18px rgba(2,6,23,.22);
      --muted:#64748b;

      --soft: rgba(14,165,233,.08);
      --bad: #ef4444;

      --fz-body: 15.5px;

      --buddy-w: 220px;
      --gap: 22px;

      /* Center column width (messages + input) */
      --chat-max: 720px;

      /* Safe area for fixed composer */
      --composer-h: 98px;
    }

    *{ box-sizing:border-box; outline:none; }

    body{
      margin:0;
      font-family:'Plus Jakarta Sans',sans-serif;
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(56,189,248,.20), transparent 55%),
        radial-gradient(900px 520px at 85% 75%, rgba(14,165,233,.16), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #ffffff 55%, #ffffff 100%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      font-size: var(--fz-body);
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      padding-bottom: 40px;
    }

    .nav{
      position:sticky; top:16px; z-index:100;
      max-width:1200px; width: calc(100% - 24px);
      margin:16px auto;
      background:rgba(255,255,255,.70);
      backdrop-filter:blur(18px);
      border:1px solid var(--border);
      border-radius:24px;
      padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:var(--shadow);
      gap:12px;
    }
    .nav-left{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .nav-right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      padding:12px 18px;
      border-radius:14px;
      border:none;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:all .18s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-ghost{
      background:transparent;
      color:var(--ink);
      border:1px solid rgba(2,6,23,.08);
    }
    .btn-ghost:hover{ transform: translateY(-1px); }
    .btn-primary:disabled, .btn-ghost:disabled{ opacity:.55; cursor:not-allowed; }

    .nav-greet{
      display:flex;
      flex-direction:column;
      line-height:1.08;
      padding:6px 2px;
      min-width: 200px;
    }
    .nav-greet .hello{
      font-weight:950;
      letter-spacing:-.35px;
      font-size:15px;
    }
    .nav-greet .sub{
      font-weight:850;
      font-size:13px;
      color:rgba(100,116,139,.95);
      margin-top:3px;
    }

    /* Layout */
    .page-grid{
      flex:1;
      max-width: 1200px;
      width: calc(100% - 24px);
      margin: 0 auto;
      display:grid;
      grid-template-columns: var(--buddy-w) minmax(0, 1fr);
      gap: var(--gap);
      align-items:start;
      min-height: 0;
    }

    .buddy-rail{
      position: sticky;
      top: 110px;
      height: calc(100vh - 140px);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding-top: 8px;
      pointer-events: none;
    }

    .buddy-card{
      width: 100%;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(2,6,23,.08);
      border-radius: 22px;
      box-shadow: 0 18px 36px -24px rgba(2,6,23,.25);
      backdrop-filter: blur(16px);
      padding: 12px;
      pointer-events: auto;
      position: relative;
      overflow: hidden;
    }

    .buddy-card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(220px 140px at 20% 15%, rgba(56,189,248,.25), transparent 55%),
        radial-gradient(220px 160px at 80% 75%, rgba(14,165,233,.18), transparent 60%);
      z-index:0;
      pointer-events:none;
    }

    .buddy-inner{
      position: relative;
      z-index: 1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
    }

    .buddy-gif{
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(2,6,23,.08);
      background: rgba(255,255,255,.9);
      box-shadow: 0 16px 30px -24px rgba(2,6,23,.25);
      overflow:hidden;
    }

    .buddy-gif img{ width: 100%; height: auto; display:block; }

    .buddy-caption{
      width: 100%;
      text-align:center;
      font-size: 12px;
      font-weight: 850;
      color: rgba(100,116,139,.95);
      line-height: 1.25;
    }

    /* Chat column */
    .chat-layout{
      min-width: 0;
      display:flex;
      flex-direction:column;
      position:relative;
      min-height: 0;
      width: 100%;
      margin: 0 auto;
    }

    /* NEW: Center the whole chat stream (AI + user) and make it narrower */
    .chat-window{
      flex:1;
      overflow-y:auto;
      padding: 18px 0 calc(var(--composer-h) + 18px);
      display:flex;
      flex-direction:column;
      gap: 18px;
      scroll-behavior:smooth;
      min-height: 0;
      width: 100%;
      align-items:center; /* center message blocks */
    }

    /* message groups become centered blocks with fixed max width */
    .msg-group{
      width: min(var(--chat-max), 100%);
      display:flex;
      flex-direction:column;
    }
    .msg-group.user{ align-items:flex-end; }
    .msg-group.ai{ align-items:flex-start; }

    /* bubbles become shorter width too */
    .bubble{
      max-width: 86%;
      padding: 14px 18px;
      font-size: 14.5px;
      line-height: 1.55;
      font-weight: 700;
      border: 1px solid var(--border);
      box-shadow: 0 14px 30px -20px rgba(2,6,23,.10);
      white-space: pre-wrap;
    }
    .ai .bubble{
      background: var(--panel);
      color: var(--ink);
      border-radius: 4px 22px 22px 22px;
    }
    .user .bubble{
      background: var(--ink);
      color: #fff;
      border-radius: 22px 22px 4px 22px;
      border: none;
    }

    .meta{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .bubble code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .92em;
      background: rgba(2,6,23,.06);
      padding: 1px 6px;
      border-radius: 10px;
      border: 1px solid rgba(2,6,23,.07);
    }
    .bubble pre{
      margin: 10px 0 0;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(2,6,23,.05);
      border: 1px solid rgba(2,6,23,.07);
      overflow:auto;
      font-weight: 750;
    }

    .typingDots{
      display:inline-flex; gap:6px; align-items:center;
      height: 18px;
    }
    .typingDots span{
      width:6px; height:6px; border-radius:50%;
      background: rgba(2,6,23,.35);
      animation: dotPulse 1.1s infinite ease-in-out;
    }
    .typingDots span:nth-child(2){ animation-delay:.14s; }
    .typingDots span:nth-child(3){ animation-delay:.28s; }
    @keyframes dotPulse{
      0%, 80%, 100%{ transform: translateY(0); opacity:.45; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    /* Fixed composer like ChatGPT */
    .composer-wrap{
      position: fixed;
      left: 0; right: 0; bottom: 18px;
      z-index: 120;
      display:flex;
      justify-content:center;
      pointer-events:none;
      padding: 0 12px;
    }
    .composer-wrap .composer-shell{
      width: 100%;
      max-width: var(--chat-max); /* SAME center width as messages */
      pointer-events:auto;
    }

    /* NEW: subtle bottom fade behind composer (like ChatGPT) */
    .composer-wrap:before{
      content:"";
      position: absolute;
      left:0; right:0;
      bottom:0;
      height: 120px;
      background: linear-gradient(180deg, rgba(246,251,255,0) 0%, rgba(246,251,255,.72) 50%, rgba(246,251,255,.96) 100%);
      pointer-events:none;
      z-index: -1;
    }

    .composer{
      background:#fff;
      border:1px solid rgba(14,165,233,.18);
      border-radius:24px;
      padding:8px 10px 8px 18px;
      display:flex;
      align-items:flex-end;
      gap:12px;
      box-shadow:0 20px 40px -20px rgba(2,6,23,.15);
    }
    textarea{
      flex:1;
      border:none;
      outline:none;
      padding:10px 0;
      min-height:44px;
      max-height:150px;
      resize:none;
      font-family:inherit;
      font-size:15px;
      font-weight:700;
      background:transparent;
    }

    .btn-send{
      width:44px; height:44px;
      border-radius:18px;
      background: var(--ink);
      color:#fff;
      border:none;
      display:grid;
      place-items:center;
      transition:all .2s;
      flex:0 0 auto;
    }
    .btn-send:hover{ transform: scale(1.05); background:#1a2845; }
    .btn-send:disabled{ opacity:.2; transform:none; }

    .tip-text{
      text-align:center;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      margin-top: 10px;
    }

    @media (max-width: 992px){
      .page-grid{ grid-template-columns: 1fr; }
      .buddy-rail{ display:none; }
      :root{ --chat-max: 720px; }
    }

    .nav-right .btn-ghost {
      background: var(--soft);
      color: var(--sky);
      border: 1px solid rgba(14,165,233, 0.2);
      font-weight: 700;
    }
    .nav-right .btn-ghost:hover {
      background: var(--sky);
      color: white;
      border-color: var(--sky);
      transform: translateY(-1px);
    }

    #logoutBtn {
      background: rgba(239, 68, 68, 0.08);
      color: var(--bad);
      border-color: rgba(239, 68, 68, 0.15);
    }
    #logoutBtn:hover {
      background: var(--bad);
      color: white;
    }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav-left">
      <div class="nav-greet" id="navGreeting" aria-label="Greeting">
        <div class="hello" id="helloLine">Hi, there</div>
        <div class="sub" id="greetSub">Weekly Missions</div>
      </div>
    </div>

    <div class="nav-right" style="display: flex; align-items: center; gap: 8px;">
      <a href="/dashboard" class="btn btn-ghost" id="refreshBtn">
        <i class="bi bi-grid-fill"></i> Dashboard
      </a>

      <a href="/chatbot" class="btn btn-ghost">
        <i class="bi bi-chat-dots-fill"></i> Chatbot
      </a>

      <a href="/resource" class="btn btn-ghost">
        <i class="bi bi-journal-text"></i> Resources
      </a>

      <a href="{{ url_for('main') }}" class="btn btn-ghost">
        <i class="bi bi-hearts"></i> BioPal App
      </a>

      <div class="dropdown">
        <button
          class="btn btn-ghost settings-btn"
          type="button"
          id="settingsMenuBtn"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          aria-label="Settings menu"
          title="Settings"
          style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; padding: 0; border-radius: 12px;"
        >
          <i class="bi bi-gear-fill" style="font-size: 1.1rem;"></i>
        </button>

        <ul class="dropdown-menu dropdown-menu-end menu" aria-labelledby="settingsMenuBtn"
            style="min-width:240px; border-radius:18px; border:1px solid rgba(2,6,23,.10); box-shadow:var(--shadow-xl); overflow:hidden; margin-top: 10px;">

          <li class="dropdown-header"
              style="font-weight:950; letter-spacing:-.2px; padding:12px 14px; color:var(--ink);
                     background:rgba(248,250,252,.95); border-bottom:1px solid rgba(2,6,23,.08);">
            Account
          </li>

          <li>
            <a class="dropdown-item" href="/profile"
               style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
              <i class="bi bi-person-circle" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
              Profile
            </a>
          </li>

          <li id="menuLoginItem" style="display:none;">
            <a class="dropdown-item" href="/login"
               style="padding:10px 14px; font-weight:800; display:flex; align-items:center; gap:10px;">
              <i class="bi bi-box-arrow-in-right" style="width:22px; font-size:1.05rem; color:rgba(15,23,42,.85);"></i>
              Login
            </a>
          </li>

          <li><hr class="dropdown-divider" style="margin:0; border-top-color:rgba(2,6,23,.08);"></li>

          <li id="menuLogoutItem">
            <button class="dropdown-item danger" id="logoutBtn"
                    style="padding:10px 14px; font-weight:900; display:flex; align-items:center; gap:10px;
                           color:var(--bad); background:transparent; border:0; width:100%; text-align:left;">
              <i class="bi bi-box-arrow-right" style="width:22px; font-size:1.05rem; color:var(--bad);"></i>
              Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="page-grid">
    <aside class="buddy-rail" aria-label="Cute buddy">
      <div class="buddy-card">
        <div class="buddy-inner">
          <div class="buddy-gif">
            <img id="buddyGif" src="../static/gifs/character1.gif" alt="BioPal buddy" loading="lazy" />
          </div>
          <div class="buddy-caption" id="buddyCaption">Your BioPal buddy is here.</div>
        </div>
      </div>
    </aside>

    <main class="chat-layout">
      <div class="chat-window" id="chatBody" aria-live="polite" aria-label="Chat messages"></div>
    </main>
  </div>

  <div class="composer-wrap" id="composerWrap">
    <div class="composer-shell">
      <div class="composer" id="composer">
        <textarea id="msgInput" placeholder="Message your BioPal Coach..." rows="1"></textarea>
        <button class="btn-send" id="sendBtn" disabled type="button" aria-label="Send">
          <i class="bi bi-arrow-up-short" style="font-size: 26px;"></i>
        </button>
      </div>
      <div class="tip-text">Answer the coach’s question to continue.</div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "{{ url_for('static', filename='js/firebase/config.js') }}";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc, collection, query, limit, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);

    const chatBody = $("chatBody");
    const msgInput = $("msgInput");
    const sendBtn = $("sendBtn");
    const logoutBtn = $("logoutBtn");

    const helloLine = $("helloLine");
    const greetSub = $("greetSub");

    const buddyCaption = $("buddyCaption");
    const composerWrap = $("composerWrap");

    const API_CHAT_URL = "/api/chat_coach";

    let userSession = null;
    let contextCache = null;
    let chatHistory = [];
    let didBootQuestion = false;

    /* ===== NEW: scroll logic that respects user scrolling ===== */
    let stickToBottom = true;
    function isNearBottom(el, threshold = 90){
      return (el.scrollHeight - el.scrollTop - el.clientHeight) < threshold;
    }
    function updateStickiness(){
      stickToBottom = isNearBottom(chatBody);
    }
    chatBody.addEventListener("scroll", () => {
      stickToBottom = isNearBottom(chatBody);
    }, { passive:true });

    function scrollToBottom(force = false){
      if (force || stickToBottom){
        chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
      }
    }

    function setNavName(nameLike){
      const raw = String(nameLike || "there").trim();
      const clean = raw.includes("@") ? raw.split("@")[0] : raw;
      helloLine.textContent = `Hi, ${clean || "there"}`;
      greetSub.textContent = "Chat Coach";
    }

    function getMedicalDayID(){
      const now = new Date();
      const med = new Date(now);
      if (now.getHours() < 9) med.setDate(med.getDate() - 1);
      return med.toISOString().slice(0, 10);
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderTextWithCodeBlocks(text){
      const s = String(text ?? "");
      const parts = s.split(/```/g);
      if (parts.length === 1) return escapeHTML(s);
      let html = "";
      for (let i = 0; i < parts.length; i++){
        const chunk = parts[i];
        if (i % 2 === 0) html += escapeHTML(chunk);
        else{
          const lines = chunk.split("\n");
          if (lines.length > 1 && /^[a-zA-Z0-9+#._-]{1,18}$/.test(lines[0].trim())) lines.shift();
          html += `<pre><code>${escapeHTML(lines.join("\n"))}</code></pre>`;
        }
      }
      return html;
    }

    function renderTyping(){
      const wrap = document.createElement("div");
      wrap.className = "msg-group ai";
      wrap.innerHTML = `
        <div class="bubble">
          <span class="typingDots"><span></span><span></span><span></span></span>
        </div>
        <div class="meta">BioPal Coach • ${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>`;
      chatBody.appendChild(wrap);

      // NEW: auto scroll when typing appears
      scrollToBottom();
      return wrap;
    }

    function syncComposerSpace(){
      if (!composerWrap) return;
      const h = composerWrap.getBoundingClientRect().height || 98;
      document.documentElement.style.setProperty("--composer-h", `${Math.ceil(h)}px`);

      // keep bottom anchoring correct after height changes
      scrollToBottom();
    }
    window.addEventListener("resize", syncComposerSpace);
    window.addEventListener("load", () => {
      syncComposerSpace();
      updateStickiness();
    });

    async function getLatestLogs(uid){
      const logCollection = "daily_logs";
      try{
        const logsRef = collection(db, "users", uid, logCollection);
        const q = query(logsRef, orderBy("__name__", "desc"), limit(7));
        const snap = await getDocs(q);
        const out = {};
        if (!snap.empty) snap.forEach(d => { out[d.id] = d.data(); });
        return { collectionName: logCollection, data: out };
      }catch(e){
        console.error("Logs Fetch Fail:", e);
        return { collectionName: null, data: {} };
      }
    }

    async function loadBioContext(){
      if (!userSession) return null;
      try{
        const profileSnap = await getDoc(doc(db, "users", userSession.uid));
        const profile = profileSnap.exists() ? profileSnap.data() : {};
        const logs = await getLatestLogs(userSession.uid);

        contextCache = {
          nowISO: new Date().toISOString(),
          profile,
          last7Days: logs.data,
          medicalDay: getMedicalDayID(),
          logsCollection: logs.collectionName
        };

        const bestName =
          profile.username ||
          profile.displayName ||
          profile.name ||
          userSession.displayName ||
          userSession.email ||
          "there";

        setNavName(bestName);

        if (buddyCaption){
          const clean = String(bestName || "there").includes("@") ? String(bestName).split("@")[0] : String(bestName);
          buddyCaption.innerHTML = `${escapeHTML(clean)}’s buddy is here.`;
        }

        return contextCache;
      }catch(e){
        console.error("Context Load Fail:", e);
        return null;
      }
    }

    async function handleSend(customText = null, opts = { renderUser: true, roleOverride: null }){
      const text = (customText ?? msgInput.value).trim();
      if (!text) return;

      // capture whether user was already at bottom before we append
      updateStickiness();

      msgInput.disabled = true;
      sendBtn.disabled = true;

      if (customText == null){
        if (opts.renderUser){
          const group = document.createElement("div");
          group.className = "msg-group user";
          group.innerHTML = `
            <div class="bubble">${escapeHTML(text)}</div>
            <div class="meta">You • ${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>`;
          chatBody.appendChild(group);
          scrollToBottom(); // NEW: scroll after user sends
        }
        chatHistory.push({ role: "user", content: text });
        msgInput.value = "";
        msgInput.style.height = "44px";
        syncComposerSpace();
      }else{
        chatHistory.push({ role: opts.roleOverride || "system", content: text });
      }

      const typingEl = renderTyping();

      try{
        const res = await fetch(API_CHAT_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            message: text,
            context: contextCache || {},
            history: chatHistory.slice(-10)
          })
        });
        const out = await res.json();

        typingEl.querySelector(".bubble").innerHTML = renderTextWithCodeBlocks(out.reply);
        chatHistory.push({ role: "assistant", content: out.reply });

        // NEW: auto scroll when AI response arrives
        scrollToBottom(true);
      }catch(err){
        typingEl.querySelector(".bubble").textContent = "Connection error. Please try again.";
        scrollToBottom(true);
      }finally{
        msgInput.disabled = false;
        sendBtn.disabled = !msgInput.value.trim();
        msgInput.focus();
        syncComposerSpace();
      }
    }

    function summarizeMissions(todayData, profile){
      const completed = Array.isArray(todayData?.completedMissions) ? todayData.completedMissions : [];
      const doneTotal = completed.length;

      let expWater = 4;
      let expMed = 0;
      let expDress = 0;
      let expCustom = 0;

      const sched = (profile && typeof profile === "object") ? (profile.schedule || {}) : {};
      const med = (sched && typeof sched === "object") ? (sched.medication || {}) : {};
      const dress = (sched && typeof sched === "object") ? (sched.dressing || {}) : {};

      const medTimes = Array.isArray(med.times) ? med.times.filter(Boolean) : [];
      expMed = Math.min(8, medTimes.length);

      const freq = String(dress.frequency || "").trim().toLowerCase();
      if (freq === "daily") expDress = 1;
      else if (freq === "weekly"){
        const dow = String(dress.dayOfWeek || "").trim().toLowerCase();
        const date = (contextCache?.medicalDay) ? new Date(contextCache.medicalDay + "T12:00:00") : new Date();
        const map = ["sun","mon","tue","wed","thu","fri","sat"];
        const todayDow = map[date.getDay()];
        if (dow && dow === todayDow) expDress = 1;
      }

      if (todayData && typeof todayData === "object" && todayData.customMissions && typeof todayData.customMissions === "object"){
        expCustom = 4;
      }

      const expTotal = expWater + expMed + expDress + expCustom;
      const pct = expTotal > 0 ? Math.round((doneTotal / expTotal) * 100) : null;

      return { doneTotal, expTotal, pct };
    }

    function buildMockLast7DaysAlmostNoneDone(medicalDay){
      const mk = (iso, doneCount) => ({
        survey_v2: {
          A: { cond: "tired", pain: "mild" },
          C: { fatigue: 7 },
          D: { mood: "a bit low" },
        },
        selfStatus: { score: 45, label: "low" },
        completedMissions: Array.from({ length: doneCount }, (_, i) => `mock_done_${i+1}`),
        customMissions: { enabled: true }
      });

      const ids = [];
      const base = new Date(medicalDay + "T12:00:00");
      for (let i = 0; i < 7; i++){
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        ids.push(d.toISOString().slice(0,10));
      }

      const out = {};
      out[ids[0]] = mk(ids[0], 0);
      out[ids[1]] = mk(ids[1], 1);
      out[ids[2]] = mk(ids[2], 0);
      out[ids[3]] = mk(ids[3], 1);
      out[ids[4]] = mk(ids[4], 0);
      out[ids[5]] = mk(ids[5], 0);
      out[ids[6]] = mk(ids[6], 1);
      return out;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user){ window.location.href = "/login"; return; }
      userSession = user;

      setNavName(user.displayName || user.email || "there");
      logoutBtn.disabled = false;

      const context = await loadBioContext();

      if (!didBootQuestion && context && context.last7Days){
        didBootQuestion = true;

        let todayData = context.last7Days[context.medicalDay] || {};
        let last7Days = context.last7Days;

        const hasAnySignals =
          (todayData && typeof todayData === "object") &&
          (todayData.survey_v2 || todayData.selfStatus || Array.isArray(todayData.completedMissions));

        if (!hasAnySignals){
          last7Days = buildMockLast7DaysAlmostNoneDone(context.medicalDay);
          todayData = last7Days[context.medicalDay] || {};
          contextCache.last7Days = last7Days;
        }

        const survey = todayData.survey_v2 || {};
        const selfStatus = todayData.selfStatus || {};

        const physicalCond = survey.A?.cond || "not reported";
        const mood = survey.D?.mood || "not reported";
        const pain = survey.A?.pain || "none";
        const fatigue = survey.C?.fatigue ?? "unknown";
        const score = selfStatus.score || "unknown";
        const label = selfStatus.label || "neutral";

        const m = summarizeMissions(todayData, context.profile);
        const missionLine =
          (m.expTotal > 0)
            ? `Mission progress: ${m.doneTotal}/${m.expTotal} completed (${m.pct ?? 0}%).`
            : `Mission progress: ${m.doneTotal} completed.`;

        const dataPrompt =
          `Today is ${context.medicalDay}. ` +
          `Check-in: condition=${physicalCond}, mood=${mood}, pain=${pain}, fatigue=${fatigue}/10. ` +
          `Self-status score=${score} (${label}). ` +
          `${missionLine} ` +
          `Greet them warmly and mention BOTH check-in + mission progress briefly (no guilt). ` +
          `Ask ONE gentle question about what feels doable next. Keep it about 3 lines.`;

        // Force scroll to bottom for the first boot message
        handleSend(dataPrompt, { renderUser: false, roleOverride: "system" });
        setTimeout(() => scrollToBottom(true), 250);
      }

      syncComposerSpace();
      setTimeout(() => scrollToBottom(true), 250);
    });

    sendBtn.addEventListener("click", () => handleSend());

    msgInput.addEventListener("input", function(){
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 150) + "px";
      sendBtn.disabled = !this.value.trim();
      syncComposerSpace();
    });

    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey && !sendBtn.disabled){
        e.preventDefault();
        handleSend();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/login";
    });

    setTimeout(syncComposerSpace, 300);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
